<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Tool Pro v3.1 - Évaluation des Capacités Export</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
    background: white;
    color: #228B22;
    padding: 15px 20px;
    text-align: center;
    border-bottom: 1px solid #e0e0e0;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: auto;
}

.header-help {
    position: absolute;
    right: 30px;
    top: 50%;
    transform: translateY(-50%);
}

        .header-logo {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: auto;
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            color: #228B22;
            font-weight: bold;
        }

        .header p {
            font-size: 1em;
            color: #2E8B57;
            font-weight: 500;
            margin: 0;
        }

        .navigation {
            display: flex;
            justify-content: flex-start;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            border-radius: 0;
            padding: 0;
            overflow-x: auto;
        }

        .nav-btn {
            padding: 8px 15px;
            background: white;
            color: #666;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            border-radius: 0;
            border-bottom: 2px solid transparent;
            margin-right: 0;
            position: relative;
            white-space: nowrap;
            min-width: 150px;
            text-align: center;
        }

        .nav-btn:hover {
            background: #e9ecef;
            color: #333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .nav-btn.active {
            background: #2e7d32;
            color: white;
            border-bottom: 3px solid #1b5e20;
            transform: none;
            box-shadow: none;
            z-index: 10;
        }

        .nav-btn.reset-btn {
            background: linear-gradient(135deg, #ea4335, #ff6b6b);
            color: white;
            margin-left: auto;
            margin-right: 0;
            border-color: #ea4335;
        }

        .nav-btn:hover {
            background: #e9ecef;
            color: #333;
            transform: none;
            box-shadow: none;
            border-bottom: 3px solid #ddd;
        }

        .nav-btn.loading {
            pointer-events: none;
            opacity: 0.7;
            background: linear-gradient(135deg, #ff9900, #ffb74d);
            color: white;
            border-color: #ff9900;
        }

        /* Barre de chargement */
        .loading-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading-container.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        .loading-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 20px;
        }

        .loading-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .loading-bar-container {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #1a73e8, #4285f4, #34a853, #ff9900);
            background-size: 300% 100%;
            border-radius: 6px;
            width: 0%;
            transition: width 0.3s ease;
            animation: gradientShift 2s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loading-percentage {
            font-size: 1.5em;
            font-weight: bold;
            color: #1a73e8;
            margin-top: 15px;
        }

        .loading-steps {
            text-align: left;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .loading-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .loading-step.completed {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .loading-step.active {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1a73e8;
        }

        .loading-step-icon {
            margin-right: 12px;
            font-size: 1.2em;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            border-top-color: #1a73e8;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .content {
            padding: 20px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #34a853, #4caf50);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 168, 83, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2e7d32, #388e3c);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
        }

        .question-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #1a73e8;
        }

        .question-title {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .score-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .score-btn {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9em;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .score-btn:hover {
            border-color: #2e7d32;
            background: #f0f8f0;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .score-btn.selected {
            background: #2e7d32;
            color: white;
            border-color: #2e7d32;
            box-shadow: 0 2px 6px rgba(46, 125, 50, 0.2);
        }

        .dimension-header {
            background: linear-gradient(135deg, #ff9900, #ff6d01);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 20px 0 15px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .progress-container {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #34a853, #4caf50);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #666;
        }

        .results-header {
            text-align: left;
            padding: 15px 20px;
            background: linear-gradient(135deg, #34a853, #4caf50);
            color: white;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .score-display {
            font-size: 2.2em;
            font-weight: bold;
            margin: 0;
        }

        .dimension-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .dimension-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 5px solid #1a73e8;
        }

        .dimension-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .dimension-score {
            font-size: 2em;
            font-weight: bold;
            color: #1a73e8;
        }

        .dimension-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .dimension-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid;
        }

        .alert-success {
            background: #e8f5e8;
            border-color: #34a853;
            color: #2e7d32;
        }

        .alert-warning {
            background: #fff3e0;
            border-color: #ff9900;
            color: #ef6c00;
        }

        .alert-error {
            background: #ffebee;
            border-color: #ea4335;
            color: #c62828;
        }

        .history-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #1a73e8;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .detailed-diagnosis {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .diagnosis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .multi-select {
            position: relative;
            width: 100%;
        }

        .multi-select-display {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .multi-select-display:focus,
        .multi-select-display.active {
            border-color: #228B22;
            box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.1);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #228B22;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .multi-select-dropdown.active {
            display: block;
        }

        .multi-select-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-select-option:hover {
            background: #f0f8f0;
        }

        .multi-select-option input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .selected-countries {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-width: calc(100% - 30px);
        }

        .country-tag {
            background: #228B22;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .country-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .dropdown-arrow {
            transition: transform 0.3s ease;
        }

        .dropdown-arrow.rotated {
            transform: rotate(180deg);
        }

        .diagnosis-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .header-logo {
                position: static;
                transform: none;
                margin-bottom: 15px;
                align-self: center;
            }
            
            .header-logo img {
                width: 100px !important;
                max-height: 50px !important;
            }

.header-help {
    position: static;
    transform: none;
    margin-top: 15px;
    align-self: center;
}

.header-help button {
    padding: 10px 15px !important;
    font-size: 12px !important;
}            

            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                overflow-x: auto;
                scrollbar-width: thin;
                scrollbar-color: #1a73e8 #f8f9fa;
            }
            
            .navigation::-webkit-scrollbar {
                height: 4px;
            }
            
            .navigation::-webkit-scrollbar-track {
                background: #f8f9fa;
            }
            
            .navigation::-webkit-scrollbar-thumb {
                background: #1a73e8;
                border-radius: 2px;
            }
            
            .nav-btn {
                min-width: 140px;
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .nav-btn.reset-btn {
                margin-left: 10px;
            }
            
            .score-buttons {
                justify-content: center;
            }
            
            .dimension-scores {
                grid-template-columns: 1fr;
            }
            
            .loading-steps {
                padding: 15px;
            }
            
            .loading-step {
                font-size: 14px;
                padding: 6px;
            }
            
            .diagnosis-grid {
                grid-template-columns: 1fr !important;
            }
        }
/* Page d'authentification */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2e7d32, #388e3c);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 400px;
            max-width: 90%;
            text-align: center;
        }

        .auth-title {
            font-size: 2em;
            color: #2e7d32;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .auth-form {
            text-align: left;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2e7d32, #388e3c);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
        }

        .auth-error {
            color: #ea4335;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
.auth-loading {
            display: none;
            margin-top: 20px;
        }

        .auth-loading.show {
            display: block;
        }

        .auth-loading-text {
            color: #2e7d32;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .auth-progress-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .auth-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2e7d32, #4caf50);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 4px;
        }

        .auth-percentage {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #2e7d32;
        }
/* Styles pour l'aide */
.help-btn:hover {
    background: linear-gradient(135deg, #1565c0, #1976d2) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(21, 101, 192, 0.3);
}

.help-modal {
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
}

.help-modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 15px;
    width: 80%;
    max-width: 800px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.help-header {
    background: linear-gradient(135deg, #1a73e8, #4285f4);
    color: white;
    padding: 20px 30px;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.help-header h2 {
    margin: 0;
    font-size: 1.5em;
}

.help-close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 50%;
    transition: background 0.3s;
}

.help-close:hover {
    background: rgba(255,255,255,0.2);
}

.help-menu {
    padding: 30px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.help-menu-item {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 5px solid #1a73e8;
}

.help-menu-item:hover {
    background: #e3f2fd;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(26, 115, 232, 0.15);
}

.help-menu-item h3 {
    margin: 0 0 10px 0;
    color: #1a73e8;
    font-size: 1.2em;
}

.help-menu-item p {
    margin: 0;
    color: #666;
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .help-modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .help-menu {
        grid-template-columns: 1fr;
        padding: 20px;
    }
    
    .help-header {
        padding: 15px 20px;
    }
    
    .help-header h2 {
        font-size: 1.2em;
    }
}

/* Onglets secondaires pour navigation interne */
        .secondary-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            margin: -20px -20px 20px -20px;
            padding: 0 20px;
            display: flex;
            gap: 0;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .secondary-nav-btn {
            padding: 8px 12px;
            background: transparent;
            color: #666;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            min-width: auto;
        }

        .secondary-nav-btn:hover {
            color: #2e7d32;
            border-bottom: 2px solid #2e7d32;
        }

        .secondary-nav-btn.active {
            color: #2e7d32;
            border-bottom: 2px solid #2e7d32;
            font-weight: 600;
        }

        .anchor-section {
            scroll-margin-top: 100px;
            margin-bottom: 30px;
        }

        .anchor-title {
            border-left: 4px solid #2e7d32;
            padding-left: 15px;
            margin-bottom: 20px;
            color: #2e7d32;
        }
     </style>
    <!-- Librairie jsPDF pour export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="console.error('Erreur chargement jsPDF')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="console.error('Erreur chargement html2canvas')"></script>
</head>
<body>
 <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <img src="https://cotedivoirexport.ci/wp-content/uploads/2024/03/LOGO-CI-EXPORT-1.png" alt="Logo" style="max-height: 60px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;">
            <h1 class="auth-title">🔐 Accès Sécurisé</h1>
            <p class="auth-subtitle">Outil de Diagnostic Export</p>
            
            <form class="auth-form" onsubmit="authenticate(event)">
                <label for="username">Nom d'utilisateur :</label>
                <input type="text" id="username" class="auth-input" required>
                
                <label for="password">Mot de passe :</label>
                <input type="password" id="password" class="auth-input" required>
                
                <button type="submit" class="auth-btn">Se connecter</button>
                
           <div id="authError" class="auth-error" style="display: none;"></div>
        </form>
        
        <div id="authLoading" class="auth-loading">
            <div class="auth-loading-text">🔓 Connexion réussie ! Chargement en cours...</div>
            <div class="auth-progress-container">
                <div id="authProgressBar" class="auth-progress-bar"></div>
            </div>
            <div id="authPercentage" class="auth-percentage">0%</div>
        </div>
        </div>
    </div>
    <div class="container">
        <div class="header">
    <div class="header-logo">
        <img src="https://cotedivoirexport.ci/wp-content/uploads/2024/03/LOGO-CI-EXPORT-1.png" 
             alt="Côte d'Ivoire Export" 
             style="width: 180px; height: auto; max-height: 120px; object-fit: contain;">
    </div>
    <div class="header-content">
        <h1>🔍 Outil de Diagnostic Export</h1>
        <p>Évaluation des Capacités Export</p>
    </div>
    <div class="header-help">
        <button onclick="showHelpMenu()" style="
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
            transition: all 0.3s ease;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(26, 115, 232, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 12px rgba(26, 115, 232, 0.3)'">
            📖 Guide d'utilisation
        </button>
    </div>
</div>

        <nav class="navigation">
            <button class="nav-btn active" onclick="showSection('company')">
                🏢 Informations Entreprise
            </button>
            <button class="nav-btn" onclick="showSection('evaluation')">
                📋 Évaluation (50 Questions)
            </button>
            <button class="nav-btn" onclick="showSectionWithLoading('results')" id="resultsTab">
                📊 Résultats & Analyse
            </button>
            <button class="nav-btn" onclick="showSectionWithLoading('detailed')" id="detailedTab">
                🔍 Diagnostic Détaillé
            </button>
            <button class="nav-btn" onclick="showSection('history')">
                📚 Historique
            </button>
            <button class="nav-btn reset-btn" onclick="resetApplication()">
                🔄 Nouveau diagnostic
            </button>
        </nav>

        <!-- Conteneur de chargement -->
        <div id="loadingContainer" class="loading-container">
            <div class="loading-title">🔍 Analyse Approfondie en Cours</div>
            <div class="loading-subtitle">Génération de votre rapport détaillé...</div>
            
            <div class="loading-bar-container">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            <div class="loading-percentage" id="loadingPercentage">0%</div>
            
            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <span class="loading-step-icon">⏳</span>
                    <span id="step1-text">Calcul des scores pondérés par dimension</span>
                </div>
                <div class="loading-step" id="step2">
                    <span class="loading-step-icon">⏳</span>
                    <span id="step2-text">Analyse des interdépendances et goulots d'étranglement</span>
                </div>
                <div class="loading-step" id="step3">
                    <span class="loading-step-icon">⏳</span>
                    <span id="step3-text">Génération des recommandations stratégiques</span>
                </div>
                <div class="loading-step" id="step4">
                    <span class="loading-step-icon">⏳</span>
                    <span id="step4-text">Élaboration du plan d'action personnalisé</span>
                </div>
                <div class="loading-step" id="step5">
                    <span class="loading-step-icon">⏳</span>
                    <span id="step5-text">Finalisation du rapport d'analyse</span>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Section Informations Entreprise -->
            <div id="company" class="section active">
                <h2>🏢 Informations de l'Entreprise</h2>
                <form id="companyForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyName">Nom de l'entreprise *</label>
                            <input type="text" id="companyName" name="companyName" required>
                        </div>
                        <div class="form-group">
                            <label for="sector">Secteur d'activité *</label>
                            <select id="sector" name="sector" required>
                                <option value="">Sélectionnez votre secteur</option>
<option value="Agro-alimentaire">Agro-alimentaire</option>
<option value="Agriculture">Agriculture</option>
<option value="Agroforesterie">Agroforesterie</option>
<option value="Mines et Métaux">Mines et Métaux</option>
<option value="Pétrole et Gaz">Pétrole et Gaz</option>
<option value="Textile">Textile</option>
<option value="Confection">Confection</option>
<option value="Pharmaceutique">Pharmaceutique</option>
<option value="Cosmétiques">Cosmétiques</option>
<option value="Artisanat">Artisanat</option>
<option value="Bois et Ameublement">Bois et Ameublement</option>
<option value="Matériaux de Construction">Matériaux de Construction</option>
<option value="Chimie et Parachimie">Chimie et Parachimie</option>
<option value="Électronique">Électronique</option>
<option value="Mécanique">Mécanique</option>
<option value="Transport et Logistique">Transport et Logistique</option>
<option value="Services Financiers">Services Financiers</option>
<option value="Tourisme">Tourisme</option>
<option value="BTP">BTP</option>
<option value="Énergie Renouvelable">Énergie Renouvelable</option>
<option value="Autre">Autre</option>
</select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="employees">Nombre d'employés</label>
                            <select id="employees" name="employees">
                                <option value="">Sélectionnez</option>
                                <option value="1-9">1-9 employés</option>
                                <option value="10-49">10-49 employés</option>
                                <option value="50-249">50-249 employés</option>
                                <option value="250+">250+ employés</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="revenue">Chiffre d'affaires annuel (FCFA)</label>
                            <select id="revenue" name="revenue">
                                <option value="">Sélectionnez</option>
                                <option value="< 10M">Moins de 10 millions FCFA</option>
<option value="10M-20M">10M - 20M FCFA</option>
<option value="20M-30M">20M - 30M FCFA</option>
<option value="30M-40M">30M - 40M FCFA</option>
<option value="40M-50M">40M - 50M FCFA</option>
<option value="50M-60M">50M - 60M FCFA</option>
<option value="60M-70M">60M - 70M FCFA</option>
<option value="70M-80M">70M - 80M FCFA</option>
<option value="80M-90M">80M - 90M FCFA</option>
<option value="90M-100M">90M - 100M FCFA</option>
<option value="100M-110M">100M - 110M FCFA</option>
<option value="110M-120M">110M - 120M FCFA</option>
<option value="120M-130M">120M - 130M FCFA</option>
<option value="130M-140M">130M - 140M FCFA</option>
<option value="140M-150M">140M - 150M FCFA</option>
<option value="150M-160M">150M - 160M FCFA</option>
<option value="160M-170M">160M - 170M FCFA</option>
<option value="170M-180M">170M - 180M FCFA</option>
<option value="180M-190M">180M - 190M FCFA</option>
<option value="190M-200M">190M - 200M FCFA</option>
<option value="200M+">Plus de 200 millions FCFA</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="country">Pays du siège social</label>
                            <select id="country" name="country">
                                <option value="">Sélectionnez</option>
                                <option value="Côte d'Ivoire">Côte d'Ivoire</option>
                                <option value="Sénégal">Sénégal</option>
                                <option value="Ghana">Ghana</option>
                                <option value="Mali">Mali</option>
                                <option value="Burkina Faso">Burkina Faso</option>
                                <option value="Niger">Niger</option>
                                <option value="Togo">Togo</option>
                                <option value="Bénin">Bénin</option>
                                <option value="Cameroun">Cameroun</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="email">Email de contact</label>
                            <input type="email" id="email" name="email">
                        </div>
                    </div>

		    <div class="form-row">
    <div class="form-group">
        <label for="interviewer">Dossier suivi par *</label>
        <input type="text" id="interviewer" name="interviewer" required placeholder="Nom et prénom de l'agent ACIEX">
    </div>
    <div class="form-group">
        <label for="leaderGender">Sexe du dirigeant *</label>
        <select id="leaderGender" name="leaderGender" required>
            <option value="">Sélectionnez</option>
            <option value="Homme">Homme</option>
            <option value="Femme">Femme</option>
        </select>
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <label for="leaderAge">Tranche d'âge du dirigeant</label>
        <select id="leaderAge" name="leaderAge">
            <option value="">Sélectionnez (facultatif)</option>
            <option value="Moins de 25 ans">Moins de 25 ans</option>
            <option value="25-34 ans">25-34 ans</option>
            <option value="35-44 ans">35-44 ans</option>
            <option value="45-54 ans">45-54 ans</option>
            <option value="55-64 ans">55-64 ans</option>
            <option value="65 ans et plus">65 ans et plus</option>
        </select>
    </div>
    <div class="form-group">
        <!-- Espace vide pour l'alignement -->
    </div>
</div>


                    <div class="form-group">
                        <label for="currentMarkets">Marchés actuels *</label>
                        <div class="multi-select" id="currentMarketsSelect">
                            <div class="multi-select-display" onclick="toggleDropdown('currentMarkets')">
                                <div class="selected-countries" id="currentMarketsDisplay">
                                    <span style="color: #999;">Sélectionnez vos marchés actuels</span>
                                </div>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="multi-select-dropdown" id="currentMarketsDropdown">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="targetMarket">Marché cible prioritaire pour l'export *</label>
                        <select id="targetMarket" name="targetMarket" required>
                            <option value="">Sélectionnez votre marché cible principal</option>
                            <!-- Options seront ajoutées par JavaScript -->
                        </select>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="nextCompanySection()">
                        Suivant ➡️
                    </button>
                </form>
            </div>

            <!-- Section Évaluation -->
            <div id="evaluation" class="section">
                <h2>📋 Évaluation des Capacités (50 Questions)</h2>
                
                <div class="progress-container">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0/50 questions complétées</div>

                <div id="questionsContainer"></div>

                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="calculateResults()">
                        📊 Calculer les Résultats
                    </button>
                </div>
            </div>

            <!-- Section Résultats -->
            <div id="results" class="section">
                <div id="resultsContainer">
                    <div class="alert alert-warning">
                        <strong>Aucun résultat disponible.</strong><br>
                        Veuillez d'abord compléter l'évaluation dans l'onglet "Évaluation".
                    </div>
                </div>
            </div>

            <!-- Section Diagnostic Détaillé -->
            <div id="detailed" class="section">
                <div id="detailedContainer">
                    <div class="alert alert-warning">
                        <strong>Aucun diagnostic détaillé disponible.</strong><br>
                        Veuillez d'abord compléter l'évaluation et calculer les résultats.
                    </div>
                </div>
            </div>

            <!-- Section Historique -->
            <div id="history" class="section">
                <h2>📚 Historique des Évaluations</h2>
                <div id="historyContainer">
                    <div class="alert alert-warning">
                        <strong>Aucun historique disponible.</strong><br>
                        Vos évaluations apparaîtront ici une fois que vous aurez calculé vos premiers résultats.
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Modal d'aide -->
<div id="helpModal" class="help-modal" style="display: none;">
    <div class="help-modal-content">
        <div class="help-header">
            <h2>📖 Guide d'utilisation - Outil Diagnostic Export</h2>
            <span class="help-close" onclick="closeHelpMenu()">&times;</span>
        </div>
        <div class="help-menu">
            <div class="help-menu-item" onclick="openHelpSection('prise-en-main')">
                <h3>🚀 Prise en main</h3>
                <p>Comment renseigner les champs et obtenir vos résultats</p>
            </div>
            <div class="help-menu-item" onclick="openHelpSection('lecture-resultats')">
                <h3>📊 Lecture des résultats</h3>
                <p>Interpréter vos scores et analyses détaillées</p>
            </div>
            <div class="help-menu-item" onclick="openHelpSection('enregistrement')">
                <h3>💾 Enregistrement & Export</h3>
                <p>Sauvegarder et exporter vers PDF ou Google Sheets</p>
            </div>
            <div class="help-menu-item" onclick="openHelpSection('faq')">
                <h3>❓ FAQ</h3>
                <p>Questions fréquentes et réponses détaillées</p>
            </div>
        </div>
    </div>
</div>

    <script>
        // Variables globales
        let currentData = {
    company: {},
    scores: {},
    results: null,
    certificationDetails: {}
};

        // Configuration Google Sheets API
        const GOOGLE_SHEETS_CONFIG = {
            apiKey: 'AIzaSyCx94tUUNfyMuBIdyxg821s9lP3fE2wlkA', // Remplace par ta clé API
            spreadsheetId: '13hS0qkGxA78MQQoALDog-H20MmfBdlkARkiE99UQnLc', // Remplace par l'ID de ton Google Sheet
            discoveryDoc: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
            scope: 'https://www.googleapis.com/auth/spreadsheets'
        };

	// URL du Google Apps Script (remplace par ta vraie URL)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJoNgydFifhZY5xZfcHKNj_C2ES0ylg2ulz_4C6IRKGrj4Rd77SHlzaim_Bd8BH4h2KQ/exec';

        // Listes des pays
        const africaCountries = [
            'Bénin', 'Burkina Faso', 'Cameroun', 'Cap-Vert', 'Côte d\'Ivoire', 'Gabon', 'Gambie', 
            'Ghana', 'Guinée', 'Guinée-Bissau', 'Guinée Équatoriale', 'Liberia', 'Mali', 
            'Mauritanie', 'Niger', 'Nigeria', 'République Centrafricaine', 'République Démocratique du Congo',
            'République du Congo', 'Sénégal', 'Sierra Leone', 'Tchad', 'Togo',
            'Afrique du Sud', 'Algérie', 'Angola', 'Botswana', 'Burundi', 'Comores', 'Djibouti',
            'Égypte', 'Érythrée', 'Eswatini', 'Éthiopie', 'Kenya', 'Lesotho', 'Libye',
            'Madagascar', 'Malawi', 'Maroc', 'Maurice', 'Mozambique', 'Namibie', 'Ouganda',
            'Rwanda', 'São Tomé-et-Principe', 'Seychelles', 'Somalie', 'Soudan', 'Soudan du Sud',
            'Tanzanie', 'Tunisie', 'Zambie', 'Zimbabwe'
        ];

        const exportCountries = [
            // CEDEAO (15 pays) - Zone de libre-échange
            'Bénin', 'Burkina Faso', 'Cap-Vert', 'Gambie', 'Ghana', 'Guinée', 'Guinée-Bissau', 
            'Liberia', 'Mali', 'Niger', 'Nigeria', 'Sénégal', 'Sierra Leone', 'Togo',
            
            // UEMOA (Zone Franc) - Union économique
            'Bénin', 'Burkina Faso', 'Mali', 'Niger', 'Sénégal', 'Togo', 'Guinée-Bissau',
            
            // Union Européenne - APE (Accord Partenariat Économique)
            'France', 'Allemagne', 'Pays-Bas', 'Belgique', 'Italie', 'Espagne', 'Portugal', 
            'Grèce', 'Irlande', 'Luxembourg', 'Autriche', 'Finlande', 'Suède', 'Danemark',
            'Pologne', 'République Tchèque', 'Hongrie', 'Slovaquie', 'Slovénie', 'Estonie',
            'Lettonie', 'Lituanie', 'Croatie', 'Bulgarie', 'Roumanie', 'Chypre', 'Malte',
            
            // Afrique du Nord - Relations bilatérales fortes
            'Maroc', 'Tunisie', 'Algérie', 'Égypte', 'Libye',
            
            // Afrique Centrale - CEMAC et relations régionales
            'Cameroun', 'Gabon', 'République Centrafricaine', 'République du Congo', 
            'République Démocratique du Congo', 'Tchad', 'Guinée Équatoriale',
            
            // Afrique de l'Est - Relations commerciales établies
            'Kenya', 'Éthiopie', 'Tanzanie', 'Ouganda', 'Rwanda', 'Djibouti', 'Madagascar',
            
            // Afrique Australe - SADC et relations
            'Afrique du Sud', 'Angola', 'Namibie', 'Botswana', 'Zimbabwe', 'Zambie', 
            'Maurice', 'Mozambique', 'Malawi',
            
            // Amérique du Nord
            'États-Unis', 'Canada',
            
            // Amérique Latine - Relations Sud-Sud
            'Brésil', 'Argentine', 'Mexique', 'Chili', 'Colombie', 'Pérou', 'Venezuela',
            
            // Asie-Pacifique - Partenaires commerciaux majeurs
            'Chine', 'Inde', 'Japon', 'Corée du Sud', 'Singapour', 'Malaisie', 'Thaïlande',
            'Indonésie', 'Vietnam', 'Philippines', 'Bangladesh', 'Pakistan', 'Sri Lanka',
            'Australie', 'Nouvelle-Zélande',
            
            // Moyen-Orient - Relations commerciales importantes
            'Émirats Arabes Unis', 'Arabie Saoudite', 'Qatar', 'Koweït', 'Bahreïn', 'Oman',
            'Israël', 'Turquie', 'Iran', 'Jordanie', 'Liban',
            
            // Autres partenaires importants
            'Suisse', 'Norvège', 'Royaume-Uni', 'Russie'
        ];

        // Fonctions pour les multi-select et select
        function initializeMultiSelects() {
            populateDropdown('currentMarkets', africaCountries);
            populateCountrySelect('targetMarket', exportCountries);
        }

         function populateCountrySelect(selectId, countries) {
            const select = document.getElementById(selectId);
            
            // Supprimer les doublons et trier par ordre alphabétique
            const uniqueCountries = [...new Set(countries)].sort();
            
            uniqueCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                select.appendChild(option);
            });
        }

function populateDropdown(selectId, countries) {
            const dropdown = document.getElementById(selectId + 'Dropdown');
            dropdown.innerHTML = '';
            
            countries.forEach(country => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                
                // Créer un ID sûr sans caractères spéciaux
                const safeId = country.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Créer les éléments sans utiliser innerHTML pour éviter les problèmes d'échappement
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${selectId}_${safeId}`;
                checkbox.value = country;
                
                const label = document.createElement('label');
                label.setAttribute('for', `${selectId}_${safeId}`);
                label.textContent = country;
                
                // Ajouter l'event listener directement
                checkbox.addEventListener('change', function() {
                    updateSelection(selectId, country);
                });
                
                option.appendChild(checkbox);
                option.appendChild(label);
                dropdown.appendChild(option);
            });
        }

        function toggleDropdown(selectId) {
            const dropdown = document.getElementById(selectId + 'Dropdown');
            const display = document.querySelector(`#${selectId}Select .multi-select-display`);
            const arrow = display.querySelector('.dropdown-arrow');
            
            // Fermer tous les autres dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd.id !== selectId + 'Dropdown') {
                    dd.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.multi-select-display').forEach(dd => {
                if (dd !== display) {
                    dd.classList.remove('active');
                    dd.querySelector('.dropdown-arrow').classList.remove('rotated');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('active');
            display.classList.toggle('active');
            arrow.classList.toggle('rotated');
        }

        function updateSelection(selectId, country) {
            console.log('🔄 Mise à jour sélection:', selectId, country);
            
            // Créer un ID sûr pour trouver la checkbox
            const safeId = country.replace(/[^a-zA-Z0-9]/g, '_');
            const checkbox = document.getElementById(`${selectId}_${safeId}`);
            
            if (!checkbox) {
                console.error('❌ Checkbox non trouvée pour:', country, 'ID:', `${selectId}_${safeId}`);
                return;
            }
            
            const display = document.getElementById(selectId + 'Display');
            
            if (!currentData.company[selectId]) {
                currentData.company[selectId] = [];
            }
            
            if (checkbox.checked) {
                if (!currentData.company[selectId].includes(country)) {
                    currentData.company[selectId].push(country);
                    console.log('✅ Pays ajouté:', country);
                }
            } else {
                currentData.company[selectId] = currentData.company[selectId].filter(c => c !== country);
                console.log('❌ Pays retiré:', country);
            }
            
            updateDisplaySelection(selectId);
            saveToStorage();
        }

        function updateDisplaySelection(selectId) {
            const display = document.getElementById(selectId + 'Display');
            const selected = currentData.company[selectId] || [];
            
            console.log('🔄 Mise à jour affichage pour:', selectId, 'Pays sélectionnés:', selected);
            
            if (selected.length === 0) {
                const placeholder = 'Sélectionnez vos marchés actuels';
                display.innerHTML = `<span style="color: #999;">${placeholder}</span>`;
            } else {
                // Créer les tags sans utiliser onclick pour éviter les problèmes d'échappement
                display.innerHTML = '';
                selected.forEach(country => {
                    const tag = document.createElement('span');
                    tag.className = 'country-tag';
                    tag.innerHTML = `${country} <span class="remove">×</span>`;
                    
                    // Ajouter l'event listener au bouton de suppression
                    const removeBtn = tag.querySelector('.remove');
                    removeBtn.addEventListener('click', function() {
                        removeCountry(selectId, country);
                    });
                    
                    display.appendChild(tag);
                });
            }
        }

        function removeCountry(selectId, country) {
            console.log('🗑️ Suppression pays:', country);
            
            // Créer un ID sûr pour trouver la checkbox
            const safeId = country.replace(/[^a-zA-Z0-9]/g, '_');
            const checkbox = document.getElementById(`${selectId}_${safeId}`);
            
            if (checkbox) {
                checkbox.checked = false;
                console.log('✅ Checkbox décochée pour:', country);
            } else {
                console.error('❌ Checkbox non trouvée pour suppression:', country);
            }
            
            if (currentData.company[selectId]) {
                currentData.company[selectId] = currentData.company[selectId].filter(c => c !== country);
            }
            
            updateDisplaySelection(selectId);
            saveToStorage();
        }

        // Fermer les dropdowns en cliquant ailleurs
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                    dd.classList.remove('active');
                });
                document.querySelectorAll('.multi-select-display').forEach(dd => {
                    dd.classList.remove('active');
                    dd.querySelector('.dropdown-arrow').classList.remove('rotated');
                });
            }
        });

        // Dimensions et questions
        const dimensions = [
    {
        title: "1. Produit et Positionnement",
        weight: 10,
        questions: [
            "Votre produit/service répond-il à un besoin spécifique sur les marchés export ?",
            "Avez-vous adapté votre offre aux goûts et préférences locales ?",
            "Votre marque et communication sont-elles attractives à l'international ?",
            "Disposez-vous d'une protection intellectuelle de vos produits (brevets, marques) ?",
            "Vos produits ont-ils un avantage concurrentiel distinctif ?"
        ]
    },
    {
        title: "2. Capacité de Production et Logistique",
        weight: 12,
        questions: [
            "Votre entreprise dispose-t-elle d'une capacité de production suffisante pour répondre à une demande export supplémentaire de 30% ?",
            "Avez-vous des équipements et infrastructures conformes aux standards internationaux ?",
            "Disposez-vous d'un système de gestion des stocks et de planification de production efficace ?",
            "Votre chaîne d'approvisionnement est-elle fiable et diversifiée ?",
            "Pouvez-vous garantir des délais de livraison courts et respectés (moins de 30 jours) ?"
        ]
    },
    {
    title: "3. Qualité et Conformité",
    weight: 15, 
    questions: [
        "Disposez-vous d'un système de traçabilité complet de vos produits ?",
        "Disposez-vous de certifications qualité reconnues dans vos marchés cibles ?",
        "Avez-vous un système de contrôle qualité rigoureux à toutes les étapes ?",
        "Vos emballages sont-ils adaptés au transport international et attractifs ?",
        "Effectuez-vous régulièrement des tests produits par des laboratoires agréés ?"
    ]
},
    {
        title: "4. Organisation et Processus Internes",
        weight: 9,
        questions: [
            "Vos processus internes sont-ils documentés et optimisés ?",
            "Disposez-vous d'un système informatique performant (ERP, CRM) ?",
            "Votre service client peut-il gérer des demandes en plusieurs langues ?",
            "Avez-vous des procédures claires pour traiter les commandes export ?",
            "Votre équipe est-elle formée aux spécificités du commerce international ?"
        ]
    },
    {
        title: "5. Situation Financière",
        weight: 13,
        questions: [
            "Votre entreprise dispose-t-elle d'une situation financière saine (ratios d'endettement < 70%) ?",
            "Avez-vous accès à des financements dédiés à l'export (crédit export, affacturage) ?",
            "Pouvez-vous investir au moins 10% de votre CA dans le développement export ?",
            "Disposez-vous d'une trésorerie suffisante pour supporter 90 jours de décalage de paiement ?",
            "Tenez-vous une comptabilité régulièrement mise à jour et validée par un expert-comptable ou un commissaire aux comptes ?"
        ]
    },
    {
        title: "6. Maîtrise des Prix et Techniques Commerciales Export",
        weight: 12,
        questions: [
            "Maîtrisez-vous les Incoterms et leur impact sur vos prix ?",
            "Avez-vous une grille de prix adaptée à chaque marché cible ?",
            "Connaissez-vous les techniques de paiement international (crédit documentaire, etc.) ?",
            "Disposez-vous d'outils de couverture contre le risque de change ?",
            "Vos prix sont-ils compétitifs par rapport à la concurrence internationale ?"
        ]
    },
    {
        title: "7. Expérience et Compétences Export",
        weight: 11,
        questions: [
            "Votre équipe a-t-elle une expérience du commerce international ?",
            "Disposez-vous d'un responsable export dédié et formé ?",
            "Connaissez-vous les réglementations douanières de vos marchés cibles ?",
            "Avez-vous déjà participé à des salons internationaux ou missions commerciales ?",
            "Maîtrisez-vous les langues de vos marchés cibles (anglais, français, etc.) ?"
        ]
    },
    {
        title: "8. Innovation et Développement",
        weight: 8,
        questions: [
            "Investissez-vous régulièrement dans la R&D (au moins 2% du CA) ?",
            "Votre entreprise développe-t-elle de nouveaux produits/services annuellement ?",
            "Suivez-vous les tendances et innovations de votre secteur ?",
            "Collaborez-vous avec des centres de recherche ou universités ?",
            "Vos innovations sont-elles protégées et valorisées ?"
        ]
    },
    {
        title: "9. Réseau et Partenariats",
        weight: 5,
        questions: [
            "Avez-vous des contacts ou partenaires dans vos marchés cibles ?",
            "Participez-vous à des réseaux professionnels internationaux ?",
            "Disposez-vous de distributeurs ou agents commerciaux fiables ?",
            "Entretenez-vous des relations avec les institutions d'appui à l'export ?",
            "Votre réseau LinkedIn/professionnel est-il développé internationalement ?"
        ]
    },
    {
        title: "10. Planification et Stratégie Export",
        weight: 5,
        questions: [
            "Avez-vous un business plan export formalisé sur 3 ans ?",
            "Vos objectifs export sont-ils chiffrés et suivis mensuellement ?",
            "Allouez-vous un budget spécifique au développement export ?",
            "Effectuez-vous une veille concurrentielle sur vos marchés cibles ?",
            "Avez-vous défini une stratégie de pénétration par marché ?"
        ]
    }
];

// Base de données des recommandations spécifiques par question
const questionRecommendations = {
    // DIMENSION 1 : Produit et Positionnement (ancien index 5)
    "0-0": {
        short: "Valider l'adéquation produit/marché export",
        detailed: "Étude de marché approfondie pour confirmer la demande sur vos marchés cibles. Tests consommateurs, analyse comportementale. Étude marché : 1-3M FCFA selon pays."
    },
    "0-1": {
        short: "Adapter votre offre aux préférences locales",
        detailed: "Recherche consommateurs locaux, adaptation produit aux goûts/habitudes. Tests marchés pilotes recommandés. Budget adaptation produit : 2-5M FCFA selon complexité."
    },
    "0-2": {
        short: "Développer une marque et communication internationale",
        detailed: "Création identité visuelle export, supports multilingues, stratégie communication digitale. Agence communication internationale : 2-8M FCFA selon ambition."
    },
    "0-3": {
        short: "Protéger votre propriété intellectuelle",
        detailed: "Dépôt marques et brevets dans vos marchés cibles prioritaires. Protection designs, savoir-faire. Cabinet PI international : 1-4M FCFA selon nombre pays."
    },
    "0-4": {
        short: "Développer vos avantages concurrentiels",
        detailed: "Identifier et renforcer vos différenciateurs uniques. Innovation produit, service, positionnement. R&D export recommandée : 5-15% CA selon secteur."
    },

    // DIMENSION 2 : Capacité de Production et Logistique (ancien index 0)
    "1-0": {
        short: "Évaluer et renforcer votre capacité de production",
        detailed: "Réalisez un audit de capacité immédiat pour identifier les goulots d'étranglement. Planifiez les investissements nécessaires (équipements, personnel) pour absorber une croissance export de 30%. Budget estimé : 3-8M FCFA selon la taille."
    },
    "1-1": {
        short: "Mettre aux normes vos équipements et infrastructures",
        detailed: "Audit de conformité technique urgent avec un expert sectoriel. Établir un plan de mise aux normes internationales (ISO, CE, etc.) avec calendrier précis. Investissement prioritaire : 2-5M FCFA."
    },
    "1-2": {
        short: "Implémenter un système de gestion des stocks et de planification",
        detailed: "Installer un logiciel ERP adapé à l'export (gestion stocks, planification production, suivi commandes). Formation équipes requise. Solution recommandée : 500K-2M FCFA selon la complexité."
    },
    "1-3": {
        short: "Diversifier et sécuriser votre chaîne d'approvisionnement",
        detailed: "Identifier et contractualiser avec au moins 2-3 fournisseurs alternatifs par matière première critique. Négocier des accords-cadres avec clauses de garantie d'approvisionnement. Budget sécurisation : 1-3M FCFA."
    },
    "1-4": {
        short: "Optimiser vos délais de livraison pour l'export",
        detailed: "Revoir complètement votre processus de production pour garantir des délais < 30 jours. Identifier les étapes critiques, former les équipes aux urgences export. Consultant logistique recommandé : 800K-1.5M FCFA."
    },

    // DIMENSION 3 : Qualité et Conformité (ancien index 1)
    "2-0": {
    short: "Mettre en place un système de traçabilité complet",
    detailed: "Établir un système de traçabilité permettant de suivre vos produits de la matière première au client final. Essentiel pour les exigences export et rappels produits. Budget : 300K-1.5M FCFA selon complexité."
},
    "2-1": {
        short: "Acquérir les certifications qualité reconnues sur vos marchés",
        detailed: "Identifier précisément les certifications exigées par votre marché cible (FDA, CE, HACCP, etc.). Contacter organismes certificateurs agréés. Budget certifications : 800K-3M FCFA."
    },
    "2-2": {
        short: "Établir un système de contrôle qualité rigoureux",
        detailed: "Créer un département qualité dédié avec procédures documentées à chaque étape. Former le personnel aux contrôles systématiques. Équipements de contrôle requis : 1-5M FCFA."
    },
    "2-3": {
        short: "Adapter vos emballages aux standards internationaux",
        detailed: "Revoir complètement vos emballages : résistance transport international, attractivité visuelle, conformité réglementaire. Designer packaging export recommandé : 500K-2M FCFA."
    },
    "2-4": {
        short: "Mettre en place des tests produits par laboratoires agréés",
        detailed: "Contractualiser avec laboratoires certifiés pour tests réguliers de vos produits. Établir un calendrier de contrôles préventifs. Coût tests annuels : 300K-1M FCFA selon le secteur."
    },

    // DIMENSION 4 : Organisation et Processus Internes (ancien index 6)
    "3-0": {
        short: "Documenter et optimiser vos processus",
        detailed: "Cartographie complète processus, rédaction procédures export, optimisation flux. Consultant organisation : 800K-2M FCFA selon taille entreprise."
    },
    "3-1": {
        short: "Implémenter un système informatique performant",
        detailed: "Installation ERP/CRM intégrant gestion export (commandes, stocks, comptabilité, relation client). Solution informatique : 1-5M FCFA selon besoins."
    },
    "3-2": {
        short: "Former votre service client au multilingue",
        detailed: "Formation équipes service client aux spécificités export. Support multilingue, gestion réclamations internationales. Formation service client : 400K-1M FCFA."
    },
    "3-3": {
        short: "Structurer vos procédures de traitement commandes export",
        detailed: "Création workflow commandes export depuis réception jusqu'à livraison. Formation équipes aux spécificités. Optimisation process : 500K-1.5M FCFA."
    },
    "3-4": {
        short: "Former votre équipe aux spécificités internationales",
        detailed: "Programme formation commerce international pour toutes les équipes concernées. Sensibilisation interculturelle. Formation équipes : 300K-800K FCFA/personne."
    },

    // DIMENSION 5 : Situation Financière (ancien index 2)
    "4-0": {
        short: "Assainir votre situation financière",
        detailed: "Audit financier complet et plan de redressement immédiat. Réduire l'endettement sous 70% des fonds propres. Renforcement capital ou restructuration dette urgente. Expert-comptable export requis."
    },
    "4-1": {
        short: "Sécuriser des financements dédiés à l'export",
        detailed: "Démarcher banques spécialisées export (crédit export, affacturage, garanties). Constituer dossiers BPIFRANCE, AFD. Prévoir 2-3 mois de démarches. Accompagnement conseil : 400K-800K FCFA."
    },
    "4-2": {
        short: "Prévoir un budget investissement export",
        detailed: "Allouer minimum 10% du CA à l'investissement export (marketing, certifications, équipements). Établir budget pluriannuel avec ROI attendu. Plan de financement sur 2-3 ans."
    },
    "4-3": {
        short: "Renforcer votre trésorerie pour les cycles export",
        detailed: "Constituer une réserve de trésorerie équivalente à 90 jours de charges pour absorber les délais de paiement export. Solutions : découvert export, affacturage, crédit relais."
    },
    "4-4": {
        short: "Organiser une comptabilité régulière avec suivi professionnel",
        detailed: "Mise en place d'une comptabilité tenue à jour mensuellement et validation par expert-comptable agréé ou commissaire aux comptes. Logiciel comptable adapé, formation gestion, audit annuel obligatoire. Expert-comptable, commissaire aux comptes + logiciel : 800K-1.5M FCFA/an."
    },

    // DIMENSION 6 : Maîtrise des Prix et Techniques Commerciales Export (ancien index 3)
    "5-0": {
        short: "Former votre équipe aux Incoterms",
        detailed: "Formation intensive Incoterms 2020 pour toute l'équipe commerciale. Comprendre les implications coûts/risques de chaque terme. Formation spécialisée recommandée : 200K-500K FCFA."
    },
    "5-1": {
        short: "Développer une grille de prix export par marché",
        detailed: "Créer des grilles tarifaires spécifiques tenant compte des coûts export, taxes, marges distributeurs par pays. Outil pricing export recommandé. Consultant tarification : 400K-1M FCFA."
    },
    "5-2": {
        short: "Maîtriser les techniques de paiement international",
        detailed: "Formation approfondie crédit documentaire, lettres de change, garanties bancaires. Négocier accords cadres avec banques. Formation commerce international : 300K-600K FCFA."
    },
    "5-3": {
        short: "Mettre en place une couverture contre le risque de change",
        detailed: "Souscrire contrats de couverture change avec votre banque. Définir politique de couverture selon exposition. Formation risque change requise. Coût couverture : 0.5-2% du CA export."
    },
    "5-4": {
        short: "Analyser votre compétitivité prix internationale",
        detailed: "Étude comparative prix concurrents sur vos marchés cibles. Identifier sources d'optimisation coûts. Repositionnement tarifaire si nécessaire. Étude concurrentielle : 500K-1.5M FCFA."
    },

    // DIMENSION 7 : Expérience et Compétences Export (ancien index 4)
    "6-0": {
        short: "Recruter ou former une expertise commerce international",
        detailed: "Embaucher un responsable export expérimenté ou former intensivement votre équipe actuelle. Budget recrutement : 3-8M FCFA/an ou formation : 1-3M FCFA."
    },
    "6-1": {
        short: "Désigner et former un responsable export dédié",
        detailed: "Nommer officiellement un responsable export avec pouvoir décisionnel. Formation complète commerce international sur 3-6 mois. Certification export recommandée : 800K-2M FCFA."
    },
    "6-2": {
        short: "Vous former aux réglementations douanières",
        detailed: "Formation intensive procédures douanières, classification tarifaire, origine préférentielle. Contact avec transitaires agréés. Formation douanes : 300K-800K FCFA."
    },
    "6-3": {
        short: "Participer à des salons et missions commerciales",
        detailed: "Planifier participation à 2-3 salons internationaux sectoriels par an. Rejoindre missions commerciales ACIEX. Budget salons : 2-5M FCFA/an selon destinations."
    },
    "6-4": {
        short: "Renforcer vos compétences linguistiques",
        detailed: "Formation anglais commercial pour équipe dirigeante et commerciale. Maîtrise français commercial si nécessaire. Cours intensifs recommandés : 500K-1.5M FCFA/personne."
    },

    // DIMENSION 8 : Innovation et Développement (ancien index 7)
    "7-0": {
        short: "Investir dans la recherche et développement",
        detailed: "Allouer minimum 2% du CA à la R&D export. Innovations produits, process, services pour marchés internationaux. Budget R&D : 2-5% CA selon secteur."
    },
    "7-1": {
        short: "Développer régulièrement de nouveaux produits",
        detailed: "Plan innovation produit avec 1-2 nouveautés/an adaptées aux marchés export. Veille technologique, partenariats R&D. Innovation continue : 3-8M FCFA/an."
    },
    "7-2": {
        short: "Organiser votre veille concurrentielle et technologique",
        detailed: "Système de veille structuré : tendances, technologies, concurrence par marché. Abonnements bases données, participation événements. Veille : 500K-2M FCFA/an."
    },
    "7-3": {
        short: "Établir des partenariats avec centres de recherche",
        detailed: "Conventions avec universités/centres de recherche pour projets innovation export. Participation clusters, pôles compétitivité. Partenariats R&D : 1-5M FCFA/projet."
    },
    "7-4": {
        short: "Protéger et valoriser vos innovations",
        detailed: "Protection industrielle : brevets, marques, designs. Valorisation innovations via licensing, partenariats. Protection innovations : 2-6M FCFA selon portefeuille."
    },

    // DIMENSION 9 : Réseau et Partenariats (ancien index 8)
    "8-0": {
        short: "Développer vos contacts dans les marchés cibles",
        detailed: "Stratégie networking systématique : salons, missions, chambres de commerce. Participation événements sectoriels. Développement réseau : 1-3M FCFA/an."
    },
    "8-1": {
        short: "Rejoindre des réseaux professionnels internationaux",
        detailed: "Adhésion associations professionnelles internationales, clubs export, réseaux sectoriels. Participation active événements. Cotisations réseaux : 200K-1M FCFA/an."
    },
    "8-2": {
        short: "Identifier et contractualiser avec des distributeurs fiables",
        detailed: "Prospection distributeurs agréés, due diligence, négociation contrats exclusifs/non exclusifs. Accompagnement juridique : 800K-2M FCFA selon marchés."
    },
    "8-3": {
        short: "Renforcer vos relations avec les institutions d'appui",
        detailed: "Collaboration régulière ACIEX, chambres commerce, organismes sectoriels. Participation programmes accompagnement. Optimisation accompagnement institutionnel."
    },
    "8-4": {
        short: "Développer votre réseau professionnel digital",
        detailed: "Stratégie LinkedIn export, présence réseaux sectoriels, content marketing B2B. Consultant marketing digital : 500K-1.5M FCFA pour stratégie complète."
    },

    // DIMENSION 10 : Planification et Stratégie Export (ancien index 9)
    "9-0": {
        short: "Formaliser votre business plan export",
        detailed: "Rédaction business plan export détaillé 3 ans : marchés, investissements, prévisions. Consultant stratégie export recommandé : 1-3M FCFA selon complexité."
    },
    "9-1": {
        short: "Définir et suivre vos objectifs export chiffrés",
        detailed: "KPIs export précis avec suivi mensuel : CA, marges, parts marché, ROI. Tableau de bord export informatisé. Outils pilotage : 300K-800K FCFA."
    },
    "9-2": {
        short: "Allouer un budget spécifique au développement export",
        detailed: "Budget export dédié représentant 10-20% CA visé export. Répartition marketing, certifications, développement. Planification budgétaire pluriannuelle."
    },
    "9-3": {
        short: "Organiser votre veille concurrentielle systématique",
        detailed: "Système veille concurrentielle structuré par marché : prix, innovations, stratégies. Outils veille professionnels. Veille concurrentielle : 400K-1.2M FCFA/an."
    },
    "9-4": {
        short: "Définir votre stratégie de pénétration par marché",
        detailed: "Stratégie spécifique par pays : mode d'entrée, partenaires, investissements, timing. Plan déploiement séquentiel. Conseil stratégique : 1.5-4M FCFA selon nombre pays."
    }
};

        // Base de données des profils pays
        const countryProfiles = {
            // ===== UNION EUROPÉENNE (27 pays) =====
            'France': {
                profile: {
                    gdp: '2 940 milliards USD (2023)', gdpPerCapita: '43 659 USD', growth: '0.9% (2023)',
                    currency: 'Euro (EUR)', population: '68.4 millions', doingBusiness: '32e/190',
                    mainSectors: ['Services (78.8%)', 'Industrie (19.5%)', 'Agriculture (1.7%)'],
                    inflation: '4.9% (2023)', importVolume: '625 milliards USD',
                    keyImports: ['Cacao et dérivés', 'Café', 'Huile de palme', 'Caoutchouc', 'Coton']
                },
                agreements: {
                    bilateral: ['APE UE-Afrique Ouest (2014)', 'Zone Franc CFA', 'Coopération France-CI'],
                    multilateral: ['OMC', 'Union Européenne', 'ACP-UE'], preferential: ['APE - 0% droits', 'SPG+']
                },
                business: {
                    strengths: ['1er partenaire historique', 'Langue commune', 'Zone Franc'], challenges: ['Normes CE strictes'],
                    opportunities: ['Marché bio', 'Diaspora'], entry_strategy: ['Certification bio UE', 'Distributeurs spécialisés']
                },
                sectors: { 'Agro-alimentaire': { potential: 'TRÈS ÉLEVÉ', details: '1er importateur cacao CI', requirements: 'Bio UE, HACCP', competition: 'Forte' }}
            },
            
            'Allemagne': {
                profile: {
                    gdp: '4 260 milliards USD (2023)', gdpPerCapita: '50 794 USD', growth: '-0.3% (2023)',
                    currency: 'Euro (EUR)', population: '83.2 millions', doingBusiness: '22e/190',
                    mainSectors: ['Services (69.3%)', 'Industrie (30.1%)', 'Agriculture (0.6%)'],
                    inflation: '6.1% (2023)', importVolume: '1 560 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Noix cajou', 'Caoutchouc', 'Bois tropicaux']
                },
                agreements: {
                    bilateral: ['APE UE-Afrique Ouest', 'Coopération Allemagne-CI'], multilateral: ['UE', 'OMC', 'G7'],
                    preferential: ['APE - 0% droits', 'SPG+', 'EBA']
                },
                business: {
                    strengths: ['1ère économie UE', 'Tech avancée', 'Stabilité'], challenges: ['Normes DIN strictes'],
                    opportunities: ['Transition verte', 'Industrie 4.0'], entry_strategy: ['Certification TÜV', 'Salons Düsseldorf']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: '1er importateur cacao mondial', requirements: 'Bio-Siegel, IFS', competition: 'Intense' }}
            },

            'Pays-Bas': {
                profile: {
                    gdp: '1 013 milliards USD (2023)', gdpPerCapita: '57 534 USD', growth: '0.1% (2023)',
                    currency: 'Euro (EUR)', population: '17.6 millions', doingBusiness: '42e/190',
                    mainSectors: ['Services (70.2%)', 'Industrie (17.9%)', 'Agriculture (1.6%)'],
                    inflation: '4.0% (2023)', importVolume: '720 milliards USD',
                    keyImports: ['Cacao (Port Rotterdam)', 'Café', 'Caoutchouc', 'Huiles végétales']
                },
                agreements: {
                    bilateral: ['APE UE-Afrique Ouest', 'Programme Dutch Good Growth Fund'], multilateral: ['UE', 'OMC'],
                    preferential: ['APE - 0% droits', 'SPG+']
                },
                business: {
                    strengths: ['Port Rotterdam hub', 'Expertise agro', 'Négoce international'], challenges: ['Marché limité'],
                    opportunities: ['Hub européen', 'Technologies agro'], entry_strategy: ['Port Rotterdam', 'Trading houses']
                },
                sectors: { 'Agro-alimentaire': { potential: 'TRÈS ÉLEVÉ', details: 'Hub cacao européen, port Rotterdam', requirements: 'UE standards', competition: 'Modérée' }}
            },

            'Belgique': {
                profile: {
                    gdp: '594 milliards USD (2023)', gdpPerCapita: '51 284 USD', growth: '1.4% (2023)',
                    currency: 'Euro (EUR)', population: '11.6 millions', doingBusiness: '45e/190',
                    mainSectors: ['Services (69.1%)', 'Industrie (22.1%)', 'Agriculture (0.7%)'],
                    inflation: '2.3% (2023)', importVolume: '470 milliards USD',
                    keyImports: ['Cacao (transformation)', 'Café', 'Produits tropicaux']
                },
                agreements: {
                    bilateral: ['APE UE-Afrique Ouest', 'Coopération belge CI'], multilateral: ['UE', 'OMC'],
                    preferential: ['APE - 0% droits', 'SPG+']
                },
                business: {
                    strengths: ['Industrie chocolat', 'Port Anvers', 'Francophonie'], challenges: ['Petit marché'],
                    opportunities: ['Chocolat premium', 'Hub Afrique'], entry_strategy: ['Industrie choco', 'Port Anvers']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Centre chocolat européen', requirements: 'Standards UE', competition: 'Spécialisée' }}
            },

            'Italie': {
                profile: {
                    gdp: '2 110 milliards USD (2023)', gdpPerCapita: '35 657 USD', growth: '0.9% (2023)',
                    currency: 'Euro (EUR)', population: '59.1 millions', doingBusiness: '58e/190',
                    mainSectors: ['Services (65.9%)', 'Industrie (23.9%)', 'Agriculture (2.0%)'],
                    inflation: '5.9% (2023)', importVolume: '625 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Coton', 'Produits tropicaux']
                },
                agreements: {
                    bilateral: ['APE UE-Afrique Ouest'], multilateral: ['UE', 'OMC', 'G7'],
                    preferential: ['APE - 0% droits', 'SPG+']
                },
                business: {
                    strengths: ['Industrie alimentaire', 'Mode/textile', 'Design'], challenges: ['Bureaucratie'],
                    opportunities: ['Café espresso', 'Mode éthique'], entry_strategy: ['Foires Milan', 'Distributeurs Nord']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Marché café, produits premium', requirements: 'Standards UE', competition: 'Forte' }}
            },

            'Espagne': {
                profile: {
                    gdp: '1 398 milliards USD (2023)', gdpPerCapita: '29 350 USD', growth: '2.5% (2023)',
                    currency: 'Euro (EUR)', population: '47.6 millions', doingBusiness: '30e/190',
                    mainSectors: ['Services (67.8%)', 'Industrie (20.2%)', 'Agriculture (2.7%)'],
                    inflation: '3.5% (2023)', importVolume: '425 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Fruits tropicaux', 'Coton']
                },
                agreements: {
                    bilateral: ['APE UE-Afrique Ouest', 'Plan África'], multilateral: ['UE', 'OMC'],
                    preferential: ['APE - 0% droits', 'SPG+']
                },
                business: {
                    strengths: ['Porte Afrique', 'Agro-industrie', 'Relations historiques'], challenges: ['Crise économique'],
                    opportunities: ['Hub Afrique-UE', 'Bio'], entry_strategy: ['Madrid hub', 'Distributeurs Andalousie']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Marché cacao, fruits tropicaux', requirements: 'Standards UE', competition: 'Modérée' }}
            },

            // ===== CEDEAO (15 pays) =====
            'Ghana': {
                profile: {
                    gdp: '76.6 milliards USD (2023)', gdpPerCapita: '2 445 USD', growth: '2.9% (2023)',
                    currency: 'Cedi ghanéen (GHS)', population: '31.7 millions', doingBusiness: '118e/190',
                    mainSectors: ['Services (46.1%)', 'Agriculture (19.7%)', 'Industrie (34.2%)'],
                    inflation: '40.4% (2023)', importVolume: '15.8 milliards USD',
                    keyImports: ['Riz', 'Huiles végétales', 'Sucre', 'Produits transformés']
                },
                agreements: {
                    bilateral: ['CEDEAO libre-échange', 'Accord CI-Ghana (2021)'], multilateral: ['CEDEAO', 'ZLECAf', 'OMC'],
                    preferential: ['CEDEAO TEC 0%', 'ZLECAf 90% produits']
                },
                business: {
                    strengths: ['Frontière commune', 'CEDEAO', 'Stabilité'], challenges: ['Inflation élevée'],
                    opportunities: ['Transit Nigeria', 'Complémentarité'], entry_strategy: ['Transport routier', 'Distributeurs Accra']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Déficit alimentaire important', requirements: 'FDA Ghana, CEDEAO', competition: 'Forte' }}
            },

            'Nigeria': {
                profile: {
                    gdp: '472.6 milliards USD (2023)', gdpPerCapita: '2 184 USD', growth: '3.2% (2023)',
                    currency: 'Naira (NGN)', population: '218.5 millions', doingBusiness: '131e/190',
                    mainSectors: ['Services (52.7%)', 'Agriculture (22.4%)', 'Industrie (24.9%)'],
                    inflation: '24.1% (2023)', importVolume: '67.8 milliards USD',
                    keyImports: ['Riz', 'Blé', 'Sucre', 'Huile végétale']
                },
                agreements: {
                    bilateral: ['CEDEAO', 'Accord-Cadre CI-Nigeria (2019)'], multilateral: ['CEDEAO', 'ZLECAf', 'OMC'],
                    preferential: ['CEDEAO TEC', 'ZLECAf']
                },
                business: {
                    strengths: ['Plus grand marché africain', 'CEDEAO', 'Pétrole'], challenges: ['Insécurité Nord', 'Volatilité'],
                    opportunities: ['218M habitants', 'Substitution imports'], entry_strategy: ['Lagos focus', 'Distributeurs établis']
                },
                sectors: { 'Agro-alimentaire': { potential: 'EXCEPTIONNEL', details: 'Déficits: riz 4M tonnes, sucre 1.7M tonnes', requirements: 'NAFDAC, halal', competition: 'Très forte' }}
            },

            'Sénégal': {
                profile: {
                    gdp: '28.9 milliards USD (2023)', gdpPerCapita: '1 675 USD', growth: '4.1% (2023)',
                    currency: 'Franc CFA (XOF)', population: '17.2 millions', doingBusiness: '123e/190',
                    mainSectors: ['Services (54.4%)', 'Agriculture (16.4%)', 'Industrie (24.2%)'],
                    inflation: '9.7% (2023)', importVolume: '8.2 milliards USD',
                    keyImports: ['Riz', 'Huile', 'Sucre', 'Blé']
                },
                agreements: {
                    bilateral: ['UEMOA', 'CEDEAO', 'Zone Franc CFA'], multilateral: ['UEMOA', 'CEDEAO', 'OMC'],
                    preferential: ['UEMOA 0% droits', 'CEDEAO TEC']
                },
                business: {
                    strengths: ['Zone Franc', 'Port Dakar', 'Stabilité'], challenges: ['Pouvoir achat limité'],
                    opportunities: ['Hub régional', 'Démographie'], entry_strategy: ['Port Dakar', 'Distribution terrestre']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Déficit riz 800K tonnes', requirements: 'Standards CEDEAO', competition: 'Modérée' }}
            },

            'Mali': {
                profile: {
                    gdp: '19.1 milliards USD (2023)', gdpPerCapita: '875 USD', growth: '3.1% (2023)',
                    currency: 'Franc CFA (XOF)', population: '21.9 millions', doingBusiness: '148e/190',
                    mainSectors: ['Agriculture (38.5%)', 'Services (35.6%)', 'Industrie (19.9%)'],
                    inflation: '2.0% (2023)', importVolume: '4.2 milliards USD',
                    keyImports: ['Produits pétroliers', 'Machines', 'Produits alimentaires']
                },
                agreements: {
                    bilateral: ['UEMOA', 'CEDEAO', 'Zone Franc CFA'], multilateral: ['UEMOA', 'CEDEAO', 'OMC'],
                    preferential: ['UEMOA 0%', 'CEDEAO TEC']
                },
                business: {
                    strengths: ['Zone Franc', 'UEMOA', 'Or'], challenges: ['Instabilité sécuritaire', 'Enclavement'],
                    opportunities: ['Mines', 'Agriculture'], entry_strategy: ['Via Sénégal/CI', 'Partenaires locaux']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN', details: 'Marché limité, insécurité', requirements: 'UEMOA standards', competition: 'Faible' }}
            },

            'Burkina Faso': {
                profile: {
                    gdp: '18.9 milliards USD (2023)', gdpPerCapita: '845 USD', growth: '2.8% (2023)',
                    currency: 'Franc CFA (XOF)', population: '22.4 millions', doingBusiness: '151e/190',
                    mainSectors: ['Agriculture (31.2%)', 'Services (44.2%)', 'Industrie (23.9%)'],
                    inflation: '1.9% (2023)', importVolume: '3.8 milliards USD',
                    keyImports: ['Produits pétroliers', 'Machines', 'Produits alimentaires']
                },
                agreements: {
                    bilateral: ['UEMOA', 'CEDEAO', 'Zone Franc CFA'], multilateral: ['UEMOA', 'CEDEAO', 'OMC'],
                    preferential: ['UEMOA 0%', 'CEDEAO TEC']
                },
                business: {
                    strengths: ['Zone Franc', 'UEMOA', 'Coton'], challenges: ['Enclavement', 'Instabilité'],
                    opportunities: ['Mines', 'Coton'], entry_strategy: ['Via CI', 'Transport routier']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN', details: 'Marché agricole', requirements: 'UEMOA', competition: 'Faible' }}
            },

            // ===== AMÉRIQUE DU NORD =====
            'États-Unis': {
                profile: {
                    gdp: '26 950 milliards USD (2023)', gdpPerCapita: '80 412 USD', growth: '2.5% (2023)',
                    currency: 'Dollar américain (USD)', population: '331.9 millions', doingBusiness: '6e/190',
                    mainSectors: ['Services (80.2%)', 'Industrie (19.1%)', 'Agriculture (0.7%)'],
                    inflation: '4.1% (2023)', importVolume: '3 176 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Noix cajou', 'Caoutchouc', 'Textiles']
                },
                agreements: {
                    bilateral: ['AGOA - African Growth Opportunity Act', 'Traité Investissement CI-USA (1998)'],
                    multilateral: ['OMC', 'Millennium Challenge Corporation'], preferential: ['AGOA - 0% droits 6400+ produits']
                },
                business: {
                    strengths: ['AGOA préférences', 'Marché énorme', 'Diaspora'], challenges: ['FDA/USDA strict', 'Concurrence'],
                    opportunities: ['Produits authentiques', 'E-commerce'], entry_strategy: ['AGOA utilisation', 'Distributeurs ethniques']
                },
                sectors: { 'Agro-alimentaire': { potential: 'TRÈS ÉLEVÉ', details: 'AGOA facilite accès, demande cacao/café', requirements: 'FDA, USDA Organic', competition: 'Très forte' }}
            },

            'Canada': {
                profile: {
                    gdp: '2 140 milliards USD (2023)', gdpPerCapita: '54 966 USD', growth: '1.1% (2023)',
                    currency: 'Dollar canadien (CAD)', population: '38.9 millions', doingBusiness: '23e/190',
                    mainSectors: ['Services (70.2%)', 'Industrie (27.7%)', 'Agriculture (1.6%)'],
                    inflation: '3.9% (2023)', importVolume: '632 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Produits tropicaux']
                },
                agreements: {
                    bilateral: ['Programme Aide Canada-Afrique'], multilateral: ['OMC', 'Commonwealth', 'Francophonie'],
                    preferential: ['SPG Canada', 'Préférences LDC']
                },
                business: {
                    strengths: ['Commonwealth', 'Francophonie', 'Ouverture'], challenges: ['Distance', 'Marché limité'],
                    opportunities: ['Diaspora', 'Produits bio'], entry_strategy: ['Montréal hub', 'Certification bio Canada']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN-ÉLEVÉ', details: 'Marché niche, bio valorisé', requirements: 'CFIA, bio Canada', competition: 'Modérée' }}
            },

            // ===== ASIE-PACIFIQUE =====
            'Chine': {
                profile: {
                    gdp: '17 734 milliards USD (2023)', gdpPerCapita: '12 541 USD', growth: '5.2% (2023)',
                    currency: 'Yuan (CNY)', population: '1.412 milliards', doingBusiness: '46e/190',
                    mainSectors: ['Services (52.8%)', 'Industrie (39.4%)', 'Agriculture (7.8%)'],
                    inflation: '0.2% (2023)', importVolume: '2 693 milliards USD',
                    keyImports: ['Cacao (CI 1er fournisseur)', 'Caoutchouc', 'Bois', 'Minerais']
                },
                agreements: {
                    bilateral: ['FOCAC - Forum Coopération Chine-Afrique', 'Accord Commercial Préférentiel (2021)'],
                    multilateral: ['OMC', 'Initiative Ceinture-Route'], preferential: ['PMA - 97% produits 0%', 'FOCAC préférences']
                },
                business: {
                    strengths: ['1er acheteur cacao CI', 'Investissements massifs', 'BRI'], challenges: ['Normes complexes', 'Langue'],
                    opportunities: ['Classe moyenne', 'E-commerce'], entry_strategy: ['Certification CCC', 'Foires Canton']
                },
                sectors: { 'Agro-alimentaire': { potential: 'EXCEPTIONNEL', details: 'CI = 35% imports cacao chinois', requirements: 'AQSIQ, CIQ', competition: 'Modérée - relations privilégiées' }}
            },

            'Inde': {
                profile: {
                    gdp: '3 736 milliards USD (2023)', gdpPerCapita: '2 612 USD', growth: '6.3% (2023)',
                    currency: 'Roupie (INR)', population: '1.428 milliards', doingBusiness: '63e/190',
                    mainSectors: ['Services (54.4%)', 'Industrie (26.2%)', 'Agriculture (19.4%)'],
                    inflation: '5.4% (2023)', importVolume: '760 milliards USD',
                    keyImports: ['Huiles végétales', 'Or', 'Noix cajou', 'Cacao']
                },
                agreements: {
                    bilateral: ['India-Africa Partnership', 'Ligne Crédit Inde-Afrique 12Mds USD'], multilateral: ['OMC', 'Commonwealth'],
                    preferential: ['GSTP', 'Préférences commerciales Inde-Afrique']
                },
                business: {
                    strengths: ['Marché énorme', 'Croissance forte', 'Commonwealth'], challenges: ['Bureaucratie', 'Normes'],
                    opportunities: ['Classe moyenne 350M', 'Digitalisation'], entry_strategy: ['Mumbai/Delhi', 'E-commerce']
                },
                sectors: { 'Agro-alimentaire': { potential: 'TRÈS ÉLEVÉ', details: 'Déficit huiles 15M tonnes, demande noix cajou', requirements: 'FSSAI, Plant Quarantine', competition: 'Forte' }}
            },

            'Japon': {
                profile: {
                    gdp: '4 940 milliards USD (2023)', gdpPerCapita: '39 285 USD', growth: '1.9% (2023)',
                    currency: 'Yen (JPY)', population: '125.8 millions', doingBusiness: '29e/190',
                    mainSectors: ['Services (69.4%)', 'Industrie (29.1%)', 'Agriculture (1.1%)'],
                    inflation: '3.2% (2023)', importVolume: '720 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Caoutchouc', 'Bois tropicaux']
                },
                agreements: {
                    bilateral: ['TICAD - Conférence Tokyo Développement Afrique'], multilateral: ['OMC', 'G7'],
                    preferential: ['SPG Japon', 'TICAD préférences commerciales']
                },
                business: {
                    strengths: ['Technologie avancée', 'Qualité valorisée', 'TICAD'], challenges: ['Normes très strictes', 'Marché fermé'],
                    opportunities: ['Produits premium', 'Tech'], entry_strategy: ['Partenaires japonais', 'Certification JAS']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN-ÉLEVÉ', details: 'Marché niche, qualité premium', requirements: 'JAS, HACCP, traçabilité', competition: 'Forte' }}
            },

            // ===== MOYEN-ORIENT =====
            'Émirats Arabes Unis': {
                profile: {
                    gdp: '507.5 milliards USD (2023)', gdpPerCapita: '51 475 USD', growth: '3.6% (2023)',
                    currency: 'Dirham (AED)', population: '9.9 millions', doingBusiness: '16e/190',
                    mainSectors: ['Services (51.4%)', 'Industrie (41.2%)', 'Agriculture (7.4%)'],
                    inflation: '4.8% (2023)', importVolume: '350 milliards USD',
                    keyImports: ['Produits alimentaires (85% imports)', 'Cacao', 'Café', 'Épices']
                },
                agreements: {
                    bilateral: ['Partenariat Stratégique EAU-Afrique', 'Fonds Développement Abu Dhabi'], multilateral: ['OMC', 'CCG'],
                    preferential: ['Statut PMA préférences', 'Hub réexportation']
                },
                business: {
                    strengths: ['Hub Moyen-Orient/Afrique', 'Zone franche', 'Infrastructure'], challenges: ['Concurrence', 'Coût vie'],
                    opportunities: ['Réexportation régionale', 'Halal'], entry_strategy: ['Zone franche Dubai', 'Certification halal']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Hub réexportation, marché halal', requirements: 'ESMA, halal, HACCP', competition: 'Intense' }}
            },

            'Arabie Saoudite': {
                profile: {
                    gdp: '833 milliards USD (2023)', gdpPerCapita: '25 266 USD', growth: '0.8% (2023)',
                    currency: 'Riyal (SAR)', population: '35.0 millions', doingBusiness: '62e/190',
                    mainSectors: ['Services (46.7%)', 'Industrie (44.2%)', 'Agriculture (2.4%)'],
                    inflation: '2.3% (2023)', importVolume: '175 milliards USD',
                    keyImports: ['Produits alimentaires', 'Cacao', 'Café', 'Épices']
                },
                agreements: {
                    bilateral: ['Fonds Développement Saoudien Afrique'], multilateral: ['OMC', 'CCG', 'OCI'],
                    preferential: ['Préférences commerciales CCG-Afrique']
                },
                business: {
                    strengths: ['Marché solvable', 'Vision 2030', 'Pétrole'], challenges: ['Normes halal strictes'],
                    opportunities: ['Diversification économique', 'Marché halal'], entry_strategy: ['Certification halal', 'Distributeurs Riyad']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Marché halal, imports alimentaires', requirements: 'SFDA, halal obligatoire', competition: 'Forte' }}
            },

            // ===== AFRIQUE DU NORD =====
            'Maroc': {
                profile: {
                    gdp: '134.2 milliards USD (2023)', gdpPerCapita: '3 582 USD', growth: '3.1% (2023)',
                    currency: 'Dirham (MAD)', population: '37.5 millions', doingBusiness: '53e/190',
                    mainSectors: ['Services (55.2%)', 'Industrie (29.5%)', 'Agriculture (15.3%)'],
                    inflation: '6.1% (2023)', importVolume: '69.8 milliards USD',
                    keyImports: ['Céréales', 'Huiles', 'Sucre', 'Thé', 'Café']
                },
                agreements: {
                    bilateral: ['Accord Commercial Maroc-CEDEAO (négociation)', 'Partenariat Sud-Sud'], multilateral: ['OMC', 'Union Africaine'],
                    preferential: ['Négociations ALE Maroc-CEDEAO']
                },
                business: {
                    strengths: ['Hub Afrique-Europe', 'Stabilité', 'Infrastructure'], challenges: ['Concurrence UE'],
                    opportunities: ['Industrialisation', 'Hub régional'], entry_strategy: ['Casablanca hub', 'SIAM salon']
                },
                sectors: { 'Agro-alimentaire': { potential: 'TRÈS ÉLEVÉ', details: 'Déficits: céréales, huiles, sucre', requirements: 'ONSSA, halal', competition: 'Forte' }}
            },

            'Tunisie': {
                profile: {
                    gdp: '48.3 milliards USD (2023)', gdpPerCapita: '4 024 USD', growth: '0.4% (2023)',
                    currency: 'Dinar tunisien (TND)', population: '12.0 millions', doingBusiness: '78e/190',
                    mainSectors: ['Services (61.6%)', 'Industrie (26.2%)', 'Agriculture (10.1%)'],
                    inflation: '9.3% (2023)', importVolume: '22.1 milliards USD',
                    keyImports: ['Céréales', 'Huiles végétales', 'Sucre', 'Café']
                },
                agreements: {
                    bilateral: ['Accord Commercial Tunisie-Afrique Ouest'], multilateral: ['OMC', 'Union Africaine'],
                    preferential: ['Préférences intra-africaines']
                },
                business: {
                    strengths: ['Proximité Europe', 'Main-œuvre qualifiée'], challenges: ['Instabilité politique'],
                    opportunities: ['Hub Méditerranée', 'Agro-industrie'], entry_strategy: ['Tunis hub', 'Partenaires industriels']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN-ÉLEVÉ', details: 'Imports alimentaires, transformation', requirements: 'Standards tunisiens', competition: 'Modérée' }}
            },

            'Égypte': {
                profile: {
                    gdp: '469.1 milliards USD (2023)', gdpPerCapita: '4 295 USD', growth: '3.8% (2023)',
                    currency: 'Livre égyptienne (EGP)', population: '109.3 millions', doingBusiness: '114e/190',
                    mainSectors: ['Services (52.8%)', 'Industrie (32.8%)', 'Agriculture (11.3%)'],
                    inflation: '33.9% (2023)', importVolume: '89.7 milliards USD',
                    keyImports: ['Céréales', 'Huiles végétales', 'Sucre', 'Thé']
                },
                agreements: {
                    bilateral: ['Coopération Égypte-Afrique Ouest'], multilateral: ['OMC', 'Union Africaine', 'Ligue Arabe'],
                    preferential: ['COMESA préférences']
                },
                business: {
                    strengths: ['Plus grand marché arabe', 'Canal Suez'], challenges: ['Inflation élevée', 'Bureaucratie'],
                    opportunities: ['100M+ habitants', 'Industrie'], entry_strategy: ['Le Caire hub', 'Distributeurs établis']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: '1er importateur mondial blé', requirements: 'Standards égyptiens', competition: 'Très forte' }}
            },

            // ===== AMÉRIQUE LATINE =====
            'Brésil': {
                profile: {
                    gdp: '2 127 milliards USD (2023)', gdpPerCapita: '10 083 USD', growth: '2.9% (2023)',
                    currency: 'Real (BRL)', population: '215.3 millions', doingBusiness: '124e/190',
                    mainSectors: ['Services (63.9%)', 'Industrie (20.7%)', 'Agriculture (15.4%)'],
                    inflation: '4.6% (2023)', importVolume: '287 milliards USD',
                    keyImports: ['Cacao (complément production)', 'Café spécialisé', 'Produits tropicaux']
                },
                agreements: {
                    bilateral: ['Coopération Sud-Sud Brésil-Afrique'], multilateral: ['OMC', 'MERCOSUL', 'BRICS'],
                    preferential: ['MERCOSUL-SADC en négociation']
                },
                business: {
                    strengths: ['Plus grande économie Amérique Sud', 'Lusophonie'], challenges: ['Volatilité économique'],
                    opportunities: ['Coopération Sud-Sud', 'Tech agro'], entry_strategy: ['São Paulo hub', 'Coopération technique']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN', details: 'Niches spécialisées, cacao fine', requirements: 'ANVISA, bio Brésil', competition: 'Locale forte' }}
            },

            'Argentine': {
                profile: {
                    gdp: '487.2 milliards USD (2023)', gdpPerCapita: '10 729 USD', growth: '-1.6% (2023)',
                    currency: 'Peso argentin (ARS)', population: '45.4 millions', doingBusiness: '126e/190',
                    mainSectors: ['Services (61.8%)', 'Industrie (23.1%)', 'Agriculture (6.8%)'],
                    inflation: '211.4% (2023)', importVolume: '76.4 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Thé', 'Épices']
                },
                agreements: {
                    bilateral: ['Coopération Sud-Sud'], multilateral: ['OMC', 'MERCOSUL', 'G20'],
                    preferential: ['MERCOSUL préférences']
                },
                business: {
                    strengths: ['Marché sophistiqué', 'Agriculture développée'], challenges: ['Hyperinflation', 'Instabilité'],
                    opportunities: ['Marché premium', 'Agro-tech'], entry_strategy: ['Buenos Aires', 'Paiements adaptés']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN', details: 'Marché niche, instabilité macro', requirements: 'SENASA', competition: 'Limitée' }}
            },

            // ===== AUTRES PARTENAIRES IMPORTANTS =====
            'Royaume-Uni': {
                profile: {
                    gdp: '3 131 milliards USD (2023)', gdpPerCapita: '46 125 USD', growth: '0.5% (2023)',
                    currency: 'Livre sterling (GBP)', population: '67.9 millions', doingBusiness: '8e/190',
                    mainSectors: ['Services (71.7%)', 'Industrie (18.2%)', 'Agriculture (0.6%)'],
                    inflation: '7.3% (2023)', importVolume: '775 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Thé', 'Épices']
                },
                agreements: {
                    bilateral: ['EPA UK-Afrique Ouest (post-Brexit)', 'UK-Africa Investment Summit'], multilateral: ['OMC', 'Commonwealth'],
                    preferential: ['EPA UK - 0% droits', 'Commonwealth préférences']
                },
                business: {
                    strengths: ['Commonwealth', 'Place financière', 'Anglais'], challenges: ['Post-Brexit ajustements'],
                    opportunities: ['Propre politique commerciale', 'Liens historiques'], entry_strategy: ['Londres hub', 'Commonwealth network']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Post-Brexit opportunités', requirements: 'UK standards', competition: 'Forte' }}
            },

            'Suisse': {
                profile: {
                    gdp: '807 milliards USD (2023)', gdpPerCapita: '92 371 USD', growth: '0.9% (2023)',
                    currency: 'Franc suisse (CHF)', population: '8.7 millions', doingBusiness: '36e/190',
                    mainSectors: ['Services (73.7%)', 'Industrie (25.6%)', 'Agriculture (0.7%)'],
                    inflation: '2.1% (2023)', importVolume: '385 milliards USD',
                    keyImports: ['Cacao (négoce)', 'Café', 'Or', 'Matières premières']
                },
                agreements: {
                    bilateral: ['SECO - Coopération économique Suisse-Afrique'], multilateral: ['OMC', 'AELE'],
                    preferential: ['SPG Suisse', 'SECO préférences']
                },
                business: {
                    strengths: ['Centre négoce matières premières', 'Technologie', 'Qualité'], challenges: ['Marché petit', 'Coûts élevés'],
                    opportunities: ['Trading houses', 'Tech/innovation'], entry_strategy: ['Genève trading', 'Innovation partnerships']
                },
                sectors: { 'Agro-alimentaire': { potential: 'MOYEN-ÉLEVÉ', details: 'Hub négoce, chocolat premium', requirements: 'Standards suisses stricts', competition: 'Spécialisée' }}
            },

            'Turquie': {
                profile: {
                    gdp: '819 milliards USD (2023)', gdpPerCapita: '9 661 USD', growth: '4.5% (2023)',
                    currency: 'Livre turque (TRY)', population: '84.8 millions', doingBusiness: '33e/190',
                    mainSectors: ['Services (54.2%)', 'Industrie (32.0%)', 'Agriculture (6.1%)'],
                    inflation: '64.3% (2023)', importVolume: '364 milliards USD',
                    keyImports: ['Cacao', 'Café', 'Thé', 'Épices', 'Coton']
                },
                agreements: {
                    bilateral: ['Partenariat Turquie-Afrique'], multilateral: ['OMC', 'OCI'],
                    preferential: ['SPG Turquie', 'OCI préférences']
                },
                business: {
                    strengths: ['Pont Europe-Asie-Afrique', 'Industrie développée'], challenges: ['Inflation très forte'],
                    opportunities: ['Hub régional', 'Industrie textile'], entry_strategy: ['Istanbul hub', 'Partenaires industriels']
                },
                sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Industrie alimentaire développée', requirements: 'Standards turcs', competition: 'Forte' }}
            },

'Afrique du Sud': {
    profile: {
        gdp: '420 milliards USD (2023)', gdpPerCapita: '7 055 USD', growth: '0.6% (2023)',
        currency: 'Rand sud-africain (ZAR)', population: '59.3 millions', doingBusiness: '84e/190',
        mainSectors: ['Services (61.4%)', 'Industrie (29.7%)', 'Agriculture (2.8%)'],
        inflation: '6.0% (2023)', importVolume: '108 milliards USD',
        keyImports: ['Machines', 'Produits chimiques', 'Produits alimentaires', 'Textiles']
    },
    agreements: {
        bilateral: ['SADC', 'Accord Tripartite COMESA-EAC-SADC'], multilateral: ['OMC', 'Union Africaine', 'BRICS'],
        preferential: ['SADC libre-échange', 'ZLECAf', 'SPG+']
    },
    business: {
        strengths: ['1ère économie africaine', 'Infrastructure développée', 'Secteur financier avancé'], 
        challenges: ['Lourdeurs administratives', 'Criminalité'],
        opportunities: ['Hub régional Afrique australe', 'Marché sophistiqué'], 
        entry_strategy: ['Johannesburg/Le Cap hub', 'Partenaires locaux expérimentés']
    },
    sectors: { 'Agro-alimentaire': { potential: 'ÉLEVÉ', details: 'Marché sophistiqué, demande produits premium', requirements: 'SABS, HACCP', competition: 'Forte' }}
}
        };

// Fonction helper pour trouver l'ID d'une question
function findQuestionId(questionText) {
    let foundQuestionId = null;
    dimensions.forEach((dimension, dimIndex) => {
        dimension.questions.forEach((question, qIndex) => {
            if (question === questionText) {
                foundQuestionId = `${dimIndex}-${qIndex}`;
            }
        });
    });
    return foundQuestionId;
}

// Fonction helper pour trouver l'ID d'une question
function findQuestionId(questionText) {
    let foundQuestionId = null;
    dimensions.forEach((dimension, dimIndex) => {
        dimension.questions.forEach((question, qIndex) => {
            if (question === questionText) {
                foundQuestionId = `${dimIndex}-${qIndex}`;
            }
        });
    });
    return foundQuestionId;
}

// Transformer les questions en constats négatifs
function transformQuestionToStatement(question) {
    // Pour les certifications avec score 4, ne pas transformer en négatif
    const questionId = findQuestionId(question);
    if (question.includes('certifications qualité') && questionId && currentData.scores[questionId] === 4) {
        return `L'entreprise dispose de certifications qualité reconnues dans ses marchés cibles`;
    }
    
    const transformations = {
                // Production et Logistique
        "Votre entreprise dispose-t-elle d'une capacité de production suffisante pour répondre à une demande export supplémentaire de 30% ?": "L'entreprise ne dispose pas d'une capacité de production suffisante pour répondre à une demande export supplémentaire de 30%",
        "Avez-vous des équipements et infrastructures conformes aux standards internationaux ?": "L'entreprise n'a pas d'équipements et infrastructures conformes aux standards internationaux",
        "Disposez-vous d'un système de gestion des stocks et de planification de production efficace ?": "L'entreprise ne dispose pas d'un système de gestion des stocks et de planification de production efficace",
        "Votre chaîne d'approvisionnement est-elle fiable et diversifiée ?": "La chaîne d'approvisionnement n'est pas fiable et diversifiée",
        "Pouvez-vous garantir des délais de livraison courts et respectés (moins de 30 jours) ?": "L'entreprise ne peut pas garantir des délais de livraison courts et respectés (moins de 30 jours)",

        // Qualité et Conformité
        "Disposez-vous d'un système de traçabilité complet de vos produits ?": "L'entreprise ne dispose pas d'un système de traçabilité complet de ses produits",
        "Disposez-vous de certifications qualité reconnues dans vos marchés cibles ?": "L'entreprise ne dispose pas de certifications qualité reconnues dans ses marchés cibles",
        "Avez-vous un système de contrôle qualité rigoureux à toutes les étapes ?": "L'entreprise n'a pas de système de contrôle qualité rigoureux à toutes les étapes",
        "Vos emballages sont-ils adaptés au transport international et attractifs ?": "Les emballages ne sont pas adaptés au transport international et attractifs",
        "Effectuez-vous régulièrement des tests produits par des laboratoires agréés ?": "L'entreprise n'effectue pas régulièrement des tests produits par des laboratoires agréés",

        // Situation Financière
        "Votre entreprise dispose-t-elle d'une situation financière saine (ratios d'endettement < 70%) ?": "L'entreprise ne dispose pas d'une situation financière saine (ratios d'endettement > 70%)",
        "Avez-vous accès à des financements dédiés à l'export (crédit export, affacturage) ?": "L'entreprise n'a pas accès à des financements dédiés à l'export (crédit export, affacturage)",
        "Pouvez-vous investir au moins 10% de votre CA dans le développement export ?": "L'entreprise ne peut pas investir au moins 10% de son CA dans le développement export",
        "Disposez-vous d'une trésorerie suffisante pour supporter 90 jours de décalage de paiement ?": "L'entreprise ne dispose pas d'une trésorerie suffisante pour supporter 90 jours de décalage de paiement",
        "Votre comptabilité est-elle aux normes internationales (IFRS/OHADA) ?": "La comptabilité n'est pas aux normes internationales (IFRS/OHADA)",

        // Prix et Techniques Commerciales
        "Maîtrisez-vous les Incoterms et leur impact sur vos prix ?": "L'entreprise ne maîtrise pas les Incoterms et leur impact sur les prix",
        "Avez-vous une grille de prix adaptée à chaque marché cible ?": "L'entreprise n'a pas de grille de prix adaptée à chaque marché cible",
        "Connaissez-vous les techniques de paiement international (crédit documentaire, etc.) ?": "L'entreprise ne connaît pas les techniques de paiement international (crédit documentaire, etc.)",
        "Disposez-vous d'outils de couverture contre le risque de change ?": "L'entreprise ne dispose pas d'outils de couverture contre le risque de change",
        "Vos prix sont-ils compétitifs par rapport à la concurrence internationale ?": "Les prix ne sont pas compétitifs par rapport à la concurrence internationale",

        // Expérience et Compétences
        "Votre équipe a-t-elle une expérience du commerce international ?": "L'équipe n'a pas d'expérience du commerce international",
        "Disposez-vous d'un responsable export dédié et formé ?": "L'entreprise ne dispose pas d'un responsable export dédié et formé",
        "Connaissez-vous les réglementations douanières de vos marchés cibles ?": "L'entreprise ne connaît pas les réglementations douanières de ses marchés cibles",
        "Avez-vous déjà participé à des salons internationaux ou missions commerciales ?": "L'entreprise n'a jamais participé à des salons internationaux ou missions commerciales",
        "Maîtrisez-vous les langues de vos marchés cibles (anglais, français, etc.) ?": "L'entreprise ne maîtrise pas les langues de ses marchés cibles (anglais, français, etc.)",

        // Produit et Positionnement
        "Votre produit/service répond-il à un besoin spécifique sur les marchés export ?": "Le produit/service ne répond pas à un besoin spécifique sur les marchés export",
        "Avez-vous adapté votre offre aux goûts et préférences locales ?": "L'entreprise n'a pas adapté son offre aux goûts et préférences locales",
        "Votre marque et communication sont-elles attractives à l'international ?": "La marque et communication ne sont pas attractives à l'international",
        "Disposez-vous d'une protection intellectuelle de vos produits (brevets, marques) ?": "L'entreprise ne dispose pas d'une protection intellectuelle de ses produits (brevets, marques)",
        "Vos produits ont-ils un avantage concurrentiel distinctif ?": "Les produits n'ont pas d'avantage concurrentiel distinctif",

        // Organisation et Processus
        "Vos processus internes sont-ils documentés et optimisés ?": "Les processus internes ne sont pas documentés et optimisés",
        "Disposez-vous d'un système informatique performant (ERP, CRM) ?": "L'entreprise ne dispose pas d'un système informatique performant (ERP, CRM)",
        "Votre service client peut-il gérer des demandes en plusieurs langues ?": "Le service client ne peut pas gérer des demandes en plusieurs langues",
        "Avez-vous des procédures claires pour traiter les commandes export ?": "L'entreprise n'a pas de procédures claires pour traiter les commandes export",
        "Votre équipe est-elle formée aux spécificités du commerce international ?": "L'équipe n'est pas formée aux spécificités du commerce international",

        // Innovation et Développement
        "Investissez-vous régulièrement dans la R&D (au moins 2% du CA) ?": "L'entreprise n'investit pas régulièrement dans la R&D (moins de 2% du CA)",
        "Votre entreprise développe-t-elle de nouveaux produits/services annuellement ?": "L'entreprise ne développe pas de nouveaux produits/services annuellement",
        "Suivez-vous les tendances et innovations de votre secteur ?": "L'entreprise ne suit pas les tendances et innovations de son secteur",
        "Collaborez-vous avec des centres de recherche ou universités ?": "L'entreprise ne collabore pas avec des centres de recherche ou universités",
        "Vos innovations sont-elles protégées et valorisées ?": "Les innovations ne sont pas protégées et valorisées",

        // Réseau et Partenariats
        "Avez-vous des contacts ou partenaires dans vos marchés cibles ?": "L'entreprise n'a pas de contacts ou partenaires dans ses marchés cibles",
        "Participez-vous à des réseaux professionnels internationaux ?": "L'entreprise ne participe pas à des réseaux professionnels internationaux",
        "Disposez-vous de distributeurs ou agents commerciaux fiables ?": "L'entreprise ne dispose pas de distributeurs ou agents commerciaux fiables",
        "Entretenez-vous des relations avec les institutions d'appui à l'export ?": "L'entreprise n'entretient pas de relations avec les institutions d'appui à l'export",
        "Votre réseau LinkedIn/professionnel est-il développé internationalement ?": "Le réseau LinkedIn/professionnel n'est pas développé internationalement",

        // Planification et Stratégie
        "Avez-vous un business plan export formalisé sur 3 ans ?": "L'entreprise n'a pas de business plan export formalisé sur 3 ans",
        "Vos objectifs export sont-ils chiffrés et suivis mensuellement ?": "Les objectifs export ne sont pas chiffrés et suivis mensuellement",
        "Allouez-vous un budget spécifique au développement export ?": "L'entreprise n'alloue pas de budget spécifique au développement export",
        "Effectuez-vous une veille concurrentielle sur vos marchés cibles ?": "L'entreprise n'effectue pas de veille concurrentielle sur ses marchés cibles",
        "Avez-vous défini une stratégie de pénétration par marché ?": "L'entreprise n'a pas défini de stratégie de pénétration par marché"
    };

    return transformations[question] || question;
}

// Générer le diagnostic détaillé
        function generateDetailedDiagnosis() {
            const container = document.getElementById('detailedContainer');
            const results = currentData.results;
            const company = currentData.company;
            const targetCountry = company.targetMarket;
            
            if (!results || !targetCountry) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Diagnostic détaillé indisponible.</strong><br>
                        Veuillez compléter l'évaluation et sélectionner un marché cible.
                    </div>
                `;
                return;
            }
            
            const countryData = countryProfiles[targetCountry];
            // ✅ CORRECTION BUG : Ne plus arrêter si pas de données pays

// Génération du rapport complet avec navigation secondaire
let html = createSecondaryNav(detailedNavItems);

html += `<div id="profil-entreprise" class="anchor-section">`;
html += `<h3 class="anchor-title">🏢 PROFIL ENTREPRISE</h3>`;
html += generateCompanyDiagnosis(company, results, countryData);
html += `</div>`;

// AJOUTER L'ANALYSE DES DÉFAILLANCES CRITIQUES
html += `<div id="defaillances-critiques" class="anchor-section">`;
html += `<h3 class="anchor-title">🚨 DÉFAILLANCES CRITIQUES</h3>`;
html += generateCriticalAnalysisForDetailed(currentData.scores);
html += `</div>`;

// AJOUTER LE PLAN D'ACTION EN DEUXIÈME
const detailedRecommendations = generateSpecificRecommendations(currentData.scores, 'detailed');

if (detailedRecommendations.length > 0) {
    html += `
        <div id="plan-action" class="anchor-section">
            <h3 class="anchor-title">📋 PLAN D'ACTION DÉTAILLÉ</h3>
            <div class="detailed-diagnosis">
            
            <div style="background: #e8f5e8; padding: 20px; border-radius: 15px; margin: 20px 0;">
                <h3>📋 RECOMMANDATIONS SPÉCIFIQUES</h3>
                <p style="color: #2e7d32; margin-bottom: 20px;">
                    Basé sur vos ${detailedRecommendations.length} réponses nécessitant une amélioration immédiate :
                </p>
    `;
    
    detailedRecommendations.forEach((rec, index) => {
        const priorityColor = rec.priority === 'CRITIQUE' ? '#ea4335' : '#ff9900';
        const priorityBg = rec.priority === 'CRITIQUE' ? '#ffebee' : '#fff3e0';
        
        html += `
            <div style="background: ${priorityBg}; padding: 20px; border-radius: 12px; margin: 15px 0; border-left: 5px solid ${priorityColor};">
                <div style="display: flex; align-items: flex-start; margin-bottom: 10px;">
                    <span style="background: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; margin-right: 15px; min-width: 80px; text-align: center;">
                        ${rec.priority}
                    </span>
                    <div style="flex: 1;">
                        <h5 style="color: ${priorityColor}; margin: 0 0 5px 0;">${rec.dimension}</h5>
                        <p style="color: #666; font-size: 13px; margin: 0; font-style: italic;">"${rec.question}"</p>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <h6 style="color: #333; margin-bottom: 10px;">💡 ACTION RECOMMANDÉE :</h6>
                    <p style="margin: 0; color: #444; line-height: 1.5;">${rec.text}</p>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
}

// Afficher les certifications détaillées si disponibles
if (currentData.certificationDetails) {
    let certificationsInfo = '';
    Object.entries(currentData.certificationDetails).forEach(([questionId, details]) => {
        if (details && details.trim()) {
            certificationsInfo = `
                <div class="detailed-diagnosis">
                    <h3>📋 CERTIFICATIONS QUALITÉ ACTUELLES</h3>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; border-left: 5px solid #34a853;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">✅ Certifications possédées par l'entreprise :</h4>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #c8e6c9;">
                            <p style="margin: 0; font-weight: 500; line-height: 1.6;">${details}</p>
                        </div>
                        <p style="margin: 15px 0 0 0; font-size: 0.9em; color: #2e7d32; font-style: italic;">
                            💡 Ces certifications représentent un atout majeur pour l'export
                        </p>
                    </div>
                </div>
            `;
        }
    });
    if (certificationsInfo) {
        html += certificationsInfo;
    }
}

html += `<div id="plan-strategique-detaille" class="anchor-section">`;
html += generateStrategicPlan(company, results, countryData, targetCountry);
html += `</div>`;

// ✅ CORRECTION : Afficher l'analyse pays seulement si données disponibles
html += `<div id="marche-cible" class="anchor-section">`;
html += `<h3 class="anchor-title">🌍 MARCHÉ CIBLE</h3>`;
if (countryData) {
    html += generateCountryProfileAnalysis(targetCountry, countryData, company, results);
} else {
    // Message informatif mais diagnostic continue
    html += `
        <div class="detailed-diagnosis">
            <h2>🌍 ANALYSE DU MARCHÉ ${targetCountry.toUpperCase()}</h2>
            <div class="alert alert-warning" style="background: #fff3e0; border-left: 5px solid #ff9900; padding: 20px; border-radius: 8px;">
                <h4 style="color: #ef6c00;">📊 Données économiques en cours de mise à jour</h4>
                <p>Les informations détaillées pour <strong>${targetCountry}</strong> ne sont pas encore disponibles dans notre base de données.</p>
                <p><strong>📞 Solution :</strong> Contactez ACIEX pour obtenir une analyse personnalisée de ce marché.</p>
                <p><strong>💡 Conseil :</strong> En attendant, concentrez-vous sur le renforcement de vos capacités internes identifiées ci-dessus.</p>
            </div>
        </div>
    `;
}
                        

// Ajouter les services ACIEX RECOMMANDÉS 
html += `<div id="services-aciex" class="anchor-section">`;
html += `<h3 class="anchor-title">🎯 SERVICES ACIEX RECOMMANDÉS</h3>`;
html += generateAciexServicesRecommendations(targetCountry, countryData, company, results);
html += `</div>`;
            
            // SECTION IMPORTATEURS IA en DERNIÈRE POSITION            
            container.innerHTML = html;
            
            // Lancer la recherche d'importateurs en arrière-plan
        }

// Analyse du profil pays (SANS les services ACIEX)
        function generateCountryProfileAnalysis(country, countryData, company, results) {
            return `
                <div class="detailed-diagnosis">
                    <h2>🌍 ANALYSE DU MARCHÉ ${country.toUpperCase()}</h2>
                    
                    <div class="country-overview" style="background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; padding: 25px; border-radius: 15px; margin: 20px 0;">
                        <h3>📊 PROFIL ÉCONOMIQUE DU PAYS</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
                            <div>
                                <h5>💰 Données Économiques</h5>
                                <ul style="list-style: none; padding: 0;">
                                    <li><strong>PIB:</strong> ${countryData.profile.gdp}</li>
                                    <li><strong>PIB/hab:</strong> ${countryData.profile.gdpPerCapita}</li>
                                    <li><strong>Croissance:</strong> ${countryData.profile.growth}</li>
                                    <li><strong>Population:</strong> ${countryData.profile.population}</li>
                                </ul>
                            </div>
                            <div>
                                <h5>📈 Indicateurs Business</h5>
                                <ul style="list-style: none; padding: 0;">
                                    <li><strong>Doing Business:</strong> ${countryData.profile.doingBusiness}</li>
                                    <li><strong>Inflation:</strong> ${countryData.profile.inflation}</li>
                                    <li><strong>Imports:</strong> ${countryData.profile.importVolume}</li>
                                    <li><strong>Monnaie:</strong> ${countryData.profile.currency}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin: 20px 0;">
                        <h3>🤝 ACCORDS COMMERCIAUX ET AVANTAGES</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #34a853;">
                                <h4 style="color: #2e7d32;">✅ Accords Bilatéraux</h4>
                                <ul>
                                    ${countryData.agreements.bilateral.map(accord => `<li>${accord}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #1a73e8;">
                                <h4 style="color: #1565c0;">🌍 Accords Multilatéraux</h4>
                                <ul>
                                    ${countryData.agreements.multilateral.map(accord => `<li>${accord}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #ff9900;">
                                <h4 style="color: #ef6c00;">⭐ Préférences Tarifaires</h4>
                                <ul>
                                    ${countryData.agreements.preferential.map(pref => `<li>${pref}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 25px; border-radius: 15px; margin: 20px 0;">
                        <h3>🎯 POTENTIEL SECTORIEL POUR ${company.sector.toUpperCase()}</h3>
                        ${countryData.sectors[company.sector] ? `
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #4caf50;">
                                <h4>📊 Évaluation Sectorielle</h4>
                                <p><strong>Potentiel:</strong> <span style="color: #2e7d32; font-weight: bold;">${countryData.sectors[company.sector].potential}</span></p>
                                <p><strong>Détails:</strong> ${countryData.sectors[company.sector].details}</p>
                                <p><strong>Exigences:</strong> ${countryData.sectors[company.sector].requirements}</p>
                                <p><strong>Concurrence:</strong> ${countryData.sectors[company.sector].competition}</p>
                            </div>
                        ` : `
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #ff9900;">
                                <h4>⚠️ Secteur non analysé</h4>
                                <p>Les données sectorielles pour <strong>${company.sector}</strong> ne sont pas disponibles dans notre base pour ce pays.</p>
                                <p>Contactez ACIEX pour une analyse sectorielle personnalisée.</p>
                            </div>
                        `}
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 15px; margin: 20px 0; border: 2px solid #1a73e8;">
                        <h3>💼 STRATÉGIE D'ENTRÉE RECOMMANDÉE</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="color: #2e7d32;">💪 Points Forts du Marché</h4>
                                <ul>
                                    ${countryData.business.strengths.map(strength => `<li>${strength}</li>`).join('')}
                                </ul>
                                
                                <h4 style="color: #1a73e8;">🚀 Opportunités</h4>
                                <ul>
                                    ${countryData.business.opportunities.map(opp => `<li>${opp}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 style="color: #ff6d01;">⚠️ Défis à Relever</h4>
                                <ul>
                                    ${countryData.business.challenges.map(challenge => `<li>${challenge}</li>`).join('')}
                                </ul>
                                
                                <h4 style="color: #34a853;">🎯 Stratégie d'Entrée</h4>
                                <ul>
                                    ${countryData.business.entry_strategy.map(strategy => `<li>${strategy}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

// Générer l'analyse des défaillances critiques pour le diagnostic détaillé
function generateCriticalAnalysisForDetailed(scores) {
    const criticalAnalysis = analyzeCriticalQuestions();
    const hasCriticalQuestions = criticalAnalysis.critical.length > 0 || criticalAnalysis.warning.length > 0;

    if (hasCriticalQuestions) {
        let html = `
            <div class="detailed-diagnosis">
                <h2 style="color: #ea4335;">🚨 ALERTE - DÉFAILLANCES CRITIQUES DÉTECTÉES</h2>
                
                <div style="background: #ffebee; padding: 20px; border-radius: 8px; margin: 15px 0; border: 2px solid #ea4335;">
                    <h4 style="color: #ea4335;">🚨 DÉFAILLANCES MAJEURES IDENTIFIÉES</h4>
                    <p style="color: #c62828; font-weight: bold;">Malgré un score global satisfaisant, des faiblesses majeures ont été identifiées sur des questions spécifiques :</p>
        `;

        // DÉFAILLANCES CRITIQUES (Score 1/4)
        if (criticalAnalysis.critical.length > 0) {
            html += `
                <div style="background: #ffcdd2; padding: 15px; border-radius: 6px; margin: 10px 0;">
                    <h5 style="color: #b71c1c;">⛔ DÉFAILLANCES CRITIQUES (Score 1/4) :</h5>
                    <ul style="margin: 10px 0;">
            `;
            
            criticalAnalysis.critical.forEach(item => {
    // Ne pas afficher les certifications si elles sont présentes (score 4)
    const questionId = findQuestionId(item.question);
    if (item.question.includes('certifications qualité') && questionId && currentData.scores[questionId] === 4) {
        return; // Skip cette certification
    }
    
    const statement = transformQuestionToStatement(item.question);
    const dimName = item.dimension.replace(/^\d+\.\s*/, '');
    html += `
        <li style="margin: 8px 0;"><strong>${dimName} :</strong> ${statement}</li>
    `;
});
            
            html += `
                    </ul>
                    <p style="color: #d32f2f; font-weight: bold;">⚠️ URGENCE ABSOLUE : Ces éléments doivent être corrigés avant tout lancement export !</p>
                </div>
            `;
        }

        // FAIBLESSES IMPORTANTES (Score 2/4)
        if (criticalAnalysis.warning.length > 0) {
            html += `
                <div style="background: #ffe0b2; padding: 15px; border-radius: 6px; margin: 10px 0;">
                    <h5 style="color: #e65100;">⚠️ FAIBLESSES IMPORTANTES (Score 2/4) :</h5>
                    <ul style="margin: 10px 0;">
            `;
            
            criticalAnalysis.warning.forEach(item => {
    // Ne pas afficher les certifications si elles sont présentes (score 4)
    const questionId = findQuestionId(item.question);
    if (item.question.includes('certifications qualité') && questionId && currentData.scores[questionId] === 4) {
        return; // Skip cette certification
    }
    
    const statement = transformQuestionToStatement(item.question);
    const dimName = item.dimension.replace(/^\d+\.\s*/, '');
    html += `
        <li style="margin: 8px 0;"><strong>${dimName} :</strong> ${statement}</li>
    `;
});
            
            html += `
                    </ul>
                    <p style="color: #f57c00; font-weight: bold;">📋 PRIORITÉ HAUTE : Amélioration obligatoire avant export.</p>
                </div>
            `;
        }

        html += `
                </div>
            </div>
        `;
        
        return html;
    } else {
        return `
            <div class="detailed-diagnosis">
                <h2>✅ ANALYSE DES RÉPONSES</h2>
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 5px solid #34a853;">
                    <p style="color: #2e7d32;">Aucune défaillance critique identifiée dans vos réponses. Votre profil présente une cohérence satisfaisante pour le développement export.</p>
                </div>
            </div>
        `;
    }
}

        // Analyse détaillée du pays cible
    // Analyse des services ACIEX recommandés selon votre mapping
        function generateAciexServicesRecommendations(country, countryData, company, results) {
            const weakDimensions = results.dimensionScores.filter(d => d.percentage < 70);
            
            // Votre mapping exact des dimensions vers services ACIEX
            const servicesMapping = {
    'Produit': {  // Changé de 'Production' à 'Produit'
        icon: '🟡',
        title: 'Produit et Positionnement',
        description: 'Activités qui améliorent ou adaptent l\'offre exportable aux marchés étrangers.',
        services: [
            'Appui à la définition d\'une offre export adaptée (produit, packaging, normes)',
            'Études de marché ciblées (tendance, demande, concurrence)',
            'Création de visuels et argumentaires produits multilingues',
            'Référencement sur plateformes internationales',
            'Accompagnement à la digitalisation de l\'offre (boutique en ligne)'
        ]
    },
    'Production': {  // Maintenu pour Capacité de Production
        icon: '🔵',
        title: 'Capacité de Production et Logistique',
        description: 'Activités qui permettent à l\'entreprise d\'exporter physiquement ses produits dans de bonnes conditions.',
        services: [
            'Soutien à la sélection de prestataires logistiques (transporteurs, transitaires)',
            'Accompagnement à la constitution des documents d\'exportation',
            'Formation sur les Incoterms et leur application',
            'Mise à disposition d\'un guide des procédures douanières par pays',
            'Conseil sur la gestion des risques liés au transport international',
            'Suivi des commandes export',
            'Coordination des flux logistiques',
            'Intégration d\'un ERP adapté à la gestion export',
            'Création d\'une boutique en ligne adaptée à l\'export',
            'Conseils sur les solutions de livraison transfrontalière'
        ]
    },
    'Qualité': {
        icon: '🟣',
        title: 'Qualité et Conformité',
        description: 'Activités qui garantissent le respect des normes, standards, procédures à l\'international.',
        services: [
            'Vérification de la conformité des documents juridiques aux normes du commerce international',
            'Appui à la rédaction de contrats de vente internationaux',
            'Conseil sur la propriété intellectuelle et la protection des marques',
            'Aide à la constitution des documents export (factures, certificats d\'origine, etc.)',
            'Formation sur les techniques du commerce international',
            'Création de guides pratiques sectoriels et pays',
            'Sensibilisation aux risques juridiques pays par pays',
            'Aide à la sélection de solutions e-commerce conformes (paiement, RGPD, etc.)'
        ]
    },
    'Organisation': {
        icon: '🟤',
        title: 'Organisation et Processus Internes',
        description: 'Activités qui renforcent la structure interne de l\'entreprise pour soutenir l\'activité export.',
        services: [
            'Élaboration d\'un plan d\'actions export personnalisé',
            'Mise en place d\'outils ERP adaptés',
            'Appui au suivi des commandes et des flux',
            'Structuration d\'une cellule export ou d\'un service dédié',
            'Intégration de la gestion documentaire export',
            'Coaching en organisation interne pour internationalisation',
            'Accompagnement dans le choix des marchés cibles (process de décision)'
        ]
    },
    'Financière': {
        icon: '🟢',
        title: 'Situation Financière',
        description: 'Activités qui soutiennent l\'accès aux financements, la sécurité des paiements et la viabilité financière de l\'export.',
        services: [
            'Mise en relation avec les institutions de financement export',
            'Assistance au montage de dossiers de financement ou d\'assurance-crédit',
            'Appui pour l\'accès à des subventions ou garanties à l\'export',
            'Conseil sur les modalités de paiement sécurisées (crédit documentaire, etc.)',
            'Simulation de plan de trésorerie export',
            'Appui au recouvrement des créances à l\'international',
            'Aide à l\'intégration d\'outils ERP de gestion financière export'
        ]
    },
    'Prix': {
        icon: '🔴',
        title: 'Maîtrise des Prix et Techniques Commerciales Export',
        description: 'Activités qui renforcent la capacité de l\'entreprise à vendre efficacement à l\'étranger, au bon prix.',
        services: [
            'Coaching en stratégie de pénétration de marché',
            'Appui à la définition d\'une offre export adaptée (packaging, normes, prix)',
            'Création de visuels marketing adaptés aux marchés cibles',
            'Référencement sur les plateformes internationales de vente B2B/B2C',
            'Formation au marketing digital et au SEO international',
            'Conseils sur les techniques de négociation export',
            'Publication de catalogues produits sur plateformes partenaires',
            'Simulation de politique de prix export'
        ]
    },
    'Expérience': {
        icon: '🟠',
        title: 'Expérience et Compétences Export',
        description: 'Activités qui développent ou mobilisent les compétences spécifiques à l\'export.',
        services: [
            'Réalisation d\'un questionnaire de diagnostic export',
            'Organisation de formations techniques export',
            'Coaching personnalisé pour dirigeants exportateurs',
            'Modules e-learning sur les bonnes pratiques export',
            'Ateliers ou séminaires de formation sectoriels',
            'Assistance à la rédaction de contrats',
            'Appui à la lecture des incoterms et des schémas logistiques'
        ]
    },
    'Innovation': {
        icon: '⚪',
        title: 'Innovation et Développement',
        description: 'Activités qui encouragent l\'innovation, la transformation digitale ou le développement de nouveaux produits/processus.',
        services: [
            'Création d\'une boutique e-commerce adaptée aux marchés internationaux',
            'Formation au marketing digital et à la stratégie e-commerce',
            'Aide à la digitalisation de l\'offre commerciale',
            'Développement d\'une stratégie omnicanale à l\'international',
            'Mise à niveau technologique ou packaging pour marchés porteurs',
            'Sensibilisation à l\'innovation produit ou service export'
        ]
    },
    'Réseau': {
        icon: '🔶',
        title: 'Réseau et Partenariats',
        description: 'Activités qui facilitent les connexions stratégiques pour l\'internationalisation.',
        services: [
            'Organisation de missions commerciales et rencontres B2B',
            'Participation à des foires et salons internationaux',
            'Mise en relation avec des partenaires étrangers (distributeurs, agents, acheteurs)',
            'Appui à l\'implantation à l\'étranger (représentation, bureau local)',
            'Promotion des produits ivoiriens via campagnes et événements',
            'Connexion avec réseaux d\'affaires ou diasporas économiques'
        ]
    },
    'Planification': {
        icon: '🟫',
        title: 'Planification et Stratégie Export',
        description: 'Activités orientées vers la vision à long terme, la structuration de la stratégie export.',
        services: [
            'Diagnostic export avec analyse SWOT',
            'Définition d\'un plan d\'actions export personnalisé',
            'Coaching en stratégie de pénétration de marché',
            'Études de marché pour définir la stratégie pays',
            'Aide à la planification de la chaîne logistique export',
            'Planification de la montée en gamme ou diversification à l\'export'
        ]
    }
};
            
            // Utiliser les questions critiques déjà identifiées (scores 1 ou 2)
            const criticalAnalysis = analyzeCriticalQuestions();
            const criticalDimensions = new Set();

            // Identifier les dimensions qui ont des questions critiques
            criticalAnalysis.critical.forEach(item => {
                criticalDimensions.add(item.dimension);
            });
            criticalAnalysis.warning.forEach(item => {
                criticalDimensions.add(item.dimension);
            });

            // Mapper ces dimensions critiques aux services ACIEX
const recommendedServices = [];
criticalDimensions.forEach(dimensionName => {
    // Nettoyer le nom de dimension (enlever le numéro et les points)
    const cleanDimensionName = dimensionName.replace(/^\d+\.\s*/, '');
    
    // Mapping explicite des dimensions vers les services
    let dimKey = null;
    
    if (cleanDimensionName.includes('Produit')) {
        dimKey = 'Produit';
    } else if (cleanDimensionName.includes('Production') || cleanDimensionName.includes('Logistique')) {
        dimKey = 'Production';
    } else if (cleanDimensionName.includes('Qualité')) {
        dimKey = 'Qualité';
    } else if (cleanDimensionName.includes('Organisation') || cleanDimensionName.includes('Processus')) {
        dimKey = 'Organisation';
    } else if (cleanDimensionName.includes('Financière') || cleanDimensionName.includes('Situation Financière')) {
        dimKey = 'Financière';
    } else if (cleanDimensionName.includes('Prix') || cleanDimensionName.includes('Techniques Commerciales')) {
        dimKey = 'Prix';
    } else if (cleanDimensionName.includes('Expérience') || cleanDimensionName.includes('Compétences')) {
        dimKey = 'Expérience';
    } else if (cleanDimensionName.includes('Innovation')) {
        dimKey = 'Innovation';
    } else if (cleanDimensionName.includes('Réseau') || cleanDimensionName.includes('Partenariats')) {
        dimKey = 'Réseau';
    } else if (cleanDimensionName.includes('Planification') || cleanDimensionName.includes('Stratégie')) {
        dimKey = 'Planification';
    }
    
    if (dimKey && servicesMapping[dimKey]) {
        const dimensionScore = results.dimensionScores.find(d => d.name === dimensionName);
        
        // Vérifier que dimensionScore existe avant de l'ajouter
        if (dimensionScore) {
            recommendedServices.push({
                dimension: dimensionScore,
                service: servicesMapping[dimKey]
            });
        } else {
            console.warn('Dimension non trouvée:', dimensionName);
        }
    } else {
        console.warn('Service mapping non trouvé pour:', cleanDimensionName);
    }
});
            
            // Si aucune faiblesse majeure, proposer services de développement
            if (recommendedServices.length === 0) {
                recommendedServices.push({
                    dimension: { name: 'Développement', percentage: 85 },
                    service: servicesMapping['Réseau']
                });
            }
            
            return `
                <div class="detailed-diagnosis">
                    <h2>🎯 SERVICES ACIEX RECOMMANDÉS - MARCHÉ ${country.toUpperCase()}</h2>
                    
                    <div class="services-overview" style="background: linear-gradient(135deg, #2e7d32, #388e3c); color: white; padding: 25px; border-radius: 15px; margin: 20px 0;">
                        <h3>🏆 ACCOMPAGNEMENT PERSONNALISÉ SELON VOS BESOINS</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
                            <div>
                                <h5>📊 Votre Profil Export</h5>
                                <ul style="list-style: none; padding: 0;">
                                    <li>🏢 <strong>Entreprise:</strong> ${company.companyName}</li>
                                    <li>🏭 <strong>Secteur:</strong> ${company.sector}</li>
                                    <li>🎯 <strong>Marché cible:</strong> ${country}</li>
                                    <li>📈 <strong>Score global:</strong> ${results.adjustedScore}%</li>
                                </ul>
                            </div>
                            <div>
                                <h5>🎯 Services Adaptés</h5>
                                <ul style="list-style: none; padding: 0;">
                                    <li>📋 <strong>Dimensions à renforcer:</strong> ${weakDimensions.length}/10</li>
                                    <li>✅ <strong>Services recommandés:</strong> ${recommendedServices.length}</li>
                                    <li>🎯 <strong>Niveau actuel:</strong> ${results.level}</li>
                                    <li>🚀 <strong>Accompagnement:</strong> Sur-mesure</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    ${recommendedServices.map(item => `
                        <div style="background: white; padding: 25px; border-radius: 12px; margin: 20px 0; border-left: 6px solid #2e7d32; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <span style="font-size: 2em; margin-right: 15px;">${item.service.icon}</span>
                                <div>
                                    <h4 style="color: #2e7d32; margin: 0;">${item.service.title}</h4>
                                    <p style="color: #666; margin: 5px 0 0 0; font-style: italic;">${item.service.description}</p>
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <h5 style="color: #1b5e20; margin-bottom: 15px;">🎯 Nos services pour renforcer cette dimension :</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">
                                    ${item.service.services.map(service => `
                                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #4caf50;">
                                            <span style="color: #2e7d32;">✓ ${service}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                                <p style="color: #2e7d32; margin-bottom: 15px;"><strong>Score actuel: ${item.dimension.percentage}% - Potentiel d'amélioration identifié</strong></p>
                            </div>
                        </div>
                    `).join('')}
                    
                </div>
            `;
        }

// Génération de la section importateurs (placeholder initial)
        function generateImportersSection(company) {
            const targetCountries = company.currentMarkets && company.currentMarkets.length > 0 
                ? company.currentMarkets 
                : company.targetMarket ? [company.targetMarket] : [];

            if (targetCountries.length === 0) {
                return `
                    <div id="importersSection" class="detailed-diagnosis" style="margin-top: 40px;">
                        <h2>🌍 IMPORTATEURS POTENTIELS</h2>
                        <div class="alert alert-warning">
                            <strong>Aucun marché cible spécifié.</strong><br>
                            Veuillez renseigner vos marchés actuels ou votre marché cible pour obtenir une liste d'importateurs potentiels.
                        </div>
                    </div>
                `;
            }

            return `
                <div id="importersSection" class="detailed-diagnosis" style="margin-top: 40px;">
                    <h2>🌍 IMPORTATEURS POTENTIELS - ${company.sector.toUpperCase()}</h2>
                    
                    <div style="background: linear-gradient(135deg, #ff6b35, #ff8c42); color: white; padding: 25px; border-radius: 15px; margin: 20px 0;">
                        <h3>🤖 RECHERCHE IA EN COURS...</h3>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                            <div class="spinner" style="border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; width: 30px; height: 30px;"></div>
                            <div>
                                <p style="margin: 0; font-size: 1.1em;">Analyse des importateurs dans vos marchés cibles...</p>
                                <small>Secteur: ${company.sector} | Pays: ${targetCountries.slice(0, 3).join(', ')}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="importersResults" style="min-height: 100px;">
                        <!-- Les résultats apparaîtront ici -->
                    </div>
                </div>
            `;
        }

        // Lancer la recherche d'importateurs
        async function generateImportersList(company) {
            const targetCountries = company.currentMarkets && company.currentMarkets.length > 0 
                ? company.currentMarkets 
                : company.targetMarket ? [company.targetMarket] : [];

            if (targetCountries.length === 0) return;

            try {
                console.log('🚀 Lancement recherche importateurs...');
                
                // Simuler un délai de recherche
                setTimeout(async () => {
                    const importersList = await importersAI.generateImportersList(company, targetCountries);
                    displayImportersResults(importersList);
                }, 3000); // 3 secondes de "recherche"

            } catch (error) {
                console.error('❌ Erreur recherche importateurs:', error);
                displayImportersError();
            }
        }

        // Afficher les résultats d'importateurs
        function displayImportersResults(importersList) {
            const resultsContainer = document.getElementById('importersResults');
            if (!resultsContainer || !importersList) return;

            // Cacher le loader
            const loadingSection = resultsContainer.previousElementSibling;
            if (loadingSection) {
                loadingSection.style.display = 'none';
            }

            let html = `
                <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #4caf50;">
                    <h4 style="color: #2e7d32; margin-bottom: 15px;">✅ RECHERCHE TERMINÉE</h4>
                    <p><strong>Secteur analysé:</strong> ${importersList.sector}</p>
                    <p><strong>Pays étudiés:</strong> ${importersList.countries.join(', ')}</p>
                    <p><strong>Entreprises identifiées:</strong> ${importersList.companies.length}</p>
                    <p><strong>Date de recherche:</strong> ${importersList.generatedAt}</p>
                </div>

                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ff9900;">
                    <p style="color: #ef6c00; margin: 0;"><strong>⚠️ Avertissement:</strong> ${importersList.disclaimer}</p>
                </div>
            `;

            if (importersList.companies.length > 0) {
                html += `
                    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px 0;">
                        <div style="background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; padding: 20px;">
                            <h4 style="margin: 0;">📊 LISTE DES IMPORTATEURS IDENTIFIÉS</h4>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0; text-align: left; font-weight: bold;">🏢 Entreprise</th>
                                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0; text-align: left; font-weight: bold;">🌍 Pays</th>
                                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0; text-align: left; font-weight: bold;">📞 Contact</th>
                                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0; text-align: left; font-weight: bold;">🏭 Secteur</th>
                                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0; text-align: left; font-weight: bold;">📏 Taille</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                importersList.companies.forEach((company, index) => {
                    const rowColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    html += `
                        <tr style="background: ${rowColor};">
                            <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; font-weight: 600;">${company.name}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${company.country}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; color: #1a73e8;">${company.contact}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${company.sector}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${company.size}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // Actions recommandées
            html += `
                <div style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center;">
                    <h4>🎯 ÉTAPES SUIVANTES RECOMMANDÉES</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <button style="background: white; color: #4caf50; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            📋 Valider les contacts
                        </button>
                        <button style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            📧 Préparer approche
                        </button>
                        <button style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            🤝 Accompagnement ACIEX
                        </button>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                        💡 ACIEX peut vous accompagner dans la validation de ces contacts et la préparation de votre approche commerciale
                    </p>
                </div>
            `;

            resultsContainer.innerHTML = html;
        }

        // Afficher une erreur si la recherche échoue
        function displayImportersError() {
            const resultsContainer = document.getElementById('importersResults');
            if (!resultsContainer) return;

            const loadingSection = resultsContainer.previousElementSibling;
            if (loadingSection) {
                loadingSection.style.display = 'none';
            }

            resultsContainer.innerHTML = `
                <div class="alert alert-error" style="background: #ffebee; border-left: 5px solid #ea4335; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #c62828; margin-bottom: 10px;">❌ Recherche temporairement indisponible</h4>
                    <p>Le service de recherche d'importateurs IA n'est pas disponible actuellement.</p>
                    <p><strong>Solution:</strong> Contactez directement ACIEX pour obtenir une liste personnalisée d'importateurs potentiels dans vos marchés cibles.</p>
                    <button style="background: #ea4335; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 15px;">
                        📞 Contacter ACIEX
                    </button>
                </div>
            `;
        }

        // Diagnostic spécifique de l'entreprise
        function generateCompanyDiagnosis(company, results, countryData) {
            const criticalDimensions = results.dimensionScores.filter(d => d.percentage < 30);
            const readinessFactor = calculateMarketReadiness(results, countryData, company.sector);
            const riskProfile = assessExportRisks(results, countryData, company);
            
            return `
                <div class="company-specific-diagnosis" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin: 20px 0;">
                    <h3>🏢 DIAGNOSTIC SPÉCIFIQUE - ${company.companyName.toUpperCase()}</h3>
                    
                    <div class="readiness-assessment" style="background: white; padding: 20px; border-radius: 12px; margin: 15px 0; border: 2px solid ${readinessFactor.color};">
                        <h4 style="color: ${readinessFactor.color};">🎯 NIVEAU DE PRÉPARATION EXPORT</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin: 15px 0;">
                            <div style="text-align: center;">
                                <div style="font-size: 3em; font-weight: bold; color: ${readinessFactor.color};">${readinessFactor.score}%</div>
                                <div style="font-size: 1.2em; font-weight: bold; color: ${readinessFactor.color};">${readinessFactor.level}</div>
                                <div style="margin-top: 10px;">Délai estimé: <strong>${readinessFactor.timeline}</strong></div>
                            </div>
                            <div>
                                <p><strong>Évaluation:</strong> ${readinessFactor.assessment}</p>
                                <p><strong>Facteurs limitants:</strong> ${readinessFactor.limitingFactors.join(', ')}</p>
                                
                            </div>
                        </div>
                    </div>
                    
                    <div class="risk-matrix" style="background: white; padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <h4>⚠️ MATRICE DES RISQUES EXPORT</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0;">
                            ${riskProfile.map(risk => `
                                <div style="background: ${risk.severity === 'ÉLEVÉ' ? '#ffebee' : risk.severity === 'MOYEN' ? '#fff3e0' : '#e8f5e8'}; 
                                          padding: 15px; border-radius: 8px; border-left: 4px solid ${risk.severity === 'ÉLEVÉ' ? '#ea4335' : risk.severity === 'MOYEN' ? '#ff9900' : '#34a853'};">
                                    <h5 style="color: ${risk.severity === 'ÉLEVÉ' ? '#ea4335' : risk.severity === 'MOYEN' ? '#ff9900' : '#34a853'};">
                                        ${risk.category} - ${risk.severity}
                                    </h5>
                                    <p><strong>Description:</strong> ${risk.description}</p>
                                    <p><strong>Impact:</strong> ${risk.impact}</p>
                                    <p><strong>Mitigation:</strong> ${risk.mitigation}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
<div class="improvement-opportunities" style="background: white; padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <h4 style="color: #ff9900;">⚡ POTENTIEL D'AMÉLIORATION</h4>
                        ${generateImprovementPlan(results, countryData, company)}
                    </div>
                </div>
            `;
        }

// Fonction pour expliquer l'ajustement sectoriel
function getAdjustmentExplanation(sector, rawScore, adjustedScore) {
    const difference = adjustedScore - rawScore;
    const isPositive = difference > 0;
    const absDifference = Math.abs(difference);
    
    // Coefficients sectoriels pour référence
    const sectorAdvantages = {
        'Agriculture': { advantage: true, reason: 'avantages naturels de la Côte d\'Ivoire' },
        'Agroforesterie': { advantage: true, reason: 'expertise reconnue en agroforesterie' },
        'Mines et Métaux': { advantage: true, reason: 'richesses minières du pays' },
        'Pétrole et Gaz': { advantage: true, reason: 'secteur énergétique développé' },
        'Agro-alimentaire': { advantage: false, reason: 'secteur neutre' },
        'Pharmaceutique': { advantage: true, reason: 'développement du secteur pharmaceutique ivoirien' },
        'Cosmétiques': { advantage: true, reason: 'matières premières naturelles disponibles' },
        'Textile': { advantage: false, reason: 'concurrence internationale forte' },
        'Confection': { advantage: false, reason: 'défis de compétitivité face à l\'Asie' },
        'Artisanat': { advantage: false, reason: 'marché de niche' },
        'Bois et Ameublement': { advantage: true, reason: 'ressources forestières' },
        'Matériaux de Construction': { advantage: false, reason: 'marché local principalement' },
        'Chimie et Parachimie': { advantage: false, reason: 'secteur nécessitant des investissements lourds' },
        'Électronique': { advantage: false, reason: 'concurrence technologique intense' },
        'Mécanique': { advantage: false, reason: 'secteur nécessitant une expertise technique avancée' },
        'Transport et Logistique': { advantage: true, reason: 'position géographique stratégique' },
        'Services Financiers': { advantage: false, reason: 'marché en développement' },
        'Tourisme': { advantage: false, reason: 'potentiel mais infrastructure à développer' },
        'BTP': { advantage: false, reason: 'marché principalement domestique' },
        'Énergie Renouvelable': { advantage: true, reason: 'potentiel solaire et éolien important' }
    };
    
    const sectorInfo = sectorAdvantages[sector] || { advantage: false, reason: 'secteur non évalué spécifiquement' };
    
    if (isPositive) {
        return `Votre score a été bonifié de +${absDifference} points grâce aux ${sectorInfo.reason}. 
                Le secteur "${sector}" bénéficie d'avantages comparatifs qui facilitent l'export depuis la Côte d'Ivoire.`;
    } else {
        return `Votre score a été ajusté de ${difference} points car le secteur "${sector}" fait face à ${sectorInfo.reason}. 
                Cet ajustement reflète les défis spécifiques de votre secteur sur les marchés internationaux.`;
    }
}

        // Plan stratégique détaillé
        function generateStrategicPlan(company, results, countryData, targetCountry) {
            const timeline = generateDetailedTimeline(results, countryData, company);
            const investment = calculateDetailedInvestment(results, countryData, company);
            const kpis = defineKPIs(results, countryData, company);
            
            return `
                <div class="strategic-plan" style="background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; padding: 25px; border-radius: 15px; margin: 20px 0;">
                    <h3>📋 PLAN STRATÉGIQUE DÉTAILLÉ - EXPORT VERS ${targetCountry.toUpperCase()}</h3>
                    
                    <div class="timeline-section" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <h4>⏰ FEUILLE DE ROUTE STRATÉGIQUE</h4>
                        ${timeline}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                            <h4>💰 PLAN D'INVESTISSEMENT</h4>
                            ${investment}
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                            <h4>📊 INDICATEURS DE PERFORMANCE</h4>
                            ${kpis}
                        </div>
                    </div>
                    
                    <div class="success-factors" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <h4>🎯 FACTEURS CLÉS DE SUCCÈS</h4>
                        ${generateSuccessFactors(results, countryData, company)}
                    </div>
                </div>
            `;
        }

        // Fonctions utilitaires pour le diagnostic détaillé
        
        function calculateMarketReadiness(results, countryData, sector) {
            const baseScore = results.adjustedScore;
            const sectorInfo = countryData?.sectors?.[sector];

            
            // Ajustement selon le potentiel sectoriel
            let sectorAdjustment = 0;
            if (sectorInfo) {
                switch(sectorInfo.potential) {
                    case 'EXCEPTIONNEL': sectorAdjustment = 10; break;
                    case 'TRÈS ÉLEVÉ': sectorAdjustment = 7; break;
                    case 'ÉLEVÉ': sectorAdjustment = 5; break;
                    case 'MOYEN-ÉLEVÉ': sectorAdjustment = 2; break;
                    case 'MOYEN': sectorAdjustment = 0; break;
                    case 'FAIBLE': sectorAdjustment = -5; break;
                }
            }
            
            const adjustedScore = Math.min(100, Math.max(0, baseScore + sectorAdjustment));
            
            let level, color, timeline, assessment, limitingFactors = [], advantages = [];
            
            // Identifier les facteurs limitants et avantages
            results.dimensionScores.forEach(dim => {
                if (dim.percentage < 40) {
                    limitingFactors.push(dim.name.split(' ')[0]);
                } else if (dim.percentage >= 80) {
                    advantages.push(dim.name.split(' ')[0]);
                }
            });
            
            if (adjustedScore >= 85) {
                level = 'EXCELLENT - PRÊT IMMÉDIAT';
                color = '#34a853';
                timeline = '0-3 mois';
                assessment = 'Entreprise parfaitement préparée avec tous les prérequis maîtrisés. Lancement export immédiat possible.';
            } else if (adjustedScore >= 70) {
                level = 'BON - PRÊT SOUS CONDITIONS';
                color = '#1a73e8';
                timeline = '3-6 mois';
                assessment = 'Solides fondations avec quelques ajustements nécessaires avant le lancement.';
            } else if (adjustedScore >= 55) {
                level = 'MOYEN - PRÉPARATION REQUISE';
                color = '#ff9900';
                timeline = '6-12 mois';
                assessment = 'Potentiel identifié mais développement structuré indispensable avant export.';
            } else if (adjustedScore >= 40) {
                level = 'FAIBLE - CONSOLIDATION URGENTE';
                color = '#ff5722';
                timeline = '12-18 mois';
                assessment = 'Bases insuffisantes. Programme de renforcement majeur requis.';
            } else {
                level = 'CRITIQUE - RESTRUCTURATION';
                color = '#ea4335';
                timeline = '18-24 mois';
                assessment = 'Défaillances structurelles majeures. Refonte complète des capacités nécessaire.';
            }
            
            return {
                score: adjustedScore,
                level,
                color,
                timeline,
                assessment,
                limitingFactors: limitingFactors.length > 0 ? limitingFactors : ['Aucun facteur critique'],
                advantages: advantages.length > 0 ? advantages : ['Développement équilibré']
            };
        }
        
        function assessExportRisks(results, countryData, company) {
            const risks = [];
            
            // Risque capacité de production
            const productionDim = results.dimensionScores.find(d => d.name.includes('Production'));
            if (productionDim && productionDim.percentage < 50) {
                risks.push({
                    category: 'CAPACITÉ PRODUCTION',
                    severity: productionDim.percentage < 30 ? 'ÉLEVÉ' : 'MOYEN',
                    description: 'Capacité insuffisante pour honorer commandes export importantes',
                    impact: 'Ruptures de stock, pénalités, perte clients',
                    mitigation: 'Audit capacité, plan investissement, partenariat co-production'
                });
            }
            
            // Risque qualité/conformité
            const qualityDim = results.dimensionScores.find(d => d.name.includes('Qualité'));
            if (qualityDim && qualityDim.percentage < 60) {
                risks.push({
                    category: 'CONFORMITÉ QUALITÉ',
                    severity: qualityDim.percentage < 40 ? 'ÉLEVÉ' : 'MOYEN',
                    description: 'Non-conformité aux standards du marché cible',
                    impact: 'Rejet produits, amendes, exclusion marché',
                    mitigation: 'Certification urgente, audit qualité externe, formation équipes'
                });
            }
            
            // Risque financier
            const financeDim = results.dimensionScores.find(d => d.name.includes('Financière'));
            if (financeDim && financeDim.percentage < 55) {
                risks.push({
                    category: 'SOLIDITÉ FINANCIÈRE',
                    severity: financeDim.percentage < 35 ? 'ÉLEVÉ' : 'MOYEN',
                    description: 'Insuffisance fonds de roulement pour cycles export',
                    impact: 'Incapacité honorer commandes, cessation activité',
                    mitigation: 'Renforcement capitaux, crédit export, affacturage'
                });
            }
            
            // Risque expérience
            const experienceDim = results.dimensionScores.find(d => d.name.includes('Expérience'));
            if (experienceDim && experienceDim.percentage < 50) {
                risks.push({
                    category: 'INEXPÉRIENCE EXPORT',
                    severity: 'MOYEN',
                    description: 'Manque d\'expertise commerce international',
                    impact: 'Erreurs coûteuses, échecs commerciaux, litiges',
                    mitigation: 'Recrutement expert, formation, conseil spécialisé'
                });
            }
            
            // Risque pays (basé sur les données du pays)
            if (countryData?.business?.challenges?.some(c => c.includes('instabilité') || c.includes('corruption'))) {
                risks.push({
                    category: 'RISQUE PAYS',
                    severity: 'MOYEN',
                    description: 'Instabilité politique/économique du marché cible',
                    impact: 'Pertes commerciales, difficultés recouvrement',
                    mitigation: 'Assurance-crédit export, paiement sécurisé, diversification'
                });
            }
            
            return risks.length > 0 ? risks : [{
                category: 'PROFIL ÉQUILIBRÉ',
                severity: 'FAIBLE',
                description: 'Aucun risque majeur identifié',
                impact: 'Développement export dans conditions favorables',
                mitigation: 'Maintenir vigilance et amélioration continue'
            }];
        }
        
        function getCriticalActionPlan(dimensionName, countryData, sector) {
            const plans = {
                'Qualité': {
                    impact: 'Rejet systématique produits, exclusion marché, amendes réglementaires',
                    actions: ['Audit qualité externe immédiat', 'Certification ISO 9001/secteur', 'Formation équipes QA', 'Équipements contrôle'],
                    budget: '800K-3M FCFA',
                    timeline: '3-6 mois'
                },
                'Prix': {
                    impact: 'Erreurs pricing fatales, litiges paiement, pertes change massives',
                    actions: ['Formation Incoterms intensive', 'Développement grilles prix', 'Couverture risque change', 'Processus paiement sécurisé'],
                    budget: '300K-1M FCFA',
                    timeline: '1-3 mois'
                },
                'Financière': {
                    impact: 'Rupture trésorerie, incapacité honorer commandes, faillite',
                    actions: ['Renforcement capitaux urgents', 'Négociation crédit export', 'Mise en place affacturage', 'Contrôle gestion renforcé'],
                    budget: '2-10M FCFA',
                    timeline: '2-4 mois'
                },
                'Production': {
                    impact: 'Ruptures stock chroniques, pénalités retard, perte clients majeurs',
                    actions: ['Audit capacité immédiat', 'Plan investissement équipements', 'Optimisation processus', 'Formation productivité'],
                    budget: '5-20M FCFA',
                    timeline: '4-8 mois'
                },
                'Expérience': {
                    impact: 'Échecs commerciaux coûteux, non-conformités, litiges internationaux',
                    actions: ['Recrutement responsable export', 'Formation direction CI', 'Conseil expert externe', 'Missions terrain'],
                    budget: '2-8M FCFA/an',
                    timeline: '1-6 mois'
                }
            };
            
            const key = Object.keys(plans).find(k => dimensionName.includes(k)) || 'Qualité';
            return plans[key];
        }
        
        function generateImprovementPlan(results, countryData, company) {
            const improvements = [];
            const moderateDimensions = results.dimensionScores.filter(d => d.percentage >= 30 && d.percentage < 70);
            
            moderateDimensions.slice(0, 3).forEach(dim => {
                const improvement = {
                    dimension: dim.name.replace(/^\d+\.\s*/, ''),
                    current: dim.percentage,
                    target: Math.min(85, dim.percentage + 20),
                    priority: dim.percentage < 50 ? 'HAUTE' : 'MOYENNE',
                    timeline: dim.percentage < 50 ? '3-6 mois' : '6-12 mois'
                };
                
                improvements.push(`
                    <div style="background: white; padding: 12px; border-radius: 6px; margin: 8px 0; border-left: 3px solid ${improvement.priority === 'HAUTE' ? '#ff9900' : '#1a73e8'};">
                        <strong>${improvement.dimension}</strong> (${improvement.current}% → ${improvement.target}%)
                        <br><small>Priorité: ${improvement.priority} | Délai: ${improvement.timeline}</small>
                    </div>
                `);
            });
            
            return improvements.join('');
        }
        
        function generateDetailedTimeline(results, countryData, company) {
            const score = results.adjustedScore;
            let phases = [];
            
            if (score >= 70) {
                phases = [
                    { phase: 'PHASE 1', period: 'Mois 1-2', title: 'Finalisation Préparatifs', tasks: ['Documentation commerciale', 'Certifications finales', 'Échantillonnage'] },
                    { phase: 'PHASE 2', period: 'Mois 2-4', title: 'Prospection Active', tasks: ['Participation salons', 'Missions commerciales', 'Négociations distributeurs'] },
                    { phase: 'PHASE 3', period: 'Mois 4-6', title: 'Premiers Contrats', tasks: ['Signature accords', 'Livraisons pilotes', 'Ajustements opérationnels'] },
                    { phase: 'PHASE 4', period: 'Mois 6+', title: 'Montée en Puissance', tasks: ['Développement volumes', 'Extension gamme', 'Consolidation partenariats'] }
                ];
            } else if (score >= 50) {
                phases = [
                    { phase: 'PHASE 1', period: 'Mois 1-4', title: 'Renforcement Capacités', tasks: ['Formation équipes', 'Mise aux normes', 'Processus qualité'] },
                    { phase: 'PHASE 2', period: 'Mois 4-8', title: 'Préparation Marché', tasks: ['Étude marché approfondie', 'Adaptation produits', 'Stratégie prix'] },
                    { phase: 'PHASE 3', period: 'Mois 8-12', title: 'Tests Marché', tasks: ['Échantillonnage', 'Prospection sélective', 'Validation concept'] },
                    { phase: 'PHASE 4', period: 'Mois 12+', title: 'Lancement Commercial', tasks: ['Entrée marché', 'Premiers clients', 'Optimisation continue'] }
                ];
            } else {
                phases = [
                    { phase: 'PHASE 1', period: 'Mois 1-6', title: 'Consolidation Interne', tasks: ['Audit complet', 'Plan redressement', 'Investissements prioritaires'] },
                    { phase: 'PHASE 2', period: 'Mois 6-12', title: 'Développement Capacités', tasks: ['Formation intensive', 'Certifications', 'Systèmes qualité'] },
                    { phase: 'PHASE 3', period: 'Mois 12-18', title: 'Préparation Export', tasks: ['Veille concurrentielle', 'Adaptation offre', 'Partenariats stratégiques'] },
                    { phase: 'PHASE 4', period: 'Mois 18+', title: 'Démarrage Export', tasks: ['Prospection pilote', 'Tests marché', 'Premiers contrats'] }
                ];
            }
            
            return phases.map(phase => `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid white;">
                    <h5 style="margin-bottom: 5px;">${phase.phase} - ${phase.title} (${phase.period})</h5>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${phase.tasks.map(task => `<li>${task}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }
        
        function calculateDetailedInvestment(results, countryData, company) {
            const score = results.adjustedScore;
            const sector = company.sector;
            
            const baseBudgets = {
                preparation: score < 50 ? 3000000 : score < 70 ? 1500000 : 800000,
                marketing: score < 50 ? 2000000 : score < 70 ? 1200000 : 800000,
                operations: score < 50 ? 5000000 : score < 70 ? 3000000 : 1500000,
                certification: score < 50 ? 2500000 : score < 70 ? 1800000 : 1000000
            };
            
            // ✅ MULTIPLICATEURS D'INVESTISSEMENT
// Reflètent les coûts relatifs de développement par secteur  
// > 1.0 = Secteur coûteux (équipements, formations, certifications)
// < 1.0 = Secteur accessible (investissements limités)
const investmentMultipliers = {
                'Technologie': 1.3,
                'Pharmaceutique': 1.5,
                'Agro-alimentaire': 1.2,
                'Textile': 1.0,
                'Artisanat': 0.8
            };
            
            const multiplier = investmentMultipliers[sector] || 1.0;
            
            return `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h5>💰 Répartition Budgétaire</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li>🔧 Préparation/Formation: ${Math.round(baseBudgets.preparation * multiplier / 1000)}K FCFA</li>
                        <li>📢 Marketing/Commercial: ${Math.round(baseBudgets.marketing * multiplier / 1000)}K FCFA</li>
                        <li>⚙️ Opérations/Logistique: ${Math.round(baseBudgets.operations * multiplier / 1000)}K FCFA</li>
                        <li>📋 Certifications/Conformité: ${Math.round(baseBudgets.certification * multiplier / 1000)}K FCFA</li>
                    </ul>
                    <hr style="border-color: rgba(255,255,255,0.3); margin: 15px 0;">
                    <h5>💯 Total Investissement: ${Math.round((baseBudgets.preparation + baseBudgets.marketing + baseBudgets.operations + baseBudgets.certification) * multiplier / 1000000)}M FCFA</h5>
                    <p><small>ROI attendu: 200-400% sur 2-3 ans</small></p>
                </div>
            `;
        }
        
        function defineKPIs(results, countryData, company) {
            const score = results.adjustedScore;
            
            const kpis = {
                preparation: {
                    '6 mois': score >= 70 ? '95%' : score >= 50 ? '85%' : '70%',
                    '12 mois': '98%'
                },
                commercial: {
    'Prospects qualifiés': score >= 70 ? '10-15' : score >= 50 ? '8-12' : '5-8',
    'Premiers contrats': score >= 70 ? '6-12 mois' : score >= 50 ? '12-18 mois' : '18-24 mois'
},
                financial: {
                    'CA export Y1': score >= 70 ? '15-25%' : score >= 50 ? '10-20%' : '5-15%',
                    'CA export Y3': score >= 70 ? '35-50%' : score >= 50 ? '25-40%' : '15-30%'
                }
            };
            
            return `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h5>📊 Objectifs Préparation</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li>6 mois: ${kpis.preparation['6 mois']} capacités opérationnelles</li>
                        <li>12 mois: ${kpis.preparation['12 mois']} prêt export</li>
                    </ul>
                    
                    <h5>🎯 Objectifs Commerciaux</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li>Prospects: ${kpis.commercial['Prospects qualifiés']}/an</li>
                        <li>Premiers contrats: ${kpis.commercial['Premiers contrats']}</li>
                    </ul>
                    
                    <h5>💰 Objectifs Financiers</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li>CA export Année 1: ${kpis.financial['CA export Y1']}</li>
                        <li>CA export Année 3: ${kpis.financial['CA export Y3']}</li>
                    </ul>
                </div>
            `;
        }
        
        function generateSuccessFactors(results, countryData, company) {
            const factors = [
                'Excellence qualité produits et respect strict standards cible',
                'Adaptation culturelle et linguistique de l\'approche commerciale',
                'Partenariats locaux stratégiques (distributeurs, prescripteurs)',
                'Pricing compétitif avec marges préservées',
                'Service client réactif et support technique',
                'Conformité réglementaire anticipée et maintenue',
                'Innovation continue et veille concurrentielle',
                'Flexibilité opérationnelle et capacité d\'adaptation'
            ];
            
            return `
                <ul style="list-style: none; padding: 0; columns: 2; column-gap: 30px;">
                    ${factors.map((factor, index) => `
                        <li style="break-inside: avoid; margin-bottom: 8px;">
                            <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 8px;">
                                ${index + 1}
                            </span>
                            ${factor}
                        </li>
                    `).join('')}
                </ul>
            `;
        }

// Générer les recommandations spécifiques selon les scores
function generateSpecificRecommendations(scores, type = 'short') {
    const recommendations = [];
    
    Object.entries(scores).forEach(([questionId, score]) => {
    // Logique spéciale pour la question certifications (binaire)
    const [dimIndex, qIndex] = questionId.split('-').map(Number);
    const dimension = dimensions[dimIndex];
    const question = dimension.questions[qIndex];
    
    let shouldRecommend = false;
    
    if (question.includes('certifications qualité')) {
        // Pour les certifications : recommander seulement si score = 1 (pas de certif)
        shouldRecommend = (score === 1);
    } else {
        // Pour les autres questions : logique normale
        shouldRecommend = (score <= 2);
    }
    
    if (shouldRecommend) {
        const recommendation = questionRecommendations[questionId];
            if (recommendation) {
                const [dimIndex, qIndex] = questionId.split('-').map(Number);
                const dimension = dimensions[dimIndex];
                const question = dimension.questions[qIndex];
                
                recommendations.push({
                    questionId,
                    dimension: dimension.title.replace(/^\d+\.\s*/, ''),
                    question: question,
                    score: score,
                    priority: score === 1 ? 'CRITIQUE' : 'ÉLEVÉE',
                    text: type === 'short' ? recommendation.short : recommendation.detailed
                });
            }
        }
    });
    
    return recommendations.sort((a, b) => a.score - b.score);
}

        // Charger les données sauvegardées
        function loadFromStorage() {
            const savedData = localStorage.getItem('exportToolData');
            if (savedData) {
                currentData = JSON.parse(savedData);
                
                // Remplir le formulaire entreprise
                Object.keys(currentData.company).forEach(key => {
                    const element = document.getElementById(key);
                    if (element && typeof currentData.company[key] === 'string') {
                        element.value = currentData.company[key];
                    }
                });
                
                // Restaurer les sélections de pays actuels
                if (currentData.company.currentMarkets) {
                    currentData.company.currentMarkets.forEach(country => {
                        const checkbox = document.getElementById(`currentMarkets_${country}`);
                        if (checkbox) checkbox.checked = true;
                    });
                    updateDisplaySelection('currentMarkets');
                }
                
                // Remplir les questions si elles existent
if (Object.keys(currentData.scores).length > 0) {
    generateQuestions();
    updateProgress();
    
    // Restaurer les détails de certifications
    setTimeout(() => {
        if (currentData.certificationDetails) {
            Object.entries(currentData.certificationDetails).forEach(([questionId, details]) => {
                const textarea = document.getElementById(`certifications-list-${questionId}`);
                if (textarea) {
                    textarea.value = details;
                    // Afficher le champ si score = 4
                    const detailsDiv = document.getElementById(`certifications-details-${questionId}`);
                    if (detailsDiv && currentData.scores[questionId] === 4) {
                        detailsDiv.style.display = 'block';
                    }
                }
            });
        }
    }, 500);
}

                

                // Afficher les résultats si ils existent
                if (currentData.results) {
                    displayResults();
                }
            }
            
            loadHistory();
        }

        // Sauvegarder les données
        function saveToStorage() {
            localStorage.setItem('exportToolData', JSON.stringify(currentData));
        }

        // Navigation entre sections avec effet de chargement
        function showSection(sectionName) {
            // Cacher toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Cacher le conteneur de chargement
            document.getElementById('loadingContainer').classList.remove('active');
            
            // Retirer la classe active de tous les boutons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('loading');
            });
            
            // Afficher la section demandée
            document.getElementById(sectionName).classList.add('active');
            
            // Activer le bouton correspondant
            event.target.classList.add('active');
        }

      // Navigation avec effet de chargement pour les résultats et diagnostic
        function showSectionWithLoading(sectionName) {
            if (sectionName === 'results') {
                // Vérifier s'il y a des résultats à afficher
                if (!currentData.results) {
                    showAlert('Veuillez d\'abord compléter l\'évaluation et calculer les résultats.', 'warning');
                    return;
                }
                
                // Démarrer l'animation de chargement pour les résultats uniquement
                startLoadingAnimation(sectionName);
                
                // Simuler le traitement pendant 10 secondes
                setTimeout(() => {
                    completeLoading(sectionName);
                }, 10000);
                
            } else if (sectionName === 'detailed') {
                // Vérifier s'il y a des résultats à afficher
                if (!currentData.results) {
                    showAlert('Veuillez d\'abord compléter l\'évaluation et calculer les résultats.', 'warning');
                    return;
                }
                
                // Vérification supplémentaire pour le diagnostic détaillé
                if (!currentData.company.targetMarket) {
                    showAlert('Veuillez sélectionner un marché cible dans les informations entreprise pour accéder au diagnostic détaillé.', 'warning');
                    return;
                }
                
                // Affichage direct sans animation de chargement
                generateDetailedDiagnosis();
                showSection(sectionName);
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('detailedTab').classList.add('active');
                
            } else {
                showSection(sectionName);
            }
        }

        function startLoadingAnimation(sectionName) {
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Retirer la classe active de tous les boutons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Adapter les textes selon le type d'analyse
            if (sectionName === 'detailed') {
                document.getElementById('step1-text').textContent = 'Analyse du profil économique du marché cible';
                document.getElementById('step2-text').textContent = 'Évaluation des accords commerciaux et réglementations';
                document.getElementById('step3-text').textContent = 'Calcul de la préparation export et matrice des risques';
                document.getElementById('step4-text').textContent = 'Génération du plan stratégique détaillé';
                document.getElementById('step5-text').textContent = 'Finalisation du diagnostic expert';
                
                document.querySelector('.loading-title').textContent = '🔍 Diagnostic Détaillé en Cours';
                document.querySelector('.loading-subtitle').textContent = 'Analyse experte approfondie de votre préparation export...';
            } else {
                document.getElementById('step1-text').textContent = 'Calcul des scores pondérés par dimension';
                document.getElementById('step2-text').textContent = 'Analyse des interdépendances et goulots d\'étranglement';
                document.getElementById('step3-text').textContent = 'Génération des recommandations stratégiques';
                document.getElementById('step4-text').textContent = 'Élaboration du plan d\'action personnalisé';
                document.getElementById('step5-text').textContent = 'Finalisation du rapport d\'analyse';
                
                document.querySelector('.loading-title').textContent = '🔍 Analyse Approfondie en Cours';
                document.querySelector('.loading-subtitle').textContent = 'Génération de votre rapport détaillé...';
            }
            
            // Marquer l'onglet approprié comme en chargement
            const targetTab = sectionName === 'results' ? 'resultsTab' : 'detailedTab';
            const tab = document.getElementById(targetTab);
            tab.classList.add('loading');
            
            if (sectionName === 'results') {
                tab.innerHTML = '⏳ Analyse en cours...';
            } else {
                tab.innerHTML = '⏳ Diagnostic en cours...';
            }
            
            // Afficher le conteneur de chargement
            document.getElementById('loadingContainer').classList.add('active');
            
            // Réinitialiser les étapes
            document.querySelectorAll('.loading-step').forEach(step => {
                step.classList.remove('completed', 'active');
                step.querySelector('.loading-step-icon').innerHTML = '⏳';
            });
            
            // Démarrer l'animation de la barre et des étapes
            animateLoadingProgress();
        }

        function animateLoadingProgress() {
            const loadingBar = document.getElementById('loadingBar');
            const loadingPercentage = document.getElementById('loadingPercentage');
            const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
            
            let progress = 0;
            let currentStep = 0;
            
            const interval = setInterval(() => {
                progress += 1;
                
                // Mettre à jour la barre de progression
                loadingBar.style.width = progress + '%';
                loadingPercentage.textContent = progress + '%';
                
                // Activer les étapes progressivement
                const stepThresholds = [15, 35, 55, 75, 95];
                
                for (let i = 0; i < stepThresholds.length; i++) {
                    const stepElement = document.getElementById(steps[i]);
                    
                    if (progress >= stepThresholds[i] && !stepElement.classList.contains('completed')) {
                        // Marquer l'étape précédente comme complétée
                        if (i > 0) {
                            const prevStep = document.getElementById(steps[i-1]);
                            prevStep.classList.remove('active');
                            prevStep.classList.add('completed');
                            prevStep.querySelector('.loading-step-icon').innerHTML = '✅';
                        }
                        
                        // Activer l'étape actuelle
                        stepElement.classList.add('active');
                        stepElement.querySelector('.loading-step-icon').innerHTML = '<div class="spinner"></div>';
                    }
                }
                
                // Arrêter à 100%
                if (progress >= 100) {
                    clearInterval(interval);
                    
                    // Marquer la dernière étape comme complétée
                    const lastStep = document.getElementById(steps[steps.length - 1]);
                    lastStep.classList.remove('active');
                    lastStep.classList.add('completed');
                    lastStep.querySelector('.loading-step-icon').innerHTML = '✅';
                }
            }, 100); // Mise à jour toutes les 100ms pour 10 secondes total
        }

        function completeLoading(sectionName) {
            // Masquer le conteneur de chargement
            document.getElementById('loadingContainer').classList.remove('active');
            
            // Restaurer l'onglet approprié
            if (sectionName === 'results') {
                const resultsTab = document.getElementById('resultsTab');
                resultsTab.classList.remove('loading');
                resultsTab.classList.add('active');
                resultsTab.innerHTML = '📊 Résultats & Analyse';
            } else {
                const detailedTab = document.getElementById('detailedTab');
                detailedTab.classList.remove('loading');
                detailedTab.classList.add('active');
                detailedTab.innerHTML = '🔍 Diagnostic Détaillé';
                
                // Générer le diagnostic détaillé
                generateDetailedDiagnosis();
            }
            
            // Afficher la section appropriée
            document.getElementById(sectionName).classList.add('active');
            
            // Effet de succès
            const message = sectionName === 'results' ? 
                '✅ Analyse terminée ! Votre rapport détaillé est maintenant disponible.' :
                '✅ Diagnostic détaillé terminé ! Votre analyse approfondie est maintenant disponible.';
            showAlert(message, 'success');
            
            // Scroll vers le haut pour voir les résultats
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Passer à la section évaluation
        function nextCompanySection() {
            // Récupérer les données du formulaire
            const formData = new FormData(document.getElementById('companyForm'));
            const companyData = {};
            
            for (let [key, value] of formData.entries()) {
                companyData[key] = value;
            }
            
            // Ajouter les pays sélectionnés
            companyData.currentMarkets = currentData.company.currentMarkets || [];
            
            // 🔥 VALIDATION COMPLÈTE - TOUS LES CHAMPS OBLIGATOIRES
            const champsManquants = [];
            
            // Vérifier chaque champ obligatoire
            if (!companyData.companyName || companyData.companyName.trim() === '') {
                champsManquants.push('Nom de l\'entreprise');
            }
            if (!companyData.sector || companyData.sector === '') {
                champsManquants.push('Secteur d\'activité');
            }
            if (!companyData.employees || companyData.employees === '') {
                champsManquants.push('Nombre d\'employés');
            }
            if (!companyData.revenue || companyData.revenue === '') {
                champsManquants.push('Chiffre d\'affaires annuel');
            }
            if (!companyData.country || companyData.country === '') {
                champsManquants.push('Pays du siège social');
            }
            if (!companyData.email || companyData.email.trim() === '') {
                champsManquants.push('Email de contact');
            }
            if (!companyData.interviewer || companyData.interviewer.trim() === '') {
                champsManquants.push('Dossier suivi par (Agent ACIEX)');
            }
            if (!companyData.leaderGender || companyData.leaderGender === '') {
                champsManquants.push('Sexe du dirigeant');
            }
            if (!companyData.leaderAge || companyData.leaderAge === '') {
                champsManquants.push('Tranche d\'âge du dirigeant');
            }
            
            // Vérifier les marchés actuels
            if (companyData.currentMarkets.length === 0) {
                champsManquants.push('Marchés actuels (au moins un)');
            }
            
            // Vérifier le marché cible
            if (!companyData.targetMarket || companyData.targetMarket === '') {
                champsManquants.push('Marché cible prioritaire');
            }
            
            // 🚨 AFFICHER L'ERREUR SI DES CHAMPS MANQUENT
            if (champsManquants.length > 0) {
                let message = '🚨 <strong>CHAMPS OBLIGATOIRES MANQUANTS</strong><br><br>';
                message += '❌ Veuillez compléter les champs suivants :<br><br>';
                
                champsManquants.forEach(champ => {
                    message += `• <strong>${champ}</strong><br>`;
                });
                
                message += '<br>💡 <em>Tous les champs sont obligatoires pour obtenir un diagnostic précis.</em>';
                
                showAlert(message, 'warning');
                
                // Faire défiler vers le haut pour voir le premier champ manquant
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                return; // Arrêter ici, ne pas passer à l'étape suivante
            }
            
            // ✅ TOUS LES CHAMPS SONT REMPLIS - CONTINUER
            // Sauvegarder les données
            currentData.company = companyData;
            saveToStorage();
            
            // Générer les questions
            generateQuestions();
            
            // Passer à la section évaluation
            showSection('evaluation');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[onclick="showSection(\'evaluation\')"]').classList.add('active');
            
            // Message de confirmation
            showAlert('✅ Informations entreprise complètes ! Vous pouvez maintenant commencer l\'évaluation.', 'success');
        }

        // Réponses personnalisées pour chaque question
const customResponses = {
    // DIMENSION 1: Produit et Positionnement
    '0-0': ['❌ Pas de besoin identifié', '⚠️ Besoin flou/incertain', '✓ Besoin partiellement identifié', '✅ Besoin clairement identifié'],
    '0-1': ['❌ Aucune adaptation', '⚠️ Adaptation mineure', '✓ Adaptation partielle', '✅ Adaptation complète'],
    '0-2': ['❌ Pas du tout attractive', '⚠️ Peu attractive', '✓ Moyennement attractive', '✅ Très attractive'],
    '0-3': ['❌ Aucune protection', '⚠️ Protection limitée', '✓ Protection partielle', '✅ Protection complète'],
    '0-4': ['❌ Aucun avantage', '⚠️ Avantage faible', '✓ Avantage modéré', '✅ Avantage distinctif fort'],

    // DIMENSION 2: Capacité de Production et Logistique
    '1-0': ['❌ Capacité insuffisante', '⚠️ Capacité limitée (+10%)', '✓ Capacité correcte (+20%)', '✅ Capacité excellente (+30%+)'],
    '1-1': ['❌ Non conformes', '⚠️ Partiellement conformes', '✓ Majoritairement conformes', '✅ Totalement conformes'],
    '1-2': ['❌ Aucun système', '⚠️ Système basique', '✓ Système correct', '✅ Système performant'],
    '1-3': ['❌ Pas fiable/pas diversifiée', '⚠️ Peu fiable/peu diversifiée', '✓ Assez fiable et diversifiée', '✅ Très fiable et diversifiée'],
    '1-4': ['❌ Délais > 60 jours', '⚠️ Délais 30-60 jours', '✓ Délais 15-30 jours', '✅ Délais < 15 jours'],

    // DIMENSION 3: Qualité et Conformité
    '2-0': ['❌ Aucune traçabilité', '⚠️ Traçabilité partielle', '✓ Traçabilité correcte', '✅ Traçabilité complète'],
    '2-1': ['❌ Aucune certification', '⚠️ Certifications locales', '✓ Quelques certifications internationales', '✅ Certifications internationales reconnues'],
    '2-2': ['❌ Aucun contrôle', '⚠️ Contrôles occasionnels', '✓ Contrôles réguliers', '✅ Contrôles rigoureux systématiques'],
    '2-3': ['❌ Inadaptés', '⚠️ Partiellement adaptés', '✓ Correctement adaptés', '✅ Parfaitement adaptés'],
    '2-4': ['❌ Jamais', '⚠️ Rarement', '✓ Parfois', '✅ Régulièrement'],

    // DIMENSION 4: Organisation et Processus Internes
    '3-0': ['❌ Pas documentés', '⚠️ Partiellement documentés', '✓ Documentés mais non optimisés', '✅ Documentés et optimisés'],
    '3-1': ['❌ Aucun système', '⚠️ Système basique', '✓ Système correct', '✅ Système performant (ERP/CRM)'],
    '3-2': ['❌ Monolingue uniquement', '⚠️ 2 langues', '✓ 3 langues', '✅ Multilingue (4+ langues)'],
    '3-3': ['❌ Aucune procédure', '⚠️ Procédures floues', '✓ Procédures partielles', '✅ Procédures claires complètes'],
    '3-4': ['❌ Aucune formation', '⚠️ Formation basique', '✓ Formation partielle', '✅ Formation complète spécialisée'],

    // DIMENSION 5: Situation Financière
    '4-0': ['❌ Endettement > 70%', '⚠️ Endettement 50-70%', '✓ Endettement 30-50%', '✅ Endettement < 30%'],
    '4-1': ['❌ Aucun accès', '⚠️ Accès limité', '✓ Accès partiel', '✅ Accès complet sécurisé'],
    '4-2': ['❌ Budget < 5%', '⚠️ Budget 5-7%', '✓ Budget 7-10%', '✅ Budget > 10%'],
    '4-3': ['❌ Trésorerie < 30 jours', '⚠️ Trésorerie 30-60 jours', '✓ Trésorerie 60-90 jours', '✅ Trésorerie > 90 jours'],
    '4-4': ['❌ Aucun suivi comptable', '⚠️ Retard de plus de 3 mois', '✓ Tenue à jour sans expert', '✅ À jour + expert-comptable'],

    // DIMENSION 6: Maîtrise des Prix et Techniques Commerciales Export
    '5-0': ['❌ Aucune maîtrise', '⚠️ Notions de base', '✓ Bonne maîtrise', '✅ Maîtrise experte'],
    '5-1': ['❌ Grille unique', '⚠️ 2-3 marchés', '✓ Plusieurs marchés', '✅ Grille spécifique par marché'],
    '5-2': ['❌ Aucune connaissance', '⚠️ Connaissances de base', '✓ Bonnes connaissances', '✅ Maîtrise experte'],
    '5-3': ['❌ Aucune couverture', '⚠️ Couverture occasionnelle', '✓ Couverture partielle', '✅ Couverture systématique'],
    '5-4': ['❌ Prix non compétitifs', '⚠️ Prix peu compétitifs', '✓ Prix compétitifs', '✅ Prix très compétitifs'],

    // DIMENSION 7: Expérience et Compétences Export
    '6-0': ['❌ Aucune expérience', '⚠️ Expérience limitée', '✓ Expérience modérée', '✅ Expérience confirmée'],
    '6-1': ['❌ Aucun responsable', '⚠️ Responsable non formé', '✓ Responsable partiellement formé', '✅ Responsable expert formé'],
    '6-2': ['❌ Aucune connaissance', '⚠️ Connaissances de base', '✓ Bonnes connaissances', '✅ Maîtrise experte'],
    '6-3': ['❌ Jamais participé', '⚠️ 1-2 participations', '✓ Participations régulières', '✅ Participations actives fréquentes'],
    '6-4': ['❌ Langues locales uniquement', '⚠️ Français + bases anglais', '✓ Français + bon anglais', '✅ Multilingue expert'],

    // DIMENSION 8: Innovation et Développement
    '7-0': ['❌ Pas d\'investissement R&D', '⚠️ < 1% du CA', '✓ 1-2% du CA', '✅ > 2% du CA'],
    '7-1': ['❌ Aucun développement', '⚠️ Développement occasionnel', '✓ 1 nouveauté/2 ans', '✅ 1+ nouveauté/an'],
    '7-2': ['❌ Aucune veille', '⚠️ Veille occasionnelle', '✓ Veille régulière', '✅ Veille systématique active'],
    '7-3': ['❌ Aucune collaboration', '⚠️ Collaborations ponctuelles', '✓ Quelques partenariats', '✅ Partenariats actifs multiples'],
    '7-4': ['❌ Pas protégées', '⚠️ Protection partielle', '✓ Bien protégées', '✅ Protégées et valorisées'],

    // DIMENSION 9: Réseau et Partenariats
    '8-0': ['❌ Aucun contact', '⚠️ Quelques contacts', '✓ Réseau modéré', '✅ Réseau solide établi'],
    '8-1': ['❌ Aucune participation', '⚠️ Participation occasionnelle', '✓ Participation régulière', '✅ Participation active leadership'],
    '8-2': ['❌ Aucun distributeur', '⚠️ 1-2 distributeurs', '✓ Quelques distributeurs', '✅ Réseau distributeurs fiables'],
    '8-3': ['❌ Aucune relation', '⚠️ Relations ponctuelles', '✓ Relations régulières', '✅ Relations privilégiées actives'],
    '8-4': ['❌ Pas de présence', '⚠️ Présence limitée', '✓ Bonne présence', '✅ Forte présence internationale'],

    // DIMENSION 10: Planification et Stratégie Export
    '9-0': ['❌ Aucun plan', '⚠️ Plan informel', '✓ Plan partiel', '✅ Business plan complet 3 ans'],
    '9-1': ['❌ Pas d\'objectifs', '⚠️ Objectifs flous', '✓ Objectifs définis', '✅ Objectifs chiffrés suivis'],
    '9-2': ['❌ Aucun budget', '⚠️ Budget informel', '✓ Budget partiel', '✅ Budget dédié formalisé'],
    '9-3': ['❌ Aucune veille', '⚠️ Veille occasionnelle', '✓ Veille régulière', '✅ Veille systématique active'],
    '9-4': ['❌ Aucune stratégie', '⚠️ Approche générale', '✓ Stratégie partielle', '✅ Stratégie spécifique par marché']
};

        // Générer les questions avec réponses personnalisées
        function generateQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            dimensions.forEach((dimension, dimIndex) => {
                // En-tête de dimension
                const header = document.createElement('div');
                header.className = 'dimension-header';
                header.innerHTML = dimension.title;
                container.appendChild(header);
                
                // Questions de la dimension
                dimension.questions.forEach((question, qIndex) => {
                    const questionContainer = document.createElement('div');
                    questionContainer.className = 'question-container';
                    
                    const questionId = `${dimIndex}-${qIndex}`;
                    
                    let questionHtml = '';

                    // Question spéciale pour les certifications (binaire)
                    if (question.includes('certifications qualité')) {
                        questionHtml = `
                            <div class="question-title">${question}</div>
                            <div class="score-buttons">
                                <button class="score-btn" onclick="selectScore('${questionId}', 1)" data-score="1">❌ Non, aucune certification</button>
                                <button class="score-btn" onclick="selectScore('${questionId}', 4)" data-score="4">✅ Oui, nous avons des certifications</button>
                            </div>
                            <div id="certifications-details-${questionId}" style="display: none; margin-top: 15px; background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 5px solid #34a853;">
                                <label for="certifications-list-${questionId}" style="color: #2e7d32; font-weight: bold;">
                                    📋 Lesquelles ? (précisez vos certifications) :
                                </label>
                                <textarea 
                                    id="certifications-list-${questionId}" 
                                    placeholder="Ex: ISO 9001:2015, HACCP, Certification Bio UE, Label Fairtrade, CE, FDA, etc."
                                    style="width: 100%; height: 80px; margin-top: 8px; padding: 10px; border: 2px solid #34a853; border-radius: 6px; font-family: inherit; resize: vertical;"
                                    onchange="saveCertificationDetails('${questionId}', this.value)"
                                ></textarea>
                                <small style="color: #2e7d32; font-style: italic;">💡 Plus vous êtes précis, plus le diagnostic sera pertinent</small>
                            </div>
                        `;
                    } else {
                        // Questions normales avec réponses personnalisées
                        const responses = customResponses[questionId] || ['1 - Pas du tout', '2 - Peu', '3 - Moyennement', '4 - Entièrement'];
                        
                        questionHtml = `
                            <div class="question-title">${question}</div>
                            <div class="score-buttons">
                                <button class="score-btn" onclick="selectScore('${questionId}', 1)" data-score="1">${responses[0]}</button>
                                <button class="score-btn" onclick="selectScore('${questionId}', 2)" data-score="2">${responses[1]}</button>
                                <button class="score-btn" onclick="selectScore('${questionId}', 3)" data-score="3">${responses[2]}</button>
                                <button class="score-btn" onclick="selectScore('${questionId}', 4)" data-score="4">${responses[3]}</button>
                            </div>
                        `;
                    }

                    questionContainer.innerHTML = questionHtml;
                    
                    container.appendChild(questionContainer);
                    
                    // Restaurer la sélection si elle existe
                    if (currentData.scores[questionId]) {
                        setTimeout(() => {
                            const selectedBtn = questionContainer.querySelector(`[data-score="${currentData.scores[questionId]}"]`);
                            if (selectedBtn) selectedBtn.classList.add('selected');
                        }, 100);
                    }
                });
            });
            
            updateProgress();
        }

        // Sélectionner un score
function selectScore(questionId, score) {
    // Sauvegarder le score
    currentData.scores[questionId] = score;
    saveToStorage();
    
    // Mettre à jour l'interface
    const questionContainer = event.target.closest('.question-container');
    questionContainer.querySelectorAll('.score-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    event.target.classList.add('selected');
    
    // Mettre à jour la progression
    updateProgress();

    // Gérer l'affichage du champ certifications pour la question spéciale
    const questionTitle = questionContainer.querySelector('.question-title').textContent;

    if (questionTitle.includes('certifications qualité')) {
        const detailsDiv = document.getElementById(`certifications-details-${questionId}`);
        if (score === 4) {
            // Si "Oui", afficher le champ
            detailsDiv.style.display = 'block';
            // Restaurer la valeur si elle existe
            const textarea = document.getElementById(`certifications-list-${questionId}`);
            if (currentData.certificationDetails && currentData.certificationDetails[questionId]) {
                textarea.value = currentData.certificationDetails[questionId];
            }
            // Focus sur le textarea pour encourager la saisie
            setTimeout(() => textarea.focus(), 200);
        } else {
            // Si "Non", masquer le champ et vider les données
            detailsDiv.style.display = 'none';
            if (currentData.certificationDetails) {
                delete currentData.certificationDetails[questionId];
                saveToStorage();
            }
        }
    }
}

// Sauvegarder les détails des certifications
function saveCertificationDetails(questionId, details) {
    if (!currentData.certificationDetails) {
        currentData.certificationDetails = {};
    }
    currentData.certificationDetails[questionId] = details;
    saveToStorage();
}

// Fonction de debug - à supprimer après test
function debugCertifications() {
    console.log('=== DEBUG CERTIFICATIONS ===');
    console.log('Scores actuels:', currentData.scores);
    console.log('Détails certifications:', currentData.certificationDetails);
    
    // Trouver la question certification
    dimensions.forEach((dimension, dimIndex) => {
        dimension.questions.forEach((question, qIndex) => {
            if (question.includes('certifications qualité')) {
                const questionId = `${dimIndex}-${qIndex}`;
                console.log(`Question certification ID: ${questionId}`);
                console.log(`Score pour cette question: ${currentData.scores[questionId]}`);
            }
        });
    });
}
        // Mettre à jour la progression
        function updateProgress() {
            const totalQuestions = dimensions.reduce((total, dim) => total + dim.questions.length, 0);
            const answeredQuestions = Object.keys(currentData.scores).length;
            const percentage = (answeredQuestions / totalQuestions) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${answeredQuestions}/${totalQuestions} questions complétées`;
        }

// Coefficients sectoriels
function getSectorCoefficient(sector) {
    // Coefficients de maturité export
    const exportReadinessCoefficients = {
        // SECTEURS PRIMAIRES - Avantages naturels CI
        'Agriculture': 1.1,
        'Agroforesterie': 1.15,
        'Mines et Métaux': 1.2,
        'Pétrole et Gaz': 1.25,
        
        // TRANSFORMATION AGROALIMENTAIRE
        'Agro-alimentaire': 1.0,
        
        // SECTEURS MANUFACTURIERS
        'Textile': 0.95,
        'Confection': 0.85,
        'Pharmaceutique': 1.15,
        'Cosmétiques': 1.1,
        'Artisanat': 0.9,
        'Bois et Ameublement': 1.05,
        'Matériaux de Construction': 0.9,
        'Chimie et Parachimie': 0.8,
        'Électronique': 0.7,
        'Mécanique': 0.75,
        
        // SECTEURS SERVICES
        'Transport et Logistique': 1.05,
        'Services Financiers': 0.95,
        'Tourisme': 1.0,
        'BTP': 0.9,
        'Énergie Renouvelable': 1.15,
        
        // DÉFAUT
        'Autre': 1.0
    };
    
    return exportReadinessCoefficients[sector] || 1.0;
}

        // Calculer les résultats avec effet de chargement
        function calculateResults() {
            // 🔥 VALIDATION COMPLÈTE - TOUTES LES 50 QUESTIONS OBLIGATOIRES
            const questionsManquantes = [];
            
            // Vérifier chaque question par dimension
            dimensions.forEach((dimension, dimIndex) => {
                dimension.questions.forEach((question, qIndex) => {
                    const questionId = `${dimIndex}-${qIndex}`;
                    if (!currentData.scores[questionId]) {
                        questionsManquantes.push({
                            dimension: dimension.title.replace(/^\d+\.\s*/, ''),
                            question: question,
                            numero: questionsManquantes.length + 1
                        });
                    }
                });
            });
            
            // 🚨 AFFICHER L'ERREUR SI DES QUESTIONS MANQUENT
            if (questionsManquantes.length > 0) {
                let message = '🚨 <strong>QUESTIONS OBLIGATOIRES NON RÉPONDUES</strong><br><br>';
                message += `❌ Il vous reste <strong>${questionsManquantes.length} question(s)</strong> à compléter :<br><br>`;
                
                // Limiter l'affichage aux 10 premières questions manquantes pour éviter un message trop long
                const questionsAffichees = questionsManquantes.slice(0, 10);
                
                questionsAffichees.forEach((item, index) => {
                    message += `<strong>${index + 1}. ${item.dimension}</strong><br>`;
                    message += `<em>"${item.question.substring(0, 80)}${item.question.length > 80 ? '...' : ''}"</em><br><br>`;
                });
                
                if (questionsManquantes.length > 10) {
                    message += `<em>... et ${questionsManquantes.length - 10} autres questions</em><br><br>`;
                }
                
                message += '💡 <em>Toutes les 50 questions doivent être répondues pour obtenir un diagnostic précis.</em><br>';
                message += '📋 <em>Faites défiler vers le haut pour voir les questions manquantes.</em>';
                
                showAlert(message, 'warning');
                
                // Faire défiler vers le haut pour voir les questions
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                return; // Arrêter ici, ne pas calculer les résultats
            }
            
            // Vérifier les informations entreprise
            if (!currentData.company.companyName) {
                showAlert('Veuillez d\'abord remplir les informations entreprise.', 'warning');
                showSection('company');
                return;
            }
            
// 🎯 VALIDATION SPÉCIALE POUR LES CERTIFICATIONS
            let certificationError = false;
            
            // Vérifier si quelqu'un a coché "Oui" pour les certifications mais n'a rien écrit
            for (let dimIndex = 0; dimIndex < dimensions.length; dimIndex++) {
                const dimension = dimensions[dimIndex];
                for (let qIndex = 0; qIndex < dimension.questions.length; qIndex++) {
                    const question = dimension.questions[qIndex];
                    
                    if (question.includes('certifications qualité')) {
                        const questionId = `${dimIndex}-${qIndex}`;
                        const score = currentData.scores[questionId];
                        
                        // Si l'utilisateur a coché "Oui" (score = 4)
                        if (score === 4) {
                            const certificationDetails = currentData.certificationDetails && currentData.certificationDetails[questionId];
                            
                            // Mais n'a pas rempli le champ ou l'a laissé vide
                            if (!certificationDetails || certificationDetails.trim() === '') {
                                let message = '🚨 <strong>CERTIFICATION MANQUANTE</strong><br><br>';
                                message += '❌ Vous avez indiqué posséder des <strong>certifications qualité</strong><br>';
                                message += 'mais vous n\'avez pas précisé lesquelles.<br><br>';
                                message += '💡 <strong>Merci d\'entrer au moins une certification</strong><br>';
                                message += '<em>Exemples : ISO 9001, HACCP, Certification Bio UE, FDA, CE, etc.</em><br><br>';
                                message += '📋 <em>Faites défiler vers la question des certifications et remplissez le champ.</em>';
                                
                                showAlert(message, 'warning');
                                
                                // Faire défiler vers le haut pour voir les questions
                                window.scrollTo({
                                    top: 0,
                                    behavior: 'smooth'
                                });
                                
                                certificationError = true;
                                break; // Sortir de la boucle interne
                            }
                        }
                    }
                }
                if (certificationError) break; // Sortir de la boucle externe
            }
            
            // Si erreur de certification, arrêter complètement la fonction
            if (certificationError) {
                return;
            }

            // Calculer les scores par dimension
            const dimensionScores = [];
            let globalWeightedScore = 0;
            
            dimensions.forEach((dimension, dimIndex) => {
                let dimensionTotal = 0;
                const questionsCount = dimension.questions.length;
                
                dimension.questions.forEach((question, qIndex) => {
                    const questionId = `${dimIndex}-${qIndex}`;
                    dimensionTotal += currentData.scores[questionId] || 0;
                });
                
                const dimensionPercent = (dimensionTotal / (questionsCount * 4)) * 100;
                const weightedContribution = (dimensionPercent * dimension.weight) / 100;
                
                dimensionScores.push({
                    name: dimension.title,
                    rawScore: dimensionTotal,
                    maxScore: questionsCount * 4,
                    percentage: Math.round(dimensionPercent),
                    weight: dimension.weight,
                    contribution: weightedContribution
                });
                
                globalWeightedScore += weightedContribution;
            });
            
            // Ajustement sectoriel
            const sectorCoefficient = getSectorCoefficient(currentData.company.sector);
            const adjustedScore = Math.round(globalWeightedScore * sectorCoefficient);
            
            // Déterminer le niveau
            const level = determineLevel(adjustedScore);
            
            // Calculer l'écart-type
            const percentages = dimensionScores.map(d => d.percentage);
            const average = percentages.reduce((a, b) => a + b, 0) / percentages.length;
            const variance = percentages.reduce((acc, val) => acc + Math.pow(val - average, 2), 0) / percentages.length;
            const standardDeviation = Math.round(Math.sqrt(variance) * 10) / 10;
            
            // Sauvegarder les résultats
            currentData.results = {
                globalScore: Math.round(globalWeightedScore),
                adjustedScore: adjustedScore,
                level: level,
                standardDeviation: standardDeviation,
                dimensionScores: dimensionScores,
                calculationDate: new Date().toLocaleDateString('fr-FR')
            };
            
            // Afficher les résultats avec effet de chargement
            debugCertifications();
	    displayResults();
            saveToHistory();
            saveToStorage();

	    // Démarrer l'animation de chargement avant d'aller aux résultats
            startLoadingAnimation('results');
            
            // Attendre 10 secondes puis afficher les résultats
            setTimeout(() => {
                completeLoading('results');
            }, 10000);

	    // Afficher le bouton Google Sheets si l'API est prête
            if (isGoogleSheetsReady) {
                setTimeout(() => {
                    showGoogleSheetsButton();
                }, 500); // Attendre que l'affichage soit terminé
            }

        }

// Analyser les questions critiques individuelles
        function analyzeCriticalQuestions() {
            const criticalQuestions = [];
            const warningQuestions = [];
            
            dimensions.forEach((dimension, dimIndex) => {
                dimension.questions.forEach((question, qIndex) => {
    const questionId = `${dimIndex}-${qIndex}`;
    const score = currentData.scores[questionId] || 0;
    
    // Logique spéciale pour les certifications (binaire : 1 = non, 4 = oui)
    if (question.includes('certifications qualité')) {
        if (score === 1) {
            criticalQuestions.push({
                dimension: dimension.title,
                question: question,
                score: score,
                severity: 'CRITIQUE'
            });
        }
        // Score 4 pour certifications = excellent, pas de problème
    } else {
        // Logique normale pour les autres questions
        if (score === 1) {
            criticalQuestions.push({
                dimension: dimension.title,
                question: question,
                score: score,
                severity: 'CRITIQUE'
            });
        } else if (score === 2) {
            warningQuestions.push({
                dimension: dimension.title,
                question: question,
                score: score,
                severity: 'ÉLEVÉ'
            });
        }
    }
});
            });
            
            return { critical: criticalQuestions, warning: warningQuestions };
        }

/*
=== LOGIQUE DES COEFFICIENTS SECTORIELS ===

1. EXPORT READINESS COEFFICIENTS (Score) :
   - Objectif : Ajuster le score selon les avantages comparatifs de la CI
   - Mines et Métaux = 1.2 → CI très compétitive → boost score +20%
   - Électronique = 0.7 → CI peu compétitive → réduit score -30%
   - Logique : Plus le secteur est favorable à la CI, plus le coefficient est élevé

2. INVESTMENT MULTIPLIERS (Budget) :
   - Objectif : Estimer les coûts réels de développement par secteur  
   - Électronique = 1.6 → Équipements coûteux → budget x1.6  
   - Artisanat = 0.8 → Investissements limités → budget x0.8
   - Logique : Plus le secteur nécessite d'investissements, plus le multiplicateur est élevé

EXEMPLE : Électronique
- Score réduit (0.7) car CI pas compétitive
- Budget élevé (1.6) car développement coûteux
*/

        // Déterminer le niveau
        function determineLevel(score) {
            if (score >= 80) return 'EXCELLENT';
            if (score >= 65) return 'BON POTENTIEL';
            if (score >= 45) return 'POTENTIEL MOYEN';
            return 'DÉVELOPPEMENT NÉCESSAIRE';
        }

        // Afficher les résultats
        function displayResults() {
            const container = document.getElementById('resultsContainer');
            const results = currentData.results;
            const company = currentData.company;
            
            if (!results) return;
            
            let levelColor = '#34a853';
            if (results.adjustedScore < 45) levelColor = '#ea4335';
            else if (results.adjustedScore < 65) levelColor = '#ff9900';
            
            // Ajouter la navigation secondaire
            let html = createSecondaryNav(resultsNavItems);
            
            html += `
                <div id="scores-globaux" class="anchor-section">
                    <h3 class="anchor-title">🎯 SCORES GLOBAUX</h3>
                    <div class="results-header" style="background: linear-gradient(135deg, ${levelColor}, ${levelColor}dd);">
                        <div style="flex: 1;">
                            <h2 style="margin: 0 0 5px 0; font-size: 1.4em;">📊 ${company.companyName}</h2>
                            <div style="font-size: 0.9em; opacity: 0.8;">${results.level} • Évaluation du ${results.calculationDate}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="score-display">${results.globalScore}%</div>
                            <div style="font-size: 0.85em; opacity: 0.8; margin-top: 2px;">Ajusté : ${results.adjustedScore}%</div>
                        </div>
                    </div>
                </div>
                
                <div id="par-dimension" class="anchor-section">
                    <h3 class="anchor-title">📊 SCORES PAR DIMENSION</h3>
                    <div class="dimension-scores">
            `;
            
            // Scores par dimension
            results.dimensionScores.forEach(dimension => {
                let barColor = '#ea4335';
                if (dimension.percentage >= 75) barColor = '#34a853';
                else if (dimension.percentage >= 50) barColor = '#ff9900';
                
                html += `
                    <div class="dimension-card">
                        <div class="dimension-name">${dimension.name.replace(/^\d+\.\s*/, '')}</div>
                        <div class="dimension-score">${dimension.percentage}%</div>
                        <div class="dimension-bar">
                            <div class="dimension-fill" style="width: ${dimension.percentage}%; background: ${barColor};"></div>
                        </div>
                        <small>Poids: ${dimension.weight}% | Score: ${dimension.rawScore}/${dimension.maxScore}</small>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            // Diagnostic global
            html += `<div id="diagnostic-global" class="anchor-section">`;
            html += generateGlobalDiagnosis(results, company);
            html += '</div>';
            
            // Actions prioritaires
            const specificRecommendations = generateSpecificRecommendations(currentData.scores, 'short');
            if (specificRecommendations.length > 0) {
                html += `
                    <div id="actions-prioritaires" class="anchor-section">
                        <h3 class="anchor-title">⚡ ACTIONS PRIORITAIRES SPÉCIFIQUES</h3>
                        <div class="specific-recommendations" style="background: #fff3e0; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #ff9900;">
                            <p style="margin-bottom: 15px;">Basé sur vos réponses détaillées, voici les améliorations spécifiques nécessaires :</p>
                `;
                
                specificRecommendations.forEach((rec, index) => {
                    const priorityColor = rec.priority === 'CRITIQUE' ? '#ea4335' : '#ff9900';
                    html += `
                        <div style="background: white; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 3px solid ${priorityColor};">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-right: 10px;">
                                    ${rec.priority}
                                </span>
                                <strong style="color: #333;">${rec.dimension}</strong>
                            </div>
                            <p style="margin: 0; color: #666; font-size: 14px;">${rec.text}</p>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // Plan stratégique
            html += `<div id="plan-strategique" class="anchor-section">`;
            html += generateStrategicRecommendations(results, company);
            html += '</div>';
            
            // Export
            html += `
                <div id="export-resultats" class="anchor-section">
                    <h3 class="anchor-title">📄 EXPORTER VOS RÉSULTATS</h3>
                    <div style="background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center;">
                        <h4>📄 EXPORTER VOS RÉSULTATS</h4>
                        <p style="margin: 15px 0;">Téléchargez ou exportez votre rapport professionnel</p>
                        <button onclick="exportToPDF('complete')" class="btn" style="background: white; color: #1a73e8; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 10px; font-size: 1.1em;">
                            📥 Télécharger Rapport PDF
                        </button>
                        <button onclick="exportToGoogleSheets()" class="btn google-sheets-btn" style="background: #34a853; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 10px; font-size: 1.1em; display: none;">
                            📊 Exporter vers Google Sheets
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Diagnostic global approfondi
        function generateGlobalDiagnosis(results, company) {
            const score = results.adjustedScore;
            const weakDimensions = results.dimensionScores.filter(d => d.percentage < 50);
            const strongDimensions = results.dimensionScores.filter(d => d.percentage >= 75);
            const criticalDimensions = results.dimensionScores.filter(d => d.percentage < 30);

	// Analyser les questions individuelles critiques
                const criticalAnalysis = analyzeCriticalQuestions();
                const hasCriticalQuestions = criticalAnalysis.critical.length > 0 || criticalAnalysis.warning.length > 0;            

            // Analyse de cohérence
            const coherenceAnalysis = analyzeCoherence(results);
            
            // Identification goulots d'étranglement
            const bottlenecks = identifyBottlenecks(results, company.sector);
            
            // Estimation délais et budget
            const timeline = estimateTimeline(score, weakDimensions.length);
            const budget = estimateBudget(score, weakDimensions, company.sector);
            
            let diagnosis = `
                <div class="detailed-diagnosis">
                    <h4>📊 DIAGNOSTIC COMPLET POUR ${company.companyName.toUpperCase()}</h4>
                    
                    <div class="diagnosis-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="diagnosis-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #1a73e8;">
    <h5>🎯 PROFIL EXPORT</h5>
    <p><strong>Score brut :</strong> ${results.globalScore}%</p>
    <p><strong>Score ajusté :</strong> ${score}%</p>
    ${results.globalScore !== score ? `
        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 8px 0; border-left: 3px solid #1a73e8;">
            <p style="margin: 0; font-size: 0.9em; color: #1565c0;">
                <strong>💡 Explication de l'ajustement :</strong> 
                ${getAdjustmentExplanation(company.sector, results.globalScore, score)}
            </p>
        </div>
    ` : ''}
    <p><strong>Niveau :</strong> ${results.level}</p>
                            <p><strong>Délai export :</strong> ${timeline}</p>
                            <p><strong>Budget total :</strong> ${budget}</p>
                            <p><strong>Homogénéité :</strong> ${coherenceAnalysis.type}</p>
                        </div>
                        
                        <div class="diagnosis-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9900;">
                            <h5>⚡ FORCES & FAIBLESSES</h5>
                            <p><strong>Dimensions fortes :</strong> ${strongDimensions.length}/10</p>
                            <p><strong>Dimensions faibles :</strong> ${weakDimensions.length}/10</p>
                            <p><strong>Dimensions critiques :</strong> ${criticalDimensions.length}/10</p>
                        </div>
                    </div>
                    
                    <div class="diagnosis-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="diagnosis-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #228B22;">
                            <h5>🌍 MARCHÉS ACTUELS</h5>
                            <p>${(company.currentMarkets && company.currentMarkets.length > 0) ? company.currentMarkets.join(', ') : 'Non spécifiés'}</p>
                        </div>
                        
                        <div class="diagnosis-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF6B35;">
                            <h5>🎯 MARCHÉ CIBLE</h5>
                            <p>${company.targetMarket || 'Non spécifié'}</p>
                        </div>
                    </div>
                    
                    <div class="coherence-analysis" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h5>🔍 ANALYSE DE COHÉRENCE</h5>
                        ${coherenceAnalysis.description}
                        <p><strong>Impact :</strong> ${coherenceAnalysis.impact}</p>
                        <p><strong>Recommandation :</strong> ${coherenceAnalysis.recommendation}</p>
                    </div>
                    
                     `;
 // Afficher les atouts certifications si disponibles
                    if (currentData.certificationDetails) {
                        Object.entries(currentData.certificationDetails).forEach(([questionId, details]) => {
                            if (details && details.trim()) {
                                diagnosis += `
                                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #34a853;">
                                        <h5>✅ ATOUT MAJEUR - CERTIFICATIONS EXISTANTES</h5>
                                        <p><strong>Certifications possédées :</strong> ${details}</p>
                                        <p style="color: #2e7d32;"><strong>Impact positif :</strong> Facilite l'accès aux marchés internationaux exigeants</p>
                                    </div>
                                `;
                            }
                        });
                    }
                    
                    diagnosis += `
                    <div class="bottleneck-analysis" style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h5>🚨 GOULOTS D'ÉTRANGLEMENT IDENTIFIÉS</h5>
                        <ol>
                            ${bottlenecks.details.map(item => `<li><strong>${item.dimension}</strong>: ${item.impact}</li>`).join('')}
                        </ol>
                        <p><strong>Risque principal :</strong> ${bottlenecks.mainRisk}</p>
                    </div>
                    
                    ${hasCriticalQuestions ? `
                    <div class="critical-questions-alert" style="background: #ffebee; padding: 20px; border-radius: 8px; margin: 15px 0; border: 2px solid #ea4335;">
                        <h5 style="color: #ea4335;">🚨 ALERTE - DÉFAILLANCES CRITIQUES DÉTECTÉES</h5>
                        <p style="color: #c62828; font-weight: bold;">Malgré un score global satisfaisant, des faiblesses majeures ont été identifiées sur des questions spécifiques :</p>
                        
                        ${criticalAnalysis.critical.length > 0 ? `
<div style="background: #ffcdd2; padding: 15px; border-radius: 6px; margin: 10px 0;">
    <h6 style="color: #b71c1c;">⛔ DÉFAILLANCES CRITIQUES (Score 1/4) :</h6>
    <ul style="margin: 10px 0;">
        ${criticalAnalysis.critical.map(item => `
            <li style="margin: 8px 0;"><strong>${item.dimension.replace(/^\d+\.\s*/, '')} :</strong> ${transformQuestionToStatement(item.question)}</li>
        `).join('')}
    </ul>
                            <p style="color: #d32f2f; font-weight: bold;">⚠️ URGENCE ABSOLUE : Ces éléments doivent être corrigés avant tout lancement export !</p>
                        </div>
                        ` : ''}
                        
                        ${criticalAnalysis.warning.length > 0 ? `
<div style="background: #ffe0b2; padding: 15px; border-radius: 6px; margin: 10px 0;">
    <h6 style="color: #e65100;">⚠️ FAIBLESSES IMPORTANTES (Score 2/4) :</h6>
    <ul style="margin: 10px 0;">
        ${criticalAnalysis.warning.map(item => `
            <li style="margin: 8px 0;"><strong>${item.dimension.replace(/^\d+\.\s*/, '')} :</strong> ${transformQuestionToStatement(item.question)}</li>
        `).join('')}
    </ul>
                            <p style="color: #f57c00; font-weight: bold;">📋 PRIORITÉ HAUTE : Amélioration obligatoire avant export.</p>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
            
            return diagnosis;
        }

        // Analyse de cohérence
        function analyzeCoherence(results) {
            const percentages = results.dimensionScores.map(d => d.percentage);
            const average = percentages.reduce((a, b) => a + b, 0) / percentages.length;
            const variance = percentages.reduce((acc, val) => acc + Math.pow(val - average, 2), 0) / percentages.length;
            const standardDeviation = Math.sqrt(variance);
            
            let coherenceType, description, impact, recommendation;
            
            if (standardDeviation < 10) {
                coherenceType = "ÉQUILIBRÉ";
                description = "Profil homogène avec des capacités cohérentes entre toutes les dimensions.";
                impact = "Facilite la présentation commerciale et réduit les risques perçus.";
                recommendation = "Maintenez cette homogénéité en développant toutes les dimensions de manière équilibrée.";
            } else if (standardDeviation < 20) {
                coherenceType = "MOYENNEMENT ÉQUILIBRÉ";
                description = "Quelques disparités entre dimensions mais profil globalement cohérent.";
                impact = "Nécessite une communication ciblée pour mettre en avant les points forts.";
                recommendation = "Concentrez 60% des efforts sur les 2-3 dimensions les plus faibles.";
            } else if (standardDeviation < 30) {
                coherenceType = "HÉTÉROGÈNE";
                description = "Profil contrasté avec des points forts marqués mais aussi des faiblesses significatives.";
                impact = "Risque que les faiblesses compromettent l'exploitation des forces.";
                recommendation = "URGENCE: Investissez 80% des ressources sur les dimensions les plus faibles.";
            } else {
                coherenceType = "TRÈS HÉTÉROGÈNE";
                description = "Déséquilibres majeurs avec d'excellentes capacités dans certains domaines mais des défaillances critiques dans d'autres.";
                impact = "Situation à risque élevé - les faiblesses peuvent annuler les avantages des forces.";
                recommendation = "CRITIQUE: Plan de rééquilibrage urgent nécessaire avant tout lancement export.";
            }
            
            return { type: coherenceType, description, impact, recommendation };
        }

        // Identification des goulots d'étranglement
        function identifyBottlenecks(results, sector) {
            const weakDimensions = results.dimensionScores
                .filter(d => d.percentage < 50)
                .sort((a, b) => a.percentage - b.percentage);
            
            const criticalDimensions = results.dimensionScores.filter(d => d.percentage < 30);
            
            let primaryBottleneck = "Aucun goulot critique";
            let mainRisk = "Risques limités";
            let details = [];
            
            if (weakDimensions.length > 0) {
                const critical = weakDimensions[0];
                primaryBottleneck = critical.name.split(' ')[0];
                
                const impacts = {
                    'QUALITÉ': { impact: "Rejet produits, amendes réglementaires, perte de réputation", severity: "CRITIQUE" },
                    'PRIX': { impact: "Erreurs pricing coûteuses, litiges paiement, pertes change", severity: "ÉLEVÉ" },
                    'FINANCIÈRE': { impact: "Rupture trésorerie, incapacité honorer commandes", severity: "CRITIQUE" },
                    'EXPÉRIENCE': { impact: "Erreurs stratégiques, non-conformités, échecs commerciaux", severity: "ÉLEVÉ" },
                    'PRODUIT': { impact: "Positionnement inadéquat, échec commercial", severity: "ÉLEVÉ" }
                };
                
                weakDimensions.forEach(dim => {
                    const key = dim.name.toUpperCase().split(' ')[0];
                    const impactInfo = impacts[key] || { impact: "Impact négatif sur performance export", severity: "MOYEN" };
                    
                    details.push({
                        dimension: dim.name.split(' ')[0],
                        percentage: dim.percentage,
                        impact: impactInfo.impact,
                        severity: impactInfo.severity
                    });
                });
                
                if (criticalDimensions.length >= 3) {
                    mainRisk = "RISQUE MAJEUR - Échec probable sans redressement immédiat";
                } else if (criticalDimensions.length >= 1) {
                    mainRisk = "RISQUE ÉLEVÉ - Consolidation urgente requise";
                } else if (weakDimensions.length >= 4) {
                    mainRisk = "RISQUE MODÉRÉ - Développement structuré nécessaire";
                } else {
                    mainRisk = "RISQUE LIMITÉ - Améliorations ciblées suffisantes";
                }
            }
            
            return { primary: primaryBottleneck, mainRisk, details };
        }

        // Estimation timeline
        function estimateTimeline(score, weakCount) {
            if (score >= 80) return "Immédiat (0-3 mois)";
            if (score >= 65) return "Court terme (3-6 mois)";
            if (score >= 45) return "Moyen terme (6-12 mois)";
            if (weakCount >= 6) return "Long terme (18-24 mois)";
            return "Moyen-long terme (12-18 mois)";
        }

        // Estimation budget
        function estimateBudget(score, weakDimensions, sector) {
            let baseBudget = 0;
            
            if (score >= 80) baseBudget = 2000000;
            else if (score >= 65) baseBudget = 5000000;
            else if (score >= 45) baseBudget = 10000000;
            else baseBudget = 20000000;
            
            const criticalDimensions = weakDimensions.filter(d => d.percentage < 30);
            baseBudget += criticalDimensions.length * 3000000;
            
            const sectorMultipliers = {
    // ✅ SECTEURS PRIMAIRES
    'Agriculture': 1.1,
    'Agroforesterie': 1.2,
    'Mines et Métaux': 1.4,
    'Pétrole et Gaz': 1.5,
    
    // ✅ TRANSFORMATION
    'Agro-alimentaire': 1.2,
    'Pharmaceutique': 1.5,
    'Cosmétiques': 1.3,
    
    // ✅ MANUFACTURIERS
    'Textile': 1.0,
    'Confection': 0.9,
    'Artisanat': 0.8,
    'Bois et Ameublement': 1.1,
    'Matériaux de Construction': 1.2,
    'Chimie et Parachimie': 1.4,
    'Électronique': 1.6,
    'Mécanique': 1.3,
    
    // ✅ SERVICES
    'Transport et Logistique': 1.1,
    'Services Financiers': 1.2,
    'Tourisme': 1.0,
    'BTP': 1.1,
    'Énergie Renouvelable': 1.3,
    
    // ✅ DÉFAUT
    'Autre': 1.0
};
            
            const multiplier = sectorMultipliers[sector] || 1.0;
            const finalBudget = baseBudget * multiplier;
            
            if (finalBudget >= 1000000) {
                return Math.round(finalBudget / 1000000) + "M FCFA";
            } else {
                return Math.round(finalBudget / 1000) + "K FCFA";
            }
        }

        // Générer recommandations stratégiques
        function generateStrategicRecommendations(results, company) {
            const weakDimensions = results.dimensionScores.filter(d => d.percentage < 50);
            const score = results.adjustedScore;
            
            let recommendations = `
                <div class="strategic-recommendations">
                    <h4>💡 PLAN D'ACTION STRATÉGIQUE DÉTAILLÉ</h4>
            `;
            
            if (score >= 80) {
                recommendations += `
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h5>✅ STRATÉGIE LANCEMENT IMMÉDIAT</h5>
                        <p><strong>Position :</strong> Entreprise mature pour l'export avec excellentes capacités.</p>
                        
                        <h6>🎯 PLAN D'ACTION IMMÉDIAT (0-90 jours) :</h6>
                        <ul>
                            <li><strong>Semaines 1-2 :</strong> Documentation commerciale multilingue - Budget : 300-800K FCFA</li>
                            <li><strong>Semaines 3-6 :</strong> Inscription 3 salons internationaux - Budget : 1.5-4M FCFA</li>
                            <li><strong>Semaines 7-12 :</strong> Missions commerciales dans 2 pays - Budget : 800K-2M FCFA</li>
                        </ul>
                        
                        <p><strong>🎯 OBJECTIFS 12 MOIS :</strong></p>
<ul>
    <li>2-4 contrats export signés</li>
    <li>5-10% du CA généré à l'export</li>
    <li>ROI export : 80-120% sur investissement</li>
</ul>
                    </div>
                `;
            } else if (score >= 65) {
                recommendations += `
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h5>🚀 STRATÉGIE PRÉPARATION FINALE</h5>
                        <p><strong>Position :</strong> Bon potentiel avec quelques ajustements nécessaires.</p>
                        
                        <h6>⚡ PLAN DE MISE À NIVEAU (3-6 mois) :</h6>
                        <ul>
                            <li><strong>Mois 1 :</strong> Démarrage actions correctives prioritaires</li>
                            <li><strong>Mois 2 :</strong> 50% des faiblesses corrigées</li>
                            <li><strong>Mois 3 :</strong> Validation conformité standards export</li>
                            <li><strong>Mois 6 :</strong> Prêt pour lancement export</li>
                        </ul>
                    </div>
                `;
            } else if (score >= 45) {
                recommendations += `
                    <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h5>⚡ STRATÉGIE DÉVELOPPEMENT STRUCTURÉ</h5>
                        <p><strong>Position :</strong> Potentiel export identifié nécessitant développement ciblé.</p>
                        
                        <h6>🔧 PROGRAMME DE DÉVELOPPEMENT (6-12 mois) :</h6>
                        <ul>
                            <li><strong>Phase 1 (0-3 mois) :</strong> Fondamentaux - Formation équipe, processus internes</li>
                            <li><strong>Phase 2 (3-6 mois) :</strong> Conformité - Certifications, mise aux normes</li>
                            <li><strong>Phase 3 (6-9 mois) :</strong> Adaptation - Produits export, études marché</li>
                            <li><strong>Phase 4 (9-12 mois) :</strong> Préparation - Tests, partenariats</li>
                        </ul>
                        
                        <p><strong>🎯 OBJECTIF 12 MOIS :</strong> Score export 70%+ et première mission commerciale</p>
                    </div>
                `;
            } else {
                recommendations += `
                    <div style="background: #ffebee; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h5>🔧 STRATÉGIE CONSOLIDATION FONDAMENTAUX</h5>
                        <p><strong>Position :</strong> Consolidation interne nécessaire avant export.</p>
                        
                        <h6>🏗️ PLAN DE REDRESSEMENT (12-24 mois) :</h6>
                        <ul>
                            <li><strong>Phase 1 - Stabilisation (0-6 mois) :</strong> Audit organisation, formation management</li>
                            <li><strong>Phase 2 - Développement (6-12 mois) :</strong> Investissements, renforcement capacités</li>
                            <li><strong>Phase 3 - Préparation Export (12-18 mois) :</strong> Formation commerce international</li>
                        </ul>
                        
                        <p><strong>⚠️ CONDITION CRITIQUE :</strong> Ne pas se lancer à l'export avant d'avoir atteint 65% minimum</p>
                    </div>
                `;
            }
            
            // Actions prioritaires par dimension faible
            if (weakDimensions.length > 0) {
                recommendations += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h5>🎯 ACTIONS PRIORITAIRES PAR DIMENSION</h5>
                `;
                
                weakDimensions.slice(0, 3).forEach(dim => {
                    const actions = getDetailedActions(dim.name, dim.percentage);
                    recommendations += `
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #ff9900;">
                            <h6>${dim.name.replace(/^\d+\.\s*/, '')} (${dim.percentage}%)</h6>
                            ${actions}
                        </div>
                    `;
                });
                
                recommendations += '</div>';
            }
            
            // Budget et ROI
            const budgetEstimate = score < 50 ? '8-25M FCFA' : score < 70 ? '3-12M FCFA' : '1-5M FCFA';
            
            recommendations += `
                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <h5>💰 INVESTISSEMENT ET RETOUR SUR INVESTISSEMENT</h5>
                    <p><strong>Budget total estimé :</strong> ${budgetEstimate}</p>
                   <p><strong>ROI attendu :</strong> 80-150% sur 2-3 ans</p>
                    <p><strong>Délai d'amortissement :</strong> 18-30 mois pour les entreprises bien préparées</p>
                    <p><strong>CA export cible :</strong> 15-40% du CA total dans les 2-3 ans</p>
                </div>
            `;
            
            recommendations += '</div>';
            return recommendations;
        }

        // Actions détaillées par dimension
        function getDetailedActions(dimensionName, percentage) {
            if (dimensionName.includes('Qualité')) {
                return `
                    <p><strong>Actions immédiates :</strong></p>
                    <ul>
                        <li>Audit qualité externe par organisme certifié (2 semaines)</li>
                        <li>Lancement certifications adaptées au secteur (6-12 mois)</li>
                        <li>Formation équipe aux standards qualité (40h/personne)</li>
                        <li>Équipements contrôle qualité selon secteur</li>
                    </ul>
                    <p><strong>Budget :</strong> 800K-3M FCFA | <strong>ROI :</strong> Accès marchés premium +30%</p>
                `;
            } else if (dimensionName.includes('Prix')) {
                return `
                    <p><strong>Actions immédiates :</strong></p>
                    <ul>
                        <li>Formation intensive Incoterms 2020 (3 jours)</li>
                        <li>Développement grille prix export par pays</li>
                        <li>Ouverture comptes multi-devises (EUR, USD)</li>
                        <li>Formation crédit documentaire et paiements sécurisés</li>
                    </ul>
                    <p><strong>Budget :</strong> 300K-1M FCFA | <strong>ROI :</strong> Sécurisation paiements +80%</p>
                `;
            } else if (dimensionName.includes('Financière')) {
                return `
                    <p><strong>Actions immédiates :</strong></p>
                    <ul>
                        <li>Recherche financements export dédiés (BPIFRANCE, AFD)</li>
                        <li>Négociation ligne crédit export avec banque</li>
                        <li>Diversification sources financement</li>
                        <li>Mise en place reporting financier mensuel</li>
                    </ul>
                    <p><strong>Budget :</strong> 500K-2M FCFA | <strong>ROI :</strong> Capacité développement x1.5-2.5</p>
                `;
            } else if (dimensionName.includes('Expérience')) {
                return `
                    <p><strong>Actions immédiates :</strong></p>
                    <ul>
                        <li>Recrutement responsable export expérimenté (priorité absolue)</li>
                        <li>Formation direction aux fondamentaux commerce international</li>
                        <li>Participation missions économiques et salons</li>
                        <li>Mentorat par entrepreneur exportateur expérimenté</li>
                    </ul>
                    <p><strong>Budget :</strong> 2-5M FCFA/an | <strong>ROI :</strong> Évitement erreurs coûteuses +150%</p>
                `;
            } else if (dimensionName.includes('Production')) {
                return `
                    <p><strong>Actions immédiates :</strong></p>
                    <ul>
                        <li>Audit capacité production vs projections export</li>
                        <li>Plan investissement équipements selon besoins</li>
                        <li>Formation équipes techniques et amélioration continue</li>
                        <li>Certification processus production (ISO, HACCP)</li>
                    </ul>
                    <p><strong>Budget :</strong> 3-15M FCFA | <strong>ROI :</strong> Capacité doublée, fiabilité +50%</p>
                `;
            } else {
                return `
                    <p><strong>Actions recommandées :</strong></p>
                    <ul>
                        <li>Audit spécialisé de cette dimension</li>
                        <li>Plan d'action avec expert externe</li>
                        <li>Formation équipes concernées</li>
                        <li>Mise en place outils et processus adaptés</li>
                    </ul>
                    <p><strong>Budget :</strong> À définir selon besoins | <strong>ROI :</strong> Amélioration performance export</p>
                `;
            }
        }

        // Système d'alertes
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            // Insérer en haut du contenu
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            // Supprimer après 5 secondes
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Historique des évaluations
        function saveToHistory() {
            const history = JSON.parse(localStorage.getItem('exportToolHistory') || '[]');
            
            const entry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('fr-FR'),
                time: new Date().toLocaleTimeString('fr-FR'),
                company: currentData.company,
                results: currentData.results
            };
            
            history.unshift(entry);
            
            // Garder seulement les 10 dernières évaluations
            if (history.length > 10) {
                history.splice(10);
            }
            
            localStorage.setItem('exportToolHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('exportToolHistory') || '[]');
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Aucun historique disponible.</strong><br>
                        Vos évaluations apparaîtront ici une fois que vous aurez calculé vos premiers résultats.
                    </div>
                `;
                return;
            }
            
            let html = '';
            history.forEach(entry => {
                let levelColor = '#34a853';
                if (entry.results.adjustedScore < 45) levelColor = '#ea4335';
                else if (entry.results.adjustedScore < 65) levelColor = '#ff9900';
                
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
    <h4>${entry.company.companyName}</h4>
    <p><strong>Secteur:</strong> ${entry.company.sector} | <strong>Marché cible:</strong> ${entry.company.targetMarket || 'Non spécifié'}</p>
    <p><strong>Dossier suivi par:</strong> ${entry.company.interviewer || 'Non spécifié'}</p>
    <p><strong>Date:</strong> ${entry.date} à ${entry.time}</p>
</div>
                            <div style="text-align: right;">
                                <div style="font-size: 2em; font-weight: bold; color: ${levelColor};">${entry.results.adjustedScore}%</div>
                                <div style="color: ${levelColor};">${entry.results.level}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            
<button class="btn" onclick="deleteHistoryEntry(${entry.id})" style="background: #ea4335;">
                                🗑️ Supprimer
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadHistoryEntry(entryId, section = 'results') {
            const history = JSON.parse(localStorage.getItem('exportToolHistory') || '[]');
            const entry = history.find(e => e.id === entryId);
            
            if (entry) {
                currentData.company = entry.company;
                currentData.results = entry.results;
                displayResults();
                
                // Utiliser l'effet de chargement pour afficher la section demandée
                if (section === 'detailed') {
                    showSectionWithLoading('detailed');
                } else {
                    showSectionWithLoading('results');
                }
            }
        }

        function deleteHistoryEntry(entryId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette évaluation ?')) {
                let history = JSON.parse(localStorage.getItem('exportToolHistory') || '[]');
                history = history.filter(e => e.id !== entryId);
                localStorage.setItem('exportToolHistory', JSON.stringify(history));
                loadHistory();
                showAlert('Évaluation supprimée avec succès.', 'success');
            }
        }

// Export PDF - Interface épurée avec informations entreprise complètes
async function exportToPDF(type = 'complete') {
    if (!currentData.results) {
        showAlert('Aucun résultat à exporter. Veuillez d\'abord compléter l\'évaluation.', 'warning');
        return;
    }

    if (typeof window.jspdf === 'undefined') {
        showAlert('Erreur: Librairie PDF non chargée. Veuillez rafraîchir la page.', 'error');
        return;
    }

    const exportButton = event?.target;
    const originalText = exportButton?.innerHTML;
    if (exportButton) {
        exportButton.innerHTML = '📄 Génération PDF...';
        exportButton.disabled = true;
    }

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 20;
        const usableWidth = pageWidth - (2 * margin);
        let currentY = margin;

        // COULEURS ÉPURÉES
        const aciexGreen = [34, 139, 34];
        const blueColor = [26, 115, 232];
        const orangeColor = [255, 153, 0];
        const redColor = [234, 67, 53];
        const lightGray = [240, 240, 240];
        const darkGray = [51, 51, 51];
        const textGray = [102, 102, 102];

        function checkPageBreak(requiredHeight = 25) {
            if (currentY + requiredHeight > pageHeight - margin - 15) {
                pdf.addPage();
                addPageHeader();
                currentY = margin + 20;
                return true;
            }
            return false;
        }

        function addPageHeader() {
            // En-tête simple sans fond coloré
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.3);
            pdf.line(margin, 15, pageWidth - margin, 15);
            
            pdf.setTextColor(...aciexGreen);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('ACIEX - Diagnostic Export', margin, 12);
            
            const pageNum = pdf.internal.getCurrentPageInfo().pageNumber;
            pdf.setTextColor(...textGray);
            pdf.setFontSize(8);
            pdf.text(`Page ${pageNum}`, pageWidth - margin - 15, 12);
        }

        function addText(text, x, y, maxWidth, fontSize = 10, style = 'normal', color = darkGray) {
            pdf.setFontSize(fontSize);
            pdf.setFont('helvetica', style);
            pdf.setTextColor(...color);
            
            const cleanText = text.replace(/[🔍📊🏢📋🎯📄⏳✅❌🚀💡📈🔧⚡💰🌍📅👥💼📱🎨🔥⭐🚨📞💾🎉]/g, '').replace(/\s+/g, ' ').trim();
            
            if (maxWidth) {
                const lines = pdf.splitTextToSize(cleanText, maxWidth);
                lines.forEach((line, index) => {
                    if (y + (index * fontSize * 0.4) > pageHeight - margin - 10) {
                        pdf.addPage();
                        addPageHeader();
                        y = margin + 20;
                    }
                    pdf.text(line, x, y + (index * fontSize * 0.4));
                });
                return y + (lines.length * fontSize * 0.4);
            } else {
                pdf.text(cleanText, x, y);
                return y + fontSize * 0.4;
            }
        }

        function addSectionTitle(title, color = aciexGreen) {
            checkPageBreak(15);
            pdf.setTextColor(...color);
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text(title, margin, currentY);
            
            // Ligne sous le titre
            pdf.setDrawColor(...color);
            pdf.setLineWidth(0.5);
            pdf.line(margin, currentY + 2, margin + 60, currentY + 2);
            
            currentY += 12;
        }

        function addSubSection(title, color = blueColor) {
            checkPageBreak(12);
            pdf.setTextColor(...color);
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'bold');
            pdf.text(title, margin, currentY);
            currentY += 8;
        }

        // 1. PAGE DE COUVERTURE ÉPURÉE
        function addCoverPage() {
            // Titre principal
            pdf.setTextColor(...aciexGreen);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text('DIAGNOSTIC EXPORT', pageWidth/2, 40, { align: 'center' });
            
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Evaluation des Capacites Export', pageWidth/2, 55, { align: 'center' });

            // Informations entreprise dans un cadre simple
            pdf.setDrawColor(...aciexGreen);
            pdf.setLineWidth(1);
            pdf.rect(margin, 80, usableWidth, 60, 'S');

            pdf.setTextColor(...darkGray);
            pdf.setFontSize(18);
            pdf.setFont('helvetica', 'bold');
            pdf.text(currentData.company.companyName || 'Entreprise', pageWidth/2, 95, { align: 'center' });

            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Secteur: ${currentData.company.sector || 'Non specifie'}`, pageWidth/2, 108, { align: 'center' });
            pdf.text(`Marche cible: ${currentData.company.targetMarket || 'Non specifie'}`, pageWidth/2, 118, { align: 'center' });
            pdf.text(`Agent ACIEX: ${currentData.company.interviewer || 'Non specifie'}`, pageWidth/2, 128, { align: 'center' });

            // Score dans un cercle simple
            const scoreColor = currentData.results.adjustedScore >= 80 ? [52, 168, 83] : 
                             currentData.results.adjustedScore >= 65 ? blueColor :
                             currentData.results.adjustedScore >= 45 ? orangeColor : redColor;

            pdf.setDrawColor(...scoreColor);
            pdf.setLineWidth(3);
            pdf.circle(pageWidth/2, 175, 25, 'S');
            
            pdf.setTextColor(...scoreColor);
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text(`${currentData.results.adjustedScore}%`, pageWidth/2, 180, { align: 'center' });

            pdf.setFontSize(12);
            pdf.text(currentData.results.level, pageWidth/2, 205, { align: 'center' });

            pdf.setTextColor(...textGray);
            pdf.setFontSize(9);
            pdf.text(`Rapport genere le ${new Date().toLocaleDateString('fr-FR')}`, pageWidth/2, 240, { align: 'center' });

            pdf.addPage();
            addPageHeader();
            currentY = margin + 25;
        }

        // 2. INFORMATIONS ENTREPRISE COMPLÈTES (PREMIÈRE SECTION)
        function addCompanyInformation() {
            addSectionTitle('INFORMATIONS DE L\'ENTREPRISE');

            // Informations de base
            addSubSection('Identite de l\'entreprise');
            currentY = addText(`Nom: ${currentData.company.companyName || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 5;
            currentY = addText(`Secteur d'activite: ${currentData.company.sector || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 5;
            currentY = addText(`Pays du siege social: ${currentData.company.country || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 5;
            currentY = addText(`Email de contact: ${currentData.company.email || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 10;

            // Taille et finances
            addSubSection('Taille et Finances');
            currentY = addText(`Nombre d'employes: ${currentData.company.employees || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 5;
            currentY = addText(`Chiffre d'affaires annuel: ${currentData.company.revenue || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 10;

            // Dirigeant
            addSubSection('Profil du dirigeant');
            currentY = addText(`Sexe: ${currentData.company.leaderGender || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 5;
            currentY = addText(`Tranche d'age: ${currentData.company.leaderAge || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 10;

            // Marchés
            addSubSection('Marches et Export');
            currentY = addText(`Marches actuels: ${(currentData.company.currentMarkets || []).join(', ') || 'Non specifies'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 5;
            currentY = addText(`Marche cible prioritaire: ${currentData.company.targetMarket || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 10;

            // Suivi ACIEX
            addSubSection('Suivi ACIEX');
            currentY = addText(`Dossier suivi par: ${currentData.company.interviewer || 'Non specifie'}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 5;
            currentY = addText(`Date d'evaluation: ${currentData.results.calculationDate || new Date().toLocaleDateString('fr-FR')}`, margin + 5, currentY, usableWidth - 10, 10, 'normal');
            currentY += 15;
        }

        // 3. RÉSULTATS GLOBAUX
        function addGlobalResults() {
            addSectionTitle('RESULTATS GLOBAUX');

            const scoreColor = currentData.results.adjustedScore >= 80 ? [52, 168, 83] : 
                             currentData.results.adjustedScore >= 65 ? blueColor :
                             currentData.results.adjustedScore >= 45 ? orangeColor : redColor;

            // Scores en tableau simple
            pdf.setTextColor(...scoreColor);
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            currentY = addText(`Score global: ${currentData.results.globalScore}%`, margin, currentY, usableWidth, 16, 'bold', scoreColor);
            currentY += 5;
            
            currentY = addText(`Score ajuste secteur: ${currentData.results.adjustedScore}%`, margin, currentY, usableWidth, 16, 'bold', scoreColor);
            currentY += 5;
            
            pdf.setFontSize(12);
            currentY = addText(`Niveau: ${currentData.results.level}`, margin, currentY, usableWidth, 12, 'bold', scoreColor);
            currentY += 10;

            // Explication ajustement si différent
            if (currentData.results.globalScore !== currentData.results.adjustedScore) {
                addSubSection('Explication de l\'ajustement sectoriel');
                const adjustmentText = getAdjustmentExplanation(currentData.company.sector, currentData.results.globalScore, currentData.results.adjustedScore);
                currentY = addText(adjustmentText, margin + 5, currentY, usableWidth - 10, 9, 'normal', textGray);
                currentY += 10;
            }
        }

        // 4. SCORES PAR DIMENSION ÉPURÉS
        function addDimensionScores() {
            addSectionTitle('SCORES PAR DIMENSION');

            currentData.results.dimensionScores.forEach((dimension, index) => {
                checkPageBreak(10);
                
                const dimName = dimension.name.replace(/^\d+\.\s*/, '');
                
                // Nom et pourcentage
                pdf.setTextColor(...darkGray);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                pdf.text(dimName, margin, currentY);
                
                pdf.setTextColor(...textGray);
                pdf.text(`${dimension.percentage}%`, pageWidth - margin - 20, currentY);
                
                // Barre de progression minimaliste
                const barWidth = 80;
                const barHeight = 2;
                const barX = pageWidth - margin - 100;
                
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(barHeight);
                pdf.line(barX, currentY - 2, barX + barWidth, currentY - 2);
                
                const fillWidth = (dimension.percentage / 100) * barWidth;
                const barColor = dimension.percentage >= 75 ? [52, 168, 83] : 
                                dimension.percentage >= 50 ? orangeColor : redColor;
                
                pdf.setDrawColor(...barColor);
                pdf.line(barX, currentY - 2, barX + fillWidth, currentY - 2);
                
                // Détails en petit
                pdf.setTextColor(...textGray);
                pdf.setFontSize(8);
                pdf.text(`Poids: ${dimension.weight}% | Score: ${dimension.rawScore}/${dimension.maxScore}`, margin + 5, currentY + 4);
                
                currentY += 12;
            });

            currentY += 10;
        }

        // 5. ACTIONS PRIORITAIRES (épuré)
        function addSpecificRecommendations() {
            const specificRecommendations = generateSpecificRecommendations(currentData.scores, 'detailed');

            if (specificRecommendations.length > 0) {
                addSectionTitle('ACTIONS PRIORITAIRES SPECIFIQUES');
                
                currentY = addText(`${specificRecommendations.length} actions identifiees comme necessitant une amelioration immediate:`, margin, currentY, usableWidth, 10, 'normal', textGray);
                currentY += 8;

                specificRecommendations.slice(0, 8).forEach((rec, index) => {
                    checkPageBreak(15);
                    
                    const priorityColor = rec.priority === 'CRITIQUE' ? redColor : orangeColor;
                    
                    // Numéro et priorité
                    pdf.setTextColor(...priorityColor);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(`${index + 1}. ${rec.priority}`, margin, currentY);
                    
                    // Dimension
                    pdf.setTextColor(...darkGray);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(rec.dimension, margin + 25, currentY);
                    currentY += 5;
                    
                    // Action
                    currentY = addText(`${rec.text}`, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
                    currentY += 8;
                });
            }
        }

        // 6. PLAN STRATÉGIQUE SIMPLIFIÉ
        function addStrategicPlan() {
            addSectionTitle('PLAN STRATEGIQUE');

            const score = currentData.results.adjustedScore;
            let timeline, budget, actions;
            
            if (score >= 80) {
                timeline = "0-3 mois";
                budget = "1-3M FCFA";
                actions = "Lancement immediat possible - Documentation finale et prospection active";
            } else if (score >= 65) {
                timeline = "3-6 mois";
                budget = "3-8M FCFA";
                actions = "Ajustements necessaires - Corrections prioritaires puis lancement";
            } else if (score >= 45) {
                timeline = "6-12 mois";
                budget = "5-15M FCFA";
                actions = "Developpement structure - Renforcement capacites et certifications";
            } else {
                timeline = "12-24 mois";
                budget = "10-30M FCFA";
                actions = "Consolidation fondamentaux - Audit complet et restructuration";
            }

            currentY = addText(`Delai recommande: ${timeline}`, margin, currentY, usableWidth, 11, 'bold', darkGray);
            currentY += 6;
            currentY = addText(`Budget estime: ${budget}`, margin, currentY, usableWidth, 11, 'bold', darkGray);
            currentY += 6;
            currentY = addText(`ROI attendu: 200-400% sur 2-3 ans`, margin, currentY, usableWidth, 10, 'normal', textGray);
            currentY += 8;
            currentY = addText(`Strategie: ${actions}`, margin, currentY, usableWidth, 10, 'normal', darkGray);
            currentY += 15;
        }

// 7. PLAN STRATÉGIQUE DÉTAILLÉ - EXPORT (comme dans l'interface)
        function addDetailedStrategicPlanFromInterface() {
            addSectionTitle('PLAN STRATEGIQUE DETAILLE - EXPORT');

            // Récupérer les données du diagnostic détaillé existant
            const countryData = countryProfiles[currentData.company.targetMarket];
            
            // FEUILLE DE ROUTE STRATÉGIQUE (utilise la fonction existante)
            addSubSection('Feuille de route strategique');
            const timeline = generateDetailedTimeline(currentData.results, countryData, currentData.company);
            
            // Parser le HTML pour extraire le texte
            const timelineText = timeline
                .replace(/<[^>]*>/g, '') // Supprimer les balises HTML
                .replace(/PHASE \d+ - /g, '\n• PHASE ') // Formater les phases
                .replace(/\n\s*\n/g, '\n') // Supprimer les lignes vides multiples
                .trim();
            
            currentY = addText(timelineText, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
            currentY += 10;

            // PLAN D'INVESTISSEMENT (utilise la fonction existante)
            addSubSection('Plan d\'investissement');
            const investment = calculateDetailedInvestment(currentData.results, countryData, currentData.company);
            const investmentText = investment
                .replace(/<[^>]*>/g, '')
                .replace(/•/g, '• ')
                .trim();
            
            currentY = addText(investmentText, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
            currentY += 10;

            // INDICATEURS DE PERFORMANCE (utilise la fonction existante)
            addSubSection('Indicateurs de performance');
            const kpis = defineKPIs(currentData.results, countryData, currentData.company);
            const kpisText = kpis
                .replace(/<[^>]*>/g, '')
                .replace(/•/g, '• ')
                .trim();
            
            currentY = addText(kpisText, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
            currentY += 10;

            // FACTEURS CLÉS DE SUCCÈS (utilise la fonction existante)
            addSubSection('Facteurs cles de succes');
            const successFactors = generateSuccessFactors(currentData.results, countryData, currentData.company);
            const factorsText = successFactors
                .replace(/<[^>]*>/g, '')
                .replace(/•/g, '• ')
                .trim();
            
            currentY = addText(factorsText, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
            currentY += 15;
        }

        // 8. ALERTES ET DÉFAILLANCES CRITIQUES (comme dans l'interface)
        function addCriticalAlertsFromInterface() {
            // Utiliser la fonction existante pour analyser les questions critiques
            const criticalAnalysis = analyzeCriticalQuestions();
            const hasCriticalQuestions = criticalAnalysis.critical.length > 0 || criticalAnalysis.warning.length > 0;

            if (hasCriticalQuestions) {
                addSectionTitle('ALERTE - DEFAILLANCES CRITIQUES DETECTEES', redColor);
                
                currentY = addText('Malgre un score global satisfaisant, des faiblesses majeures ont ete identifiees sur des questions specifiques:', margin, currentY, usableWidth, 10, 'bold', [200, 44, 40]);
                currentY += 8;

                // DÉFAILLANCES CRITIQUES (Score 1/4)
                if (criticalAnalysis.critical.length > 0) {
                    addSubSection('DEFAILLANCES CRITIQUES (Score 1/4)');
                    
                    criticalAnalysis.critical.forEach(item => {
                        checkPageBreak(10);
                        const statement = transformQuestionToStatement(item.question);
                        const dimName = item.dimension.replace(/^\d+\.\s*/, '');
                        
                        pdf.setTextColor(...redColor);
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'bold');
                        currentY = addText(`• ${dimName}:`, margin + 5, currentY, usableWidth - 10, 9, 'bold', redColor);
                        currentY += 4;
                        
                        currentY = addText(statement, margin + 10, currentY, usableWidth - 15, 8, 'normal', darkGray);
                        currentY += 6;
                    });
                    
                    currentY = addText('URGENCE ABSOLUE: Ces elements doivent etre corriges avant tout lancement export!', margin, currentY, usableWidth, 10, 'bold', redColor);
                    currentY += 10;
                }

                // FAIBLESSES IMPORTANTES (Score 2/4)
                if (criticalAnalysis.warning.length > 0) {
                    addSubSection('FAIBLESSES IMPORTANTES (Score 2/4)');
                    
                    criticalAnalysis.warning.forEach(item => {
                        checkPageBreak(10);
                        const statement = transformQuestionToStatement(item.question);
                        const dimName = item.dimension.replace(/^\d+\.\s*/, '');
                        
                        pdf.setTextColor(...orangeColor);
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'bold');
                        currentY = addText(`• ${dimName}:`, margin + 5, currentY, usableWidth - 10, 9, 'bold', orangeColor);
                        currentY += 4;
                        
                        currentY = addText(statement, margin + 10, currentY, usableWidth - 15, 8, 'normal', darkGray);
                        currentY += 6;
                    });
                    
                    currentY = addText('PRIORITE HAUTE: Amelioration obligatoire avant export.', margin, currentY, usableWidth, 10, 'bold', orangeColor);
                    currentY += 15;
                }
            } else {
                addSectionTitle('ANALYSE DES REPONSES');
                currentY = addText('Aucune defaillance critique identifiee dans vos reponses. Votre profil presente une coherence satisfaisante pour le developpement export.', margin, currentY, usableWidth, 10, 'normal', aciexGreen);
                currentY += 15;
            }
        }

// 7. PLAN STRATÉGIQUE DÉTAILLÉ - EXPORT
        function addDetailedStrategicPlan() {
            addSectionTitle('PLAN STRATEGIQUE DETAILLE - EXPORT');

            const score = currentData.results.adjustedScore;
            
            // FEUILLE DE ROUTE STRATÉGIQUE
            addSubSection('Feuille de route strategique');
            
            let phases = [];
            if (score >= 70) {
                phases = [
                    { phase: 'PHASE 1', period: 'Mois 1-2', title: 'Finalisation Preparatifs', tasks: ['Documentation commerciale', 'Certifications finales', 'Echantillonnage'] },
                    { phase: 'PHASE 2', period: 'Mois 2-4', title: 'Prospection Active', tasks: ['Participation salons', 'Missions commerciales', 'Negociations distributeurs'] },
                    { phase: 'PHASE 3', period: 'Mois 4-6', title: 'Premiers Contrats', tasks: ['Signature accords', 'Livraisons pilotes', 'Ajustements operationnels'] },
                    { phase: 'PHASE 4', period: 'Mois 6+', title: 'Montee en Puissance', tasks: ['Developpement volumes', 'Extension gamme', 'Consolidation partenariats'] }
                ];
            } else if (score >= 50) {
                phases = [
                    { phase: 'PHASE 1', period: 'Mois 1-4', title: 'Renforcement Capacites', tasks: ['Formation equipes', 'Mise aux normes', 'Processus qualite'] },
                    { phase: 'PHASE 2', period: 'Mois 4-8', title: 'Preparation Marche', tasks: ['Etude marche approfondie', 'Adaptation produits', 'Strategie prix'] },
                    { phase: 'PHASE 3', period: 'Mois 8-12', title: 'Tests Marche', tasks: ['Echantillonnage', 'Prospection selective', 'Validation concept'] },
                    { phase: 'PHASE 4', period: 'Mois 12+', title: 'Lancement Commercial', tasks: ['Entree marche', 'Premiers clients', 'Optimisation continue'] }
                ];
            } else {
                phases = [
                    { phase: 'PHASE 1', period: 'Mois 1-6', title: 'Consolidation Interne', tasks: ['Audit complet', 'Plan redressement', 'Investissements prioritaires'] },
                    { phase: 'PHASE 2', period: 'Mois 6-12', title: 'Developpement Capacites', tasks: ['Formation intensive', 'Certifications', 'Systemes qualite'] },
                    { phase: 'PHASE 3', period: 'Mois 12-18', title: 'Preparation Export', tasks: ['Veille concurrentielle', 'Adaptation offre', 'Partenariats strategiques'] },
                    { phase: 'PHASE 4', period: 'Mois 18+', title: 'Demarrage Export', tasks: ['Prospection pilote', 'Tests marche', 'Premiers contrats'] }
                ];
            }
            
            phases.forEach((phase, index) => {
                checkPageBreak(12);
                
                pdf.setTextColor(...blueColor);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                currentY = addText(`${phase.phase} - ${phase.title} (${phase.period})`, margin + 5, currentY, usableWidth - 10, 10, 'bold', blueColor);
                currentY += 4;
                
                phase.tasks.forEach(task => {
                    currentY = addText(`• ${task}`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
                    currentY += 4;
                });
                currentY += 6;
            });

            // PLAN D'INVESTISSEMENT DÉTAILLÉ
            addSubSection('Plan d\'investissement detaille');
            
            const baseBudgets = {
                preparation: score < 50 ? 3000000 : score < 70 ? 1500000 : 800000,
                marketing: score < 50 ? 2000000 : score < 70 ? 1200000 : 800000,
                operations: score < 50 ? 5000000 : score < 70 ? 3000000 : 1500000,
                certification: score < 50 ? 2500000 : score < 70 ? 1800000 : 1000000
            };
            
            const multiplier = getSectorCoefficient(currentData.company.sector);
            
            currentY = addText(`Repartition budgetaire (coefficient secteur: ${multiplier.toFixed(1)}):`, margin + 5, currentY, usableWidth - 10, 10, 'bold', darkGray);
            currentY += 6;
            
            currentY = addText(`• Preparation/Formation: ${Math.round(baseBudgets.preparation * multiplier / 1000)}K FCFA`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 4;
            currentY = addText(`• Marketing/Commercial: ${Math.round(baseBudgets.marketing * multiplier / 1000)}K FCFA`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 4;
            currentY = addText(`• Operations/Logistique: ${Math.round(baseBudgets.operations * multiplier / 1000)}K FCFA`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 4;
            currentY = addText(`• Certifications/Conformite: ${Math.round(baseBudgets.certification * multiplier / 1000)}K FCFA`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 6;
            
            const totalBudget = Math.round((baseBudgets.preparation + baseBudgets.marketing + baseBudgets.operations + baseBudgets.certification) * multiplier / 1000000);
            currentY = addText(`TOTAL INVESTISSEMENT: ${totalBudget}M FCFA`, margin + 5, currentY, usableWidth - 10, 11, 'bold', aciexGreen);
            currentY += 4;
            currentY = addText(`ROI attendu: 200-400% sur 2-3 ans`, margin + 5, currentY, usableWidth - 10, 9, 'normal', textGray);
            currentY += 10;

            // INDICATEURS DE PERFORMANCE (KPIs)
            addSubSection('Indicateurs de performance (KPIs)');
            
            const kpis = {
                preparation: {
                    '6 mois': score >= 70 ? '95%' : score >= 50 ? '85%' : '70%',
                    '12 mois': '98%'
                },
                commercial: {
                    'Prospects qualifiés': score >= 70 ? '20-30' : score >= 50 ? '15-25' : '10-15',
                    'Premiers contrats': score >= 70 ? '3-6 mois' : score >= 50 ? '6-12 mois' : '12-18 mois'
                },
                financial: {
    'CA export Y1': score >= 70 ? '5-12%' : score >= 50 ? '3-8%' : '1-5%',
    'CA export Y3': score >= 70 ? '15-25%' : score >= 50 ? '10-20%' : '5-15%'
}
            };
            
            currentY = addText(`Objectifs Preparation:`, margin + 5, currentY, usableWidth - 10, 10, 'bold', darkGray);
            currentY += 4;
            currentY = addText(`• 6 mois: ${kpis.preparation['6 mois']} capacites operationnelles`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 4;
            currentY = addText(`• 12 mois: ${kpis.preparation['12 mois']} pret export`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 6;
            
            currentY = addText(`Objectifs Commerciaux:`, margin + 5, currentY, usableWidth - 10, 10, 'bold', darkGray);
            currentY += 4;
            currentY = addText(`• Prospects: ${kpis.commercial['Prospects qualifiés']}/an`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 4;
            currentY = addText(`• Premiers contrats: ${kpis.commercial['Premiers contrats']}`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 6;
            
            currentY = addText(`Objectifs Financiers:`, margin + 5, currentY, usableWidth - 10, 10, 'bold', darkGray);
            currentY += 4;
            currentY = addText(`• CA export Annee 1: ${kpis.financial['CA export Y1']}`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 4;
            currentY = addText(`• CA export Annee 3: ${kpis.financial['CA export Y3']}`, margin + 10, currentY, usableWidth - 15, 9, 'normal', darkGray);
            currentY += 10;

            // FACTEURS CLÉS DE SUCCÈS
            addSubSection('Facteurs cles de succes');
            
            const factors = [
                'Excellence qualite produits et respect strict standards cible',
                'Adaptation culturelle et linguistique de l\'approche commerciale',
                'Partenariats locaux strategiques (distributeurs, prescripteurs)',
                'Pricing competitif avec marges preservees',
                'Service client reactif et support technique',
                'Conformite reglementaire anticipee et maintenue',
                'Innovation continue et veille concurrentielle',
                'Flexibilite operationnelle et capacite d\'adaptation'
            ];
            
            factors.forEach((factor, index) => {
                currentY = addText(`${index + 1}. ${factor}`, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
                currentY += 5;
            });
            
            currentY += 10;
        }

        // 7. SERVICES ACIEX RECOMMANDÉS
        function addAciexServices() {
            addSectionTitle('SERVICES ACIEX RECOMMANDES');

            const services = [
                'Formation et coaching export personnalise',
                'Accompagnement certification et mise aux normes',
                'Missions commerciales dans votre marche cible',
                'Appui technique specialise selon vos faiblesses',
                'Mise en relation avec partenaires locaux'
            ];
            
            services.forEach((service, index) => {
                currentY = addText(`• ${service}`, margin + 5, currentY, usableWidth - 10, 10, 'normal', darkGray);
                currentY += 6;
            });
            
            currentY += 5;
            currentY = addText('Contact ACIEX pour un accompagnement personnalise adapte a vos besoins specifiques.', margin, currentY, usableWidth, 9, 'italic', textGray);
        }

// 7. ALERTE - DÉFAILLANCES CRITIQUES (exactement comme l'interface)
        function addCriticalDefaillancesAlert() {
            const criticalAnalysis = analyzeCriticalQuestions();
            const hasCriticalQuestions = criticalAnalysis.critical.length > 0 || criticalAnalysis.warning.length > 0;

            if (hasCriticalQuestions) {
                addSectionTitle('ALERTE - DEFAILLANCES CRITIQUES DETECTEES', redColor);
                
                currentY = addText('Malgre un score global satisfaisant, des faiblesses majeures ont ete identifiees sur des questions specifiques :', margin, currentY, usableWidth, 10, 'normal', [200, 44, 40]);
                currentY += 10;

                // DÉFAILLANCES CRITIQUES (Score 1/4)
                if (criticalAnalysis.critical.length > 0) {
                    pdf.setTextColor(...redColor);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    currentY = addText('DEFAILLANCES CRITIQUES (Score 1/4) :', margin, currentY, usableWidth, 10, 'bold', redColor);
                    currentY += 6;
                    
                    criticalAnalysis.critical.forEach(item => {
                        checkPageBreak(8);
                        const statement = transformQuestionToStatement(item.question);
                        const dimName = item.dimension.replace(/^\d+\.\s*/, '');
                        currentY = addText(`• ${dimName} : ${statement}`, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
                        currentY += 6;
                    });
                    
                    currentY = addText('URGENCE ABSOLUE : Ces elements doivent etre corriges avant tout lancement export !', margin, currentY, usableWidth, 10, 'bold', redColor);
                    currentY += 10;
                }

                // FAIBLESSES IMPORTANTES (Score 2/4)
                if (criticalAnalysis.warning.length > 0) {
                    pdf.setTextColor(...orangeColor);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    currentY = addText('FAIBLESSES IMPORTANTES (Score 2/4) :', margin, currentY, usableWidth, 10, 'bold', orangeColor);
                    currentY += 6;
                    
                    criticalAnalysis.warning.forEach(item => {
                        checkPageBreak(8);
                        const statement = transformQuestionToStatement(item.question);
                        const dimName = item.dimension.replace(/^\d+\.\s*/, '');
                        currentY = addText(`• ${dimName} : ${statement}`, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
                        currentY += 6;
                    });
                    
                    currentY = addText('PRIORITE HAUTE : Amelioration obligatoire avant export.', margin, currentY, usableWidth, 10, 'bold', orangeColor);
                    currentY += 15;
                }
            }
        }

        // 8. ACTIONS PRIORITAIRES SPÉCIFIQUES (exactement comme l'interface)
        function addActionsSpecifiques() {
            const specificRecommendations = generateSpecificRecommendations(currentData.scores, 'short');

            if (specificRecommendations.length > 0) {
                addSectionTitle('ACTIONS PRIORITAIRES SPECIFIQUES', orangeColor);
                
                currentY = addText('Base sur vos reponses detaillees, voici les ameliorations specifiques necessaires :', margin, currentY, usableWidth, 10, 'normal', darkGray);
                currentY += 10;

                specificRecommendations.forEach((rec, index) => {
                    checkPageBreak(15);
                    
                    const priorityColor = rec.priority === 'CRITIQUE' ? redColor : orangeColor;
                    
                    // Badge priorité
                    pdf.setFillColor(...priorityColor);
                    pdf.rect(margin, currentY, 20, 6, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(rec.priority, margin + 2, currentY + 4);
                    
                    // Dimension
                    pdf.setTextColor(...darkGray);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(rec.dimension, margin + 25, currentY + 4);
                    currentY += 8;
                    
                    // Recommandation
                    currentY = addText(rec.text, margin + 5, currentY, usableWidth - 10, 9, 'normal', darkGray);
                    currentY += 8;
                });
                
                currentY += 10;
            }
        }

        // GÉNÉRATION DANS L'ORDRE EXACT

        // GÉNÉRATION DANS L'ORDRE EXACT
        addCoverPage();
        addCompanyInformation();
        addGlobalResults();
        addDimensionScores();
        addSpecificRecommendations();
        addStrategicPlan();
        addDetailedStrategicPlan();
        addCriticalDefaillancesAlert();  // NOUVEAU
        addActionsSpecifiques();         // NOUVEAU

        const fileName = `Diagnostic_Export_${currentData.company.companyName?.replace(/[^a-zA-Z0-9]/g, '_') || 'Entreprise'}_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        
        showAlert('Rapport PDF epure genere avec toutes les informations entreprise !', 'success');

    } catch (error) {
        console.error('Erreur generation PDF:', error);
        showAlert('Erreur lors de la generation du PDF. Veuillez reessayer.', 'error');
    } finally {
        if (exportButton) {
            exportButton.innerHTML = originalText || 'Telecharger Rapport PDF';
            exportButton.disabled = false;
        }
    }
}

// =================================
// =================================
// GOOGLE SHEETS EXPORT FUNCTIONS - API REST
// =================================

let isGoogleSheetsReady = true; // Toujours prêt avec l'API REST

// Fonction d'initialisation simplifiée
function initGoogleAPI() {
    console.log('🔧 Initialisation Google Sheets (API REST)...');
    
    // Vérifier la configuration
    if (GOOGLE_SHEETS_CONFIG.apiKey === 'TON_API_KEY_ICI' || 
        GOOGLE_SHEETS_CONFIG.spreadsheetId === 'TON_SPREADSHEET_ID_ICI') {
        console.log('⚠️ Configuration non complétée');
        return;
    }
    
    console.log('✅ Google Sheets API REST prêt !');
    isGoogleSheetsReady = true;
    showGoogleSheetsButton();
}

// Afficher le bouton Google Sheets
function showGoogleSheetsButton() {
    console.log('🔍 Recherche du bouton Google Sheets...');
    const buttons = document.querySelectorAll('.google-sheets-btn');
    console.log('🔍 Boutons trouvés:', buttons.length);
    
    buttons.forEach((btn, index) => {
        console.log(`🔍 Bouton ${index}:`, btn);
        btn.style.display = 'inline-block';
        btn.disabled = false;
        console.log('✅ Bouton affiché');
    });
    
    if (buttons.length === 0) {
        console.log('❌ Aucun bouton avec la classe google-sheets-btn trouvé !');
    }
}

// Exporter vers Google Sheets via Apps Script (méthode alternative)
async function exportToGoogleSheets() {
    if (!currentData.results) {
        showAlert('Aucun résultat à exporter. Veuillez d\'abord compléter l\'évaluation.', 'warning');
        return;
    }

    const exportButton = event?.target;
    const originalText = exportButton?.innerHTML;
    if (exportButton) {
        exportButton.innerHTML = '⏳ Export en cours...';
        exportButton.disabled = true;
    }

    try {
        console.log('📊 Début export Google Sheets (Apps Script)...');
        
        // Préparer les données d'export
        const exportData = prepareExportData();
        
        // Préparer les données pour Apps Script
        const sheetData = prepareSheetData(exportData);
        
        // Créer un formulaire invisible pour envoyer les données
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = APPS_SCRIPT_URL;
        form.target = '_blank';
        form.style.display = 'none';
        
        const input = document.createElement('textarea');
        input.name = 'data';
        input.value = JSON.stringify(sheetData);
        form.appendChild(input);
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        console.log('✅ Export lancé vers Google Apps Script');
        showAlert('✅ Export lancé ! Vérifiez votre Google Sheet dans quelques secondes.', 'success');
        
    } catch (error) {
        console.error('❌ Erreur export Google Sheets:', error);
        showAlert(`❌ Erreur lors de l'export: ${error.message}`, 'error');
    } finally {
        if (exportButton) {
            exportButton.innerHTML = originalText || '📊 Exporter vers Google Sheets';
            exportButton.disabled = false;
        }
    }
}

// Préparer les données pour l'export (identique à avant)
function prepareExportData() {
    const company = currentData.company;
    const results = currentData.results;
    
    const questionResponses = [];
    dimensions.forEach((dimension, dimIndex) => {
        dimension.questions.forEach((question, qIndex) => {
            const questionId = `${dimIndex}-${qIndex}`;
            const score = currentData.scores[questionId] || 0;
            questionResponses.push({
                dimension: dimension.title,
                question: question,
                score: score,
                scoreText: getScoreText(score)
            });
        });
    });

    return {
        companyName: company.companyName || 'Entreprise_Inconnue',
        sector: company.sector || 'Non spécifié',
        employees: company.employees || 'Non spécifié',
        revenue: company.revenue || 'Non spécifié',
        country: company.country || 'Non spécifié',
        email: company.email || 'Non spécifié',
	interviewer: company.interviewer || 'Non spécifié',
leaderGender: company.leaderGender || 'Non spécifié',
leaderAge: company.leaderAge || 'Non spécifié',
        currentMarkets: (company.currentMarkets || []).join(', ') || 'Non spécifiés',
        targetMarket: company.targetMarket || 'Non spécifié',
        globalScore: results.globalScore,
        adjustedScore: results.adjustedScore,
        level: results.level,
        standardDeviation: results.standardDeviation,
        calculationDate: results.calculationDate,
        dimensionScores: results.dimensionScores,
        questionResponses: questionResponses,
        recommendations: generateRecommendationsText(results, company),
        exportDate: new Date().toLocaleDateString('fr-FR'),
        exportTime: new Date().toLocaleTimeString('fr-FR')
    };
}

// Préparer les données pour Google Apps Script
function prepareSheetData(data) {
    const cleanName = data.companyName
        .replace(/[^a-zA-Z0-9\s\-_]/g, '')
        .substring(0, 100)
        .trim();
    
    const timestamp = new Date().toISOString().slice(0, 10);
    const sheetName = `${cleanName}_${timestamp}`;
    
    const values = [];
    
    // En-tête principal
    values.push(['=== DIAGNOSTIC EXPORT ACIEX ===']);
    values.push(['']);
    
    // Informations entreprise
    values.push(['INFORMATIONS ENTREPRISE']);
    values.push(['Nom entreprise', data.companyName]);
    values.push(['Secteur', data.sector]);
    values.push(['Employés', data.employees]);
    values.push(['CA annuel', data.revenue]);
    values.push(['Pays siège', data.country]);
    values.push(['Email', data.email]);
    values.push(['Dossier suivi par', data.interviewer]);
    values.push(['Marchés actuels', data.currentMarkets]);
    values.push(['Marché cible', data.targetMarket]);
values.push(['Sexe dirigeant', data.leaderGender]);
values.push(['Âge dirigeant', data.leaderAge]);
    values.push(['']);
    
    // Résultats globaux
    values.push(['RÉSULTATS GLOBAUX']);
    values.push(['Score global', data.globalScore + '%']);
    values.push(['Score ajusté', data.adjustedScore + '%']);
    values.push(['Niveau', data.level]);
    values.push(['Écart-type', data.standardDeviation]);
    values.push(['Date calcul', data.calculationDate]);
    values.push(['']);
    
    // Scores par dimension
    values.push(['SCORES PAR DIMENSION']);
    values.push(['Dimension', 'Score (%)', 'Poids', 'Score brut', 'Score max']);
    data.dimensionScores.forEach(dim => {
        values.push([
            dim.name.replace(/^\d+\.\s*/, ''),
            dim.percentage,
            dim.weight,
            dim.rawScore,
            dim.maxScore
        ]);
    });
    values.push(['']);
    
    // Réponses détaillées aux questions
    values.push(['RÉPONSES DÉTAILLÉES (50 QUESTIONS)']);
    values.push(['Dimension', 'Question', 'Score (1-4)', 'Réponse']);
    data.questionResponses.forEach(response => {
        values.push([
            response.dimension.replace(/^\d+\.\s*/, ''),
            response.question,
            response.score,
            response.scoreText
        ]);
    });
    values.push(['']);
    
    // Recommandations
    values.push(['RECOMMANDATIONS']);
    const recommendationsLines = data.recommendations.split('\n');
    recommendationsLines.forEach(line => {
        if (line.trim()) {
            values.push([line.trim()]);
        }
    });
    values.push(['']);
    
    // Métadonnées export
    values.push(['MÉTADONNÉES EXPORT']);
    values.push(['Date export', data.exportDate]);
    values.push(['Heure export', data.exportTime]);
    values.push(['Outil', 'ACIEX Diagnostic Export v3.1']);
    
    return {
        sheetName: sheetName,
        values: values
    };
}

// Convertir score numérique en texte (pour export)
function getScoreText(score) {
    switch(score) {
        case 1: return 'Niveau 1 (Faible)';
        case 2: return 'Niveau 2 (Moyen)';
        case 3: return 'Niveau 3 (Bon)';
        case 4: return 'Niveau 4 (Excellent)';
        default: return 'Non répondu';
    }
}

// Générer le texte des recommandations
function generateRecommendationsText(results, company) {
    const weakDimensions = results.dimensionScores.filter(d => d.percentage < 50);
    const score = results.adjustedScore;
    
    let recommendations = `RECOMMANDATIONS POUR ${company.companyName}\n\n`;
    recommendations += `Score global: ${score}% (${results.level})\n\n`;
    
    if (score >= 80) {
        recommendations += "EXCELLENT NIVEAU - Lancement export immédiat recommandé\n";
        recommendations += "Actions: Documentation finale, prospection active, premiers contrats\n";
        recommendations += "Délai: 0-3 mois\nBudget: 1-3M FCFA\n\n";
    } else if (score >= 65) {
        recommendations += "BON POTENTIEL - Ajustements nécessaires avant export\n";
        recommendations += "Actions: Corrections prioritaires, préparation finale\n";
        recommendations += "Délai: 3-6 mois\nBudget: 3-8M FCFA\n\n";
    } else if (score >= 45) {
        recommendations += "DÉVELOPPEMENT STRUCTURÉ REQUIS\n";
        recommendations += "Actions: Renforcement capacités, certifications, adaptation offre\n";
        recommendations += "Délai: 6-12 mois\nBudget: 5-15M FCFA\n\n";
    } else {
        recommendations += "CONSOLIDATION FONDAMENTAUX URGENTE\n";
        recommendations += "Actions: Audit organisation, formation management, investissements\n";
        recommendations += "Délai: 12-24 mois\nBudget: 10-30M FCFA\n\n";
    }
    
    if (weakDimensions.length > 0) {
        recommendations += "DIMENSIONS À RENFORCER EN PRIORITÉ:\n";
        weakDimensions.slice(0, 3).forEach(dim => {
            recommendations += `- ${dim.name.replace(/^\d+\.\s*/, '')} (${dim.percentage}%)\n`;
        });
        recommendations += "\n";
    }
    
    recommendations += "CONTACT: ACIEX pour accompagnement personnalisé\n";
    recommendations += `Marché cible: ${company.targetMarket}\nSecteur: ${company.sector}`;
    
    return recommendations;
}

// =================================
// FIN GOOGLE SHEETS FUNCTIONS
// =================================

// IA pour identifier les importateurs potentiels
class ImportersAI {
    constructor() {
        this.hfToken = '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'; // Utilisez votre token
        this.apiUrl = 'https://api-inference.huggingface.co/models/microsoft/DialoGPT-large';
        this.isProcessing = false;
    }

    // Générer automatiquement la liste d'importateurs
    async generateImportersList(company, targetCountries) {
        if (this.isProcessing) return null;
        
        this.isProcessing = true;
        console.log('🔍 Recherche d\'importateurs pour:', company.sector, 'dans:', targetCountries);

        try {
            // Construire le prompt automatiquement
            const prompt = this.buildImportersPrompt(company.sector, targetCountries);
            console.log('📝 Prompt généré:', prompt);

            // Appeler l'IA
            const response = await this.callAIForImporters(prompt);
            
            // Parser la réponse pour extraire les entreprises
            const importersList = this.parseImportersResponse(response, company.sector, targetCountries);
            
            return importersList;
            
        } catch (error) {
            console.error('❌ Erreur IA Importateurs:', error);
            return this.getFallbackImporters(company.sector, targetCountries);
        } finally {
            this.isProcessing = false;
        }
    }

    // Construire le prompt automatiquement
    buildImportersPrompt(sector, targetCountries) {
        const sectorMapping = {
            'Agro-alimentaire': 'produits alimentaires, cacao, café, fruits tropicaux, huiles végétales',
            'Technologie': 'équipements informatiques, logiciels, solutions digitales',
            'Textile': 'vêtements, tissus, coton, produits textiles',
            'Pharmaceutique': 'médicaments, produits pharmaceutiques, dispositifs médicaux',
            'Artisanat': 'objets d\'art, artisanat traditionnel, bijoux, décoration',
            'Autre': 'produits manufacturés'
        };

        const products = sectorMapping[sector] || `produits du secteur ${sector}`;
        const countries = targetCountries.slice(0, 3).join(', '); // Limiter à 3 pays pour éviter un prompt trop long

        return `Liste des principales entreprises importatrices de ${products} dans les pays suivants: ${countries}. 
        
Format de réponse souhaité:
PAYS: [Nom du pays]
- Entreprise: [Nom] | Contact: [Email/Téléphone] | Secteur: [Domaine] | Taille: [PME/Grande entreprise]
- Entreprise: [Nom] | Contact: [Email/Téléphone] | Secteur: [Domaine] | Taille: [PME/Grande entreprise]

Donne 3-5 entreprises par pays avec leurs vrais contacts si possible.`;
    }

    // Appeler l'API IA
    async callAIForImporters(prompt) {
        const response = await fetch(this.apiUrl, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${this.hfToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                inputs: prompt,
                parameters: {
                    max_length: 500,
                    temperature: 0.7,
                    do_sample: true,
                    top_p: 0.9
                },
                options: {
                    wait_for_model: true
                }
            })
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const result = await response.json();
        return this.extractAIResponse(result);
    }

    // Extraire la réponse de l'IA
    extractAIResponse(apiResult) {
        if (Array.isArray(apiResult) && apiResult[0]?.generated_text) {
            return apiResult[0].generated_text;
        }
        return apiResult?.generated_text || "Aucune réponse générée";
    }

    // Parser la réponse pour extraire les entreprises
    parseImportersResponse(response, sector, targetCountries) {
        console.log('📊 Parsing réponse IA:', response);

        const importers = {
            sector: sector,
            countries: targetCountries,
            companies: [],
            generatedAt: new Date().toLocaleDateString('fr-FR'),
            disclaimer: "Les informations ci-dessous sont générées par IA et doivent être vérifiées. ACIEX peut vous aider à valider ces contacts."
        };

        try {
            // Parsing simple de la réponse
            const lines = response.split('\n').filter(line => line.trim());
            let currentCountry = '';
            
            lines.forEach(line => {
                // Détecter les pays
                if (line.includes('PAYS:') || line.includes('pays:')) {
                    currentCountry = line.replace(/PAYS:\s*/i, '').trim();
                }
                // Détecter les entreprises
                else if (line.includes('Entreprise:') || line.includes('-')) {
                    const company = this.parseCompanyLine(line, currentCountry);
                    if (company) {
                        importers.companies.push(company);
                    }
                }
            });

            // Si pas de résultats parsés, générer des exemples
            if (importers.companies.length === 0) {
                importers.companies = this.generateExampleImporters(sector, targetCountries.slice(0, 2));
            }

        } catch (error) {
            console.error('❌ Erreur parsing:', error);
            importers.companies = this.generateExampleImporters(sector, targetCountries.slice(0, 2));
        }

        return importers;
    }

    // Parser une ligne d'entreprise
    parseCompanyLine(line, country) {
        try {
            // Format attendu: - Entreprise: [Nom] | Contact: [Email/Téléphone] | Secteur: [Domaine] | Taille: [PME/Grande entreprise]
            const cleanLine = line.replace(/^-\s*/, '').trim();
            const parts = cleanLine.split('|').map(p => p.trim());
            
            let name = '', contact = '', businessSector = '', size = '';
            
            parts.forEach(part => {
                if (part.startsWith('Entreprise:')) {
                    name = part.replace('Entreprise:', '').trim();
                } else if (part.startsWith('Contact:')) {
                    contact = part.replace('Contact:', '').trim();
                } else if (part.startsWith('Secteur:')) {
                    businessSector = part.replace('Secteur:', '').trim();
                } else if (part.startsWith('Taille:')) {
                    size = part.replace('Taille:', '').trim();
                }
            });

            if (name) {
                return {
                    name: name,
                    country: country || 'Non spécifié',
                    contact: contact || 'Contact à rechercher',
                    sector: businessSector || 'Import/Export',
                    size: size || 'Non spécifié',
                    source: 'IA Generated'
                };
            }
        } catch (error) {
            console.error('❌ Erreur parsing ligne:', error);
        }
        return null;
    }

    // Générer des exemples d'importateurs si l'IA échoue
    generateExampleImporters(sector, countries) {
        const examples = {
            'Agro-alimentaire': [
                { name: 'Global Food Importers', sector: 'Distribution alimentaire', size: 'Grande entreprise' },
                { name: 'African Food Partners', sector: 'Import agro-alimentaire', size: 'PME' },
                { name: 'Continental Trading Co', sector: 'Négoce international', size: 'Grande entreprise' }
            ],
            'Technologie': [
                { name: 'Tech Solutions Africa', sector: 'Distribution IT', size: 'PME' },
                { name: 'Digital Import Partners', sector: 'Équipements informatiques', size: 'Grande entreprise' },
                { name: 'Innovation Hub Ltd', sector: 'Solutions digitales', size: 'PME' }
            ],
            'Textile': [
                { name: 'Fashion Import Group', sector: 'Import textile', size: 'Grande entreprise' },
                { name: 'African Textiles Co', sector: 'Distribution mode', size: 'PME' },
                { name: 'Continental Fashion', sector: 'Vêtements import', size: 'Grande entreprise' }
            ]
        };

        const sectorExamples = examples[sector] || examples['Agro-alimentaire'];
        const companies = [];

        countries.forEach(country => {
            sectorExamples.forEach((example, index) => {
                companies.push({
                    name: `${example.name} ${country}`,
                    country: country,
                    contact: 'contact@rechercher-via-aciex.ci',
                    sector: example.sector,
                    size: example.size,
                    source: 'Exemple généré'
                });
            });
        });

        return companies.slice(0, 8); // Limiter à 8 entreprises
    }

    // Solution de fallback en cas d'erreur
    getFallbackImporters(sector, countries) {
        return {
            sector: sector,
            countries: countries,
            companies: this.generateExampleImporters(sector, countries.slice(0, 2)),
            generatedAt: new Date().toLocaleDateString('fr-FR'),
            disclaimer: "Service IA temporairement indisponible. Exemples d'importateurs fournis. Contactez ACIEX pour une recherche personnalisée."
        };
    }
}

// Instance globale
const importersAI = new ImportersAI();

// Fonctions de contrôle de l'assistant
function toggleAI() {
    const assistant = document.getElementById('aiAssistant');
    const fab = document.getElementById('aiFab');
    
    exportAI.isOpen = !exportAI.isOpen;
    
    if (exportAI.isOpen) {
        assistant.classList.add('open');
        fab.classList.add('hidden');
        
        // Mettre à jour le contexte avec les données actuelles
        exportAI.updateContext(currentData);
        
        // Focus sur l'input
        setTimeout(() => {
            document.getElementById('aiInput').focus();
        }, 300);
    } else {
        assistant.classList.remove('open');
        fab.classList.remove('hidden');
    }
}

function sendMessage() {
    const input = document.getElementById('aiInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessageToChat('user', message);
    input.value = '';
    
    // Simulation typing
    showTyping();
    
    setTimeout(() => {
        hideTyping();
        const response = exportAI.analyzeQuery(message);
        addMessageToChat('assistant', response);
    }, 1500 + Math.random() * 1000);
}

function askAI(question) {
    document.getElementById('aiInput').value = question;
    sendMessage();
}

function addMessageToChat(sender, message) {
    const chat = document.getElementById('aiChat');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${sender}`;
    
    if (sender === 'assistant') {
        // Conversion markdown simple
        const formattedMessage = message
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
        messageDiv.innerHTML = formattedMessage;
    } else {
        messageDiv.textContent = message;
    }
    
    chat.appendChild(messageDiv);
    chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
    const chat = document.getElementById('aiChat');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'ai-typing';
    typingDiv.innerHTML = '<div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div>';
    
    chat.appendChild(typingDiv);
    chat.scrollTop = chat.scrollHeight;
}

function hideTyping() {
    const typing = document.getElementById('typingIndicator');
    if (typing) typing.remove();
}

// Réinitialiser complètement l'assistant IA
function resetAIAssistant() {
    // Réinitialiser l'instance IA
    exportAI.conversationHistory = [];
    exportAI.context = null;
    
    // Fermer l'assistant s'il est ouvert
    if (exportAI.isOpen) {
        toggleAI();
    }
    
    // Vider le chat et remettre le message d'accueil
    const chat = document.getElementById('aiChat');
    chat.innerHTML = `
        <div class="ai-message assistant">
            <strong>👋 Bonjour !</strong><br>
            Je suis votre assistant export personnalisé. Je connais votre diagnostic et peux vous aider avec :
            <div class="ai-suggestions">
                <span class="ai-suggestion" onclick="askAI('Pourquoi mon score est-il faible ?')">Expliquer mon score</span>
                <span class="ai-suggestion" onclick="askAI('Que faire en priorité ?')">Actions prioritaires</span>
                <span class="ai-suggestion" onclick="askAI('Quel budget prévoir ?')">Budget nécessaire</span>
            </div>
        </div>
    `;
    
    // Réinitialiser l'input
    document.getElementById('aiInput').value = '';
    
    // Réactiver le bouton d'envoi
    document.getElementById('aiSendBtn').disabled = false;
    
    console.log('Assistant IA réinitialisé');
}
        // Réinitialisation du diagnostic (historique préservé)
        function resetApplication() {
            const confirmation = confirm(
                "🔄 NOUVEAU DIAGNOSTIC\n\n" +
                "Cette action va effacer :\n" +
                "• Toutes les informations entreprise actuelles\n" +
                "• Toutes les réponses aux questions\n" +
                "• Tous les résultats calculés\n" +
                "• Le diagnostic détaillé en cours\n\n" +
                "✅ VOTRE HISTORIQUE SERA PRÉSERVÉ\n\n" +
                "Voulez-vous commencer un nouveau diagnostic ?"
            );
            
            if (confirmation) {
                console.log('🔄 Démarrage nouveau diagnostic...');
                
                // Sauvegarder l'historique avant réinitialisation
                const savedHistory = localStorage.getItem('exportToolHistory');
                
                // Supprimer seulement les données du diagnostic actuel
                localStorage.removeItem('exportToolData');
                
                // Réinitialiser les variables globales
                currentData = {
                    company: {},
                    scores: {},
                    results: null
                };
                
                // Vider le formulaire entreprise
                const companyForm = document.getElementById('companyForm');
                if (companyForm) {
                    companyForm.reset();
                }
                
                // Réinitialiser les sélections de pays
                document.querySelectorAll('.multi-select-dropdown input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Réinitialiser l'affichage des pays sélectionnés
                const currentMarketsDisplay = document.getElementById('currentMarketsDisplay');
                if (currentMarketsDisplay) {
                    currentMarketsDisplay.innerHTML = '<span style="color: #999;">Sélectionnez vos marchés actuels</span>';
                }
                
                // Réinitialiser le select du marché cible
                const targetMarketSelect = document.getElementById('targetMarket');
                if (targetMarketSelect) {
                    targetMarketSelect.value = '';
                }
                
                // Remettre à zéro tous les boutons de score des questions
                document.querySelectorAll('.score-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Réinitialiser la barre de progression
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                if (progressFill) progressFill.style.width = '0%';
                if (progressText) progressText.textContent = '0/50 questions complétées';
                
                // Vider les résultats
                const resultsContainer = document.getElementById('resultsContainer');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Aucun résultat disponible.</strong><br>
                            Veuillez d'abord compléter l'évaluation dans l'onglet "Évaluation".
                        </div>
                    `;
                }
                
                // Vider le diagnostic détaillé
                const detailedContainer = document.getElementById('detailedContainer');
                if (detailedContainer) {
                    detailedContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Aucun diagnostic détaillé disponible.</strong><br>
                            Veuillez d'abord compléter l'évaluation et calculer les résultats.
                        </div>
                    `;
                }
                
                // PRÉSERVER L'HISTORIQUE - le recharger tel quel
                if (savedHistory) {
                    localStorage.setItem('exportToolHistory', savedHistory);
                    console.log('📚 Historique préservé');
                } else {
                    console.log('📚 Aucun historique à préserver');
                }
                
                // Recharger l'affichage de l'historique
                loadHistory();
                
                // Retourner à la première section (Informations Entreprise)
                showSection('company');
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active', 'loading');
                });
                
                // Activer l'onglet "Informations Entreprise"
                const companyTab = document.querySelector('[onclick="showSection(\'company\')"]');
                if (companyTab) {
                    companyTab.classList.add('active');
                }
                
                // Réinitialiser les onglets spéciaux
                const resultsTab = document.getElementById('resultsTab');
                const detailedTab = document.getElementById('detailedTab');
                if (resultsTab) {
                    resultsTab.classList.remove('loading');
                    resultsTab.innerHTML = '📊 Résultats & Analyse';
                }
                if (detailedTab) {
                    detailedTab.classList.remove('loading');
                    detailedTab.innerHTML = '🔍 Diagnostic Détaillé';
                }
                
                // Cacher le conteneur de chargement s'il est affiché
                const loadingContainer = document.getElementById('loadingContainer');
                if (loadingContainer) {
                    loadingContainer.classList.remove('active');
                }
                              
                // Focus sur le premier champ du formulaire
                setTimeout(() => {
                    const firstInput = document.getElementById('companyName');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 100);
                
                // Message de confirmation
                showAlert('✅ Nouveau diagnostic démarré !<br>📚 Votre historique a été préservé.', 'success');
                
                // Scroll vers le haut
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                console.log('🎉 Nouveau diagnostic prêt !');
            }
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Attacher l'event listener au formulaire d'authentification
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', authenticate);
                console.log('📋 Event listener authentification attaché');
            }
            
            // Vérifier si déjà authentifié
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('authContainer').style.display = 'none';
            }
            
            // Initialisation normale
            initializeMultiSelects();
            loadFromStorage();
            
            // Initialiser Google Sheets API
            setTimeout(() => {
                initGoogleAPI();
            }, 2000); // Attendre 2 secondes que tout soit chargé
            
            console.log('Outil de Diagnostic Export loaded successfully!');
        });
// Authentification
function authenticate(event) {
    event.preventDefault();
    console.log('🔑 Tentative d\'authentification...');
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('authError');
    const loadingDiv = document.getElementById('authLoading');
    
    console.log(`Username: "${username}", Password length: ${password.length}`);
    
    // Vérification des identifiants (insensible à la casse pour username)
    if (username.toLowerCase() === 'aciex' && password === 'EXPORTATIONS@2025') {
        console.log('✅ Identifiants corrects !');
        
        // Cacher le formulaire et afficher le chargement
        document.querySelector('.auth-form').style.display = 'none';
        loadingDiv.classList.add('show');
        
        // Animation de la barre de chargement
        let progress = 0;
        const progressBar = document.getElementById('authProgressBar');
        const percentageDisplay = document.getElementById('authPercentage');
        
        const interval = setInterval(() => {
            progress += 2;
            progressBar.style.width = progress + '%';
            percentageDisplay.textContent = progress + '%';
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('authContainer').style.display = 'none';
                    sessionStorage.setItem('authenticated', 'true');
                    console.log('🎉 Accès accordé !');
                }, 200);
            }
        }, 100);
        
    } else {
        console.log('❌ Identifiants incorrects');
        errorDiv.textContent = '❌ Nom d\'utilisateur ou mot de passe incorrect';
        errorDiv.style.display = 'block';
        
        // Effacer les champs
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }
}
        
// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Attacher l'event listener au formulaire d'authentification
    const authForm = document.getElementById('authForm');
    if (authForm) {
        authForm.addEventListener('submit', authenticate);
        console.log('📋 Event listener authentification attaché');
    }
    
    // Vérifier si déjà authentifié
    if (sessionStorage.getItem('authenticated') === 'true') {
        document.getElementById('authContainer').style.display = 'none';
    }
    
    // Initialisation normale
    initializeMultiSelects();
    loadFromStorage();
    
    // Initialiser Google Sheets API
    setTimeout(() => {
        initGoogleAPI();
    }, 2000); // Attendre 2 secondes que tout soit chargé
    
    console.log('Outil de Diagnostic Export loaded successfully!');
});

// Fonctions pour l'aide
function showHelpMenu() {
    document.getElementById('helpModal').style.display = 'block';
}

function closeHelpMenu() {
    document.getElementById('helpModal').style.display = 'none';
}

function openHelpSection(section) {
    // Fermer le menu principal
    closeHelpMenu();
    
    // Afficher le contenu directement
    let content = '';
    let title = '';
    
    switch(section) {
        case 'prise-en-main':
            title = '🚀 Prise en main';
            content = `
                <h2>🔐 Accès à l'outil</h2>
                <div style="background: #e3f2fd; border-left: 5px solid #1a73e8; padding: 20px; margin: 20px 0; border-radius: 8px;">
                    <strong>Identifiants requis :</strong><br>
                    • Nom d'utilisateur : <code>aciex</code><br>
                    • Mot de passe : <code>EXPORTATIONS@2025</code>
                </div>
                
                <h2>📋 Processus d'évaluation en 3 étapes</h2>
                
                <h3>Étape 1 : 🏢 Informations Entreprise</h3>
                <h4>Champs obligatoires :</h4>
                <ul>
                    <li><strong>Nom de l'entreprise</strong> : Dénomination sociale complète</li>
                    <li><strong>Secteur d'activité</strong> : 21 secteurs disponibles</li>
                    <li><strong>Dossier suivi par</strong> : Agent ACIEX référent</li>
                    <li><strong>Marchés actuels</strong> : Sélection multiple</li>
                    <li><strong>Marché cible</strong> : Un seul pays pour l'analyse</li>
                </ul>
                
                <h3>Étape 2 : 📋 Évaluation (50 Questions)</h3>
                <p><strong>10 dimensions stratégiques</strong> avec 5 questions chacune</p>
                <h4>Notation de 1 à 4 :</h4>
                <ul>
                    <li>1 = "Pas du tout"</li>
                    <li>2 = "Peu"</li>
                    <li>3 = "Moyennement"</li>
                    <li>4 = "Entièrement"</li>
                </ul>
                
                <h3>Étape 3 : 📊 Calcul des résultats</h3>
                <p>Le système calcule automatiquement :</p>
                <ul>
                    <li>Score global pondéré</li>
                    <li>Ajustement sectoriel</li>
                    <li>Niveau de préparation</li>
                    <li>Analyse détaillée</li>
                </ul>
            `;
            break;
            
        case 'lecture-resultats':
            title = '📊 Lecture des résultats';
            content = `
                <h2>📈 Onglet "Résultats & Analyse"</h2>
                
                <h3>🎯 Score global affiché</h3>
                <p><strong>Score brut</strong> : Moyenne pondérée de vos réponses aux 50 questions</p>
                <p><strong>Score ajusté</strong> : Score corrigé selon les avantages sectoriels de la Côte d'Ivoire</p>
                
                <h3>📊 Échelle d'évaluation</h3>
                <div style="background: #e8f5e8; border-left: 5px solid #34a853; padding: 15px; margin: 10px 0; border-radius: 8px;">
                    <strong>80-100% : EXCELLENT</strong><br>
                    Prêt pour export immédiat (0-3 mois)
                </div>
                <div style="background: #e3f2fd; border-left: 5px solid #1a73e8; padding: 15px; margin: 10px 0; border-radius: 8px;">
                    <strong>65-79% : BON POTENTIEL</strong><br>
                    Ajustements nécessaires (3-6 mois)
                </div>
                <div style="background: #fff3e0; border-left: 5px solid #ff9900; padding: 15px; margin: 10px 0; border-radius: 8px;">
                    <strong>45-64% : POTENTIEL MOYEN</strong><br>
                    Développement requis (6-12 mois)
                </div>
                <div style="background: #ffebee; border-left: 5px solid #ea4335; padding: 15px; margin: 10px 0; border-radius: 8px;">
                    <strong>0-44% : DÉVELOPPEMENT NÉCESSAIRE</strong><br>
                    Consolidation urgente (12-24 mois)
                </div>
                
                <h2>🔍 Onglet "Diagnostic Détaillé"</h2>
                <p>Analyse approfondie comprenant :</p>
                <ul>
                    <li><strong>Diagnostic spécifique entreprise</strong> - Niveau de préparation avec délais</li>
                    <li><strong>Plan stratégique détaillé</strong> - Feuille de route et budget</li>
                    <li><strong>Analyse du marché cible</strong> - Profil économique et stratégie</li>
                    <li><strong>Services ACIEX recommandés</strong> - Accompagnement personnalisé</li>
                </ul>
            `;
            break;
            
        case 'enregistrement':
            title = '💾 Enregistrement & Export';
            content = `
                <h2>💾 Sauvegarde automatique</h2>
                <div style="background: #e8f5e8; border-left: 5px solid #34a853; padding: 20px; margin: 20px 0; border-radius: 8px;">
                    <strong>✅ Aucune action requise !</strong><br>
                    • Vos données sont automatiquement sauvegardées dans votre navigateur<br>
                    • En cas de fermeture accidentelle, vos informations sont préservées<br>
                    • L'historique des 10 dernières évaluations est conservé
                </div>
                
                <h2>📄 Export PDF</h2>
                <p><strong>📥 Rapport Complet PDF</strong> - Analyse complète avec toutes les sections</p>
                <p><strong>📋 Résumé Exécutif PDF</strong> - Synthèse pour présentation direction</p>
                
                <h2>📊 Export Google Sheets</h2>
                <p><strong>Prérequis :</strong> Fonctionnalité disponible si configurée par l'administrateur ACIEX</p>
                <p><strong>Données exportées :</strong></p>
                <ul>
                    <li>Informations entreprise complètes</li>
                    <li>Réponses détaillées aux 50 questions</li>
                    <li>Scores par dimension</li>
                    <li>Recommandations textuelles</li>
                    <li>Métadonnées d'export</li>
                </ul>
                
                <h2>📚 Gestion de l'historique</h2>
                <p><strong>Le bouton "🔄 Nouveau diagnostic" :</strong></p>
                <ul>
                    <li>Efface toutes les données actuelles</li>
                    <li>Préserve votre historique complet</li>
                    <li>Remet l'outil à zéro pour une nouvelle évaluation</li>
                </ul>
            `;
            break;
            
        case 'faq':
            title = '❓ FAQ';
            content = `
                <h2>❓ Questions fréquentes</h2>
                
                <h3>🌟 Questions générales</h3>
                <p><strong>⏱️ Combien de temps pour compléter ?</strong><br>
                Comptez 15-20 minutes pour remplir soigneusement toutes les informations.</p>
                
                <p><strong>💾 Puis-je interrompre l'évaluation ?</strong><br>
                Oui ! Vos réponses sont automatiquement sauvegardées.</p>
                
                <p><strong>🔒 Mes données sont-elles sécurisées ?</strong><br>
                Les données sont stockées localement dans votre navigateur.</p>
                
                <h3>📊 Questions sur le scoring</h3>
                <p><strong>🧮 Comment est calculé le score global ?</strong><br>
                Moyenne pondérée des 10 dimensions avec ajustement sectoriel.</p>
                
                <p><strong>📈 Pourquoi un score ajusté ?</strong><br>
                Reflète les avantages/difficultés de votre secteur depuis la Côte d'Ivoire.</p>
                
                <p><strong>🎯 Que signifie un score de 70% ?</strong><br>
                "BON POTENTIEL" nécessitant 3-6 mois de préparation.</p>
                
                <h3>💻 Questions techniques</h3>
                <p><strong>📊 Export Google Sheets ne fonctionne pas ?</strong><br>
                Vérifiez les bloqueurs de popup. Utilisez l'export PDF en alternative.</p>
                
                <p><strong>✏️ Puis-je modifier mes réponses ?</strong><br>
                Oui, retournez dans "Évaluation" et recalculez les résultats.</p>
                
                <p><strong>🔄 Comment réinitialiser ?</strong><br>
                Bouton "🔄 Nouveau diagnostic" (préserve l'historique).</p>
                
                <h3>📞 Support</h3>
                <div style="background: #e8f5e8; border-left: 5px solid #34a853; padding: 20px; margin: 20px 0; border-radius: 8px;">
                    <strong>📞 Support technique :</strong> Contactez votre agent ACIEX pour toute assistance<br>
                    <strong>🔄 Mise à jour :</strong> Cette aide correspond à la version 3.1 de l'outil
                </div>
            `;
            break;
    }
    
    // Créer une nouvelle fenêtre avec le contenu
    const helpWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
    helpWindow.document.write(`
        <!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${title} - Aide ACIEX</title>
            <style>
                body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
                h2 { color: #1a73e8; border-left: 5px solid #1a73e8; padding-left: 15px; }
                h3 { color: #2e7d32; }
                code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; color: #d63384; }
            </style>
        </head>
        <body>
            <div style="background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; padding: 20px; margin: -20px -20px 20px -20px; text-align: center;">
                <h1>${title}</h1>
                <p>Guide d'utilisation - Outil Diagnostic Export ACIEX v3.1</p>
            </div>
            ${content}
        </body>
        </html>
    `);
    helpWindow.document.close();
}

// Fermer le modal en cliquant à l'extérieur
window.onclick = function(event) {
    const modal = document.getElementById('helpModal');
    if (event.target === modal) {
        closeHelpMenu();
    }
}

// Navigation secondaire pour les sections longues
        function createSecondaryNav(navItems) {
            let navHtml = '<div class="secondary-nav">';
            navItems.forEach((item, index) => {
                const activeClass = index === 0 ? 'active' : '';
                navHtml += `<button class="secondary-nav-btn ${activeClass}" onclick="scrollToSection('${item.id}')">${item.label}</button>`;
            });
            navHtml += '</div>';
            return navHtml;
        }

        function scrollToSection(sectionId) {
            document.querySelectorAll('.secondary-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        const resultsNavItems = [
            { id: 'scores-globaux', label: '🎯 Scores Globaux' },
            { id: 'par-dimension', label: '📊 Par Dimension' },
            { id: 'actions-prioritaires', label: '⚡ Actions Prioritaires' },
            { id: 'plan-strategique', label: '📋 Plan Stratégique' },
            { id: 'export-resultats', label: '📄 Export' }
        ];

        const detailedNavItems = [
            { id: 'profil-entreprise', label: '🏢 Profil Entreprise' },
            { id: 'defaillances-critiques', label: '🚨 Défaillances' },
            { id: 'plan-action', label: '📋 Plan d\'Action' },
            { id: 'marche-cible', label: '🌍 Marché Cible' },
            { id: 'services-aciex', label: '🎯 Services ACIEX' }
        ];

    </script>
    </script>
</body>
</html>